<?php

/**
 * @file
 * IntelligenceBank DAM media integration module.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter().
 *
 * This hook used to pass some field settings into widget_context,
 * to allow particular eb widgets use this information on their own.
 *
 * This is useful if you want that eb widget to validate allowed target bundles,
 * to prevent backend error from media entity reference field validation.
 * In that case you need to know target entity type and bundles.
 */
function ib_dam_media_field_widget_entity_browser_entity_reference_form_alter(&$element, FormStateInterface &$form_state, $context) {
  /* @var $items \Drupal\Core\Field\FieldItemListInterface */
  $items = $context['items'];

  /* @var \Drupal\field\Entity\FieldConfig */
  $field    = $items->getFieldDefinition();
  $settings = $field->getSettings();

  $element['entity_browser']['#widget_context']['ib_dam_media'] = [
    'field' => [
      'name' => $field->getName(),
      'entity_type_id' => $field->getTargetEntityTypeId(),
      'entity_bundle_id' => $field->getTargetBundle(),
    ],
    'allowed_media_types' => $settings['handler_settings']['target_bundles'],
  ];

}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Mark entity browser form as embedded inside an Entity Embed dialog.
 */
function ib_dam_media_form_entity_embed_dialog_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form['#process'][] = function (array &$element, FormStateInterface $form_state, array &$complete_form) {
    $element['entity_browser']['#widget_context']['ib_dam_media']['is_entity_embed'] = TRUE;
    return $element;
  };
}
