<?php

/**
 * @file
 * Simple Header Image module.
 */
 /* add a new template file for the block */
function shi_theme($existing, $type, $theme, $path) {
  return array(
    'block__simple_header_image' => array(
      'render element' => 'elements',
      'template' => 'block--simple-header-image',
      'base hook' => 'block'
    )
  );
}

function shi_preprocess_block(&$variables){
  $variables['home_link'] = base_path();
  if ($variables['elements']['#configuration']['id'] === 'simple-header-image'){
    $variables['#attached']['library'][] = 'shi/simple-header-image'; // add a new library that contain our css
    $current_url = $_SERVER["REQUEST_URI"]; // get the current url
    $nids = \Drupal::entityQuery('node')->condition('type', 'inside_banner')->execute(); // get all inside_banner nodes
    foreach($nids as $nid){ //loop on the node contents
      $node = \Drupal\node\Entity\Node::load($nid); //load the node
      if( base_path().$node->field_banner_link->value == $current_url){ //check if the node link field equal the current page link
        $l = explode('public://',$node->field_image->entity->getFileUri()); //explode public from the link
        $variables['shi_uri'] = base_path().'sites/default/files/'.$l[1]; // define a new variable to the page.html.twig template
      }
    }
    $block = \Drupal\block\Entity\Block::load('simpleheaderimage')->get('settings')['simple_header_image']; // geth the block  title setting
    if($block){
      $request = \Drupal::request();
      $route_match = \Drupal::routeMatch();
      $title = \Drupal::service('title_resolver')->getTitle($request, $route_match->getRouteObject()); // get the page title
      $variables['pagetitle'] = $title;
    }
  }
 }

 function shi_uninstall() {

   // Delete custom_type nodes when uninstalling
   $query = \Drupal::entityQuery('node')->condition('type', 'inside_banner');
   $nids = $query->execute();
   foreach ($nids as $nid) {
     \Drupal\node\Entity\Node::load($nid)->delete();
   }
 }

 function shi_preprocess_page(&$variables){
  //  $block = \Drupal\block\Entity\Block::load('simpleheaderimage_2')->get('settings')['simple_header_image']; // geth the block  title setting
  //  var_dump($block);
  //  $request = \Drupal::request();
  //  $route_match = \Drupal::routeMatch();
  //  $title = \Drupal::service('title_resolver')->getTitle($request, $route_match->getRouteObject());
  //
  // echo $title;
  // die();
  //  die();
 }
