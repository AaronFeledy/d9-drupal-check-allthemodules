<?php

//use Drupal\user\Entity;
/*
function insert_js_node_view(array &$build, \Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display, $view_mode) {
   $build['body'][0]['#text'] = 'this is a new altered content body ';
}
*/

function insert_js_node_view(array &$build, \Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display, $view_mode) {
//kint($build);
//$user = User::load(1);
//kint($user->hasRole('anonymous'));

$current_user = \Drupal::currentUser();
$roles = $current_user->getRoles();
$user_admin = false;

foreach ( $roles as $role){
if ($role == 'administrator'){$user_admin = true;}
}



if($build['body'][0]['#format'] == 'full_html' && ! $user_admin){
$old_article = $build['body'][0]['#text'];

$count_paragraph = substr_count($old_article, '</p>');
$midle_paragraph = intdiv($count_paragraph, 2);

$k = 0;
$n = 0;

while( $k <= $midle_paragraph){
$n = strpos($old_article, '</p>', $n);
$n = $n + 4;
$k = $k + 1;
}

$tail = substr($old_article, $n + 1);
$head = substr($old_article, 0 , $n);

$new_article = $head .
               '<p>' .
               \Drupal::config('insert_js.settings')->get('insert_js.js_code') .
              '</p>' .
               $tail ;


$build['body'][0]['#text'] = $new_article;
/*
kint($count_paragraph);
kint($midle_paragraph);
kint($n);
kint($k);
kint($head);
kint($tail);
*/
 }
}


