<?php

/**
 * @file
 * Coupon for role module.
 */

use Drupal\coupon_for_role\CouponForRoleCouponManager;

/**
 * Create a coupon for a role.
 *
 * @param string $role
 *   The role for the coupon.
 */
function coupon_for_role_generate_coupon($role, $expiry = '+6 months') {
  /** @var \Drupal\coupon_for_role\CouponForRoleCouponManager $mng */
  $mng = \Drupal::service('coupon_for.role.coupon_manager');
  return $mng->generateCoupon($role, strtotime($expiry));
}

/**
 * Implements hook_cron().
 *
 * Revoke roles when coupon has expired.
 */
function coupon_for_role_cron() {
  /** @var \Drupal\coupon_for_role\CouponForRoleCouponManager $mng */
  $mng = \Drupal::service('coupon_for.role.coupon_manager');
  $coupons = \Drupal::database()
    ->select(CouponForRoleCouponManager::TABLE_NAME, 'cr')
    ->fields('cr')
    ->condition('cr.expires', \Drupal::time()->getRequestTime(), '<')
    ->condition('cr.status', 2, '<>')
    ->execute();
  foreach ($coupons as $coupon) {
    $mng->handleExpiredCoupon($coupon);
  }
}
