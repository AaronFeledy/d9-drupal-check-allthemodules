<?php

/**
 * @file
 * Adds Matomo (Piwik) noscript tracking code to all your site's pages.
 */

use Drupal\Component\Render\FormattableMarkup;
use Drupal\Core\Url;

/**
 * Returns configuration object if module is configured or NULL otherwise.
 *
 * @return \Drupal\Core\Config\ImmutableConfig|null
 *   An immutable configuration object or NULL.
 */
function piwik_noscript_configured() {
  $config = \Drupal::config('matomo.settings');
  if ($config->get('site_id') && $config->get('url_https')) {
    return $config;
  }
  $config = \Drupal::config('piwik.settings');
  if ($config->get('site_id') && $config->get('url_https')) {
    return $config;
  }
}

/**
 * Builds Matomo image element.
 */
function piwik_noscript_image(array $options) {
  return [
    '#theme' => 'image',
    '#uri' => piwik_noscript_url($options),
    '#width' => 0,
    '#height' => 0,
    '#attributes' => [
      'style' => 'position: absolute',
    ],
  ];
}

/**
 * Builds Matomo URL options.
 */
function piwik_noscript_options() {
  $config = piwik_noscript_configured();
  $request = \Drupal::request();
  $title = '';
  if ($route = \Drupal::routeMatch()->getRouteObject()) {
    $title = \Drupal::service('title_resolver')->getTitle($request, $route);
  }
  $options['query']['action_name'] = is_array($title) ? \Drupal::service('renderer')->renderPlain($title) : (string) $title;
  $options['query']['idsite'] = $config->get('site_id');
  $options['query']['rec'] = '1';
  $options['query']['url'] = $request->getUri();
  \Drupal::moduleHandler()->alter('piwik_noscript_options', $options);
  return $options;
}

/**
 * Adds Matomo noscript tag to bottom of the page.
 */
function piwik_noscript_page_bottom(array &$page_bottom) {
  // Return early if not configured.
  if (!piwik_noscript_configured()) {
    return;
  }

  $options = piwik_noscript_options();
  $page_bottom['piwik_noscript'] = piwik_noscript_image($options);
  $page_bottom['piwik_noscript']['#prefix'] = new FormattableMarkup('<noscript>', []);
  $page_bottom['piwik_noscript']['#suffix'] = new FormattableMarkup('</noscript>', []);

  // Ensure cache varies on the full URL.
  $page_bottom['piwik_noscript']['#cache']['contexts'][] = 'url';

  // Do not add JavaScript if Matomo or Piwik modules are enabled.
  if (\Drupal::moduleHandler()->moduleExists('matomo') || \Drupal::moduleHandler()->moduleExists('piwik')) {
    return;
  }

  // Use JavaScript to send referrer URL to Matomo.
  $options['query']['send_image'] = '0';
  $options['query']['urlref'] = '';
  $page_bottom['piwik_noscript']['#attached']['drupalSettings']['piwikNoscript']['url'] = piwik_noscript_url($options);
  $page_bottom['piwik_noscript']['#attached']['library'][] = 'piwik_noscript/piwik_noscript';
}

/**
 * Builds Matomo URL.
 */
function piwik_noscript_url(array $options) {
  $config = piwik_noscript_configured();
  $url = Url::fromUri($config->get('url_https') . 'js/');
  $url->setOptions($options);
  return $url->toString();
}
