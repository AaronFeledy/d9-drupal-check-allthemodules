<?php

/**
 * @file
 * File contains the required Drupal hooks.
 */

use Drupal\views\ViewExecutable;
use Drupal\views\Plugin\views\query\QueryPluginBase;

/**
 * Implements hook_views_query_alter().
 */
function zchat_views_query_alter(ViewExecutable $view, QueryPluginBase $query) {
  if ($view->id() == 'zchat_messages' && $view->getDisplay()->display['id'] == 'rest_export_1') {
    // Get the contextual filter arguments.
    // 0 => created after time.
    // 1 => created before time.
    $args = $view->args;
    $created_after = isset($args[0]) ? $args[0] : 0;
    $created_before = isset($args[1]) ? $args[1] : 0;

    // Get the 'where' conditions.
    $where = &$query->where;

    if (!empty($created_after)) {
      $where[1]['conditions'][] = [
        'field' => 'zchatmessage.created_ms',
        'value' => $created_after,
        'operator' => '>',
      ];
    }
    elseif (!empty($created_before)) {
      $where[1]['conditions'][] = [
        'field' => 'zchatmessage.created_ms',
        'value' => $created_before,
        'operator' => '<',
      ];
    }
  }
}
