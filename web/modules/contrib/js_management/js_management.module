<?php

use Drupal\Core\Asset\AttachedAssetsInterface;

/**
 * Implements hook_js_alter().
 */
function js_management_js_alter(&$javascript, AttachedAssetsInterface $assets) {
  $connection = \Drupal::database();
  foreach ($javascript as $name => $script) {
    $query = $connection->select('js_management_managed_js', 'mj')
    ->condition('mj.name', $name, '=')
    ->fields('mj', ['name', 'load']);
    $result = $query->execute()->fetchAll();
    if ($result) {
      if (!$result[0]->load) {
        unset($javascript[$result[0]->name]);
      }
    }
    else {
      $values = [
        'name' => $name,
        'type' => $script['type'],
        'data' => $script['data'],
        'version' => $script['version'],
        'minified' => $script['minified'],
      ];
      $entity = \Drupal::entityTypeManager()
        ->getStorage('js_management_managed_js')
        ->create($values);
      $entity->save();
    }
  }
}
