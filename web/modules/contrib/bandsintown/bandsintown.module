<?php

/**
 * @file
 * Bandsintown service API integration.
 */

use Drupal\Core\Template\Attribute;

define('BANDSINTOWN_FACEBOOKAPP_CAME_FROM', 34);

/**
 * Implements hook_theme().
 */
function bandsintown_theme() {
  return array(
    'bandsintown' => array(
      'variables' => array(
        'version'               => NULL,
        'show_button'           => NULL,
        'artist'                => NULL,
        'data_attributes'       => NULL,
        'button_attributes'     => NULL,
        'size'                  => NULL,
        'display_tracker_count' => NULL,
        'text_color'            => NULL,
        'background_color'      => NULL,
        'hover_color'           => NULL,
        'settings'              => NULL,
      ),
      'template'  => 'bandsintown',
    ),
  );
}

/**
 * Implements hook_preprocess().
 */
function bandsintown_preprocess_bandsintown(&$variables, $hook) {
  $service = \Drupal::service('bandsintown.helper');

  // Retrieve "show_track_button" and "widget_version" module settings.
  $module_config = \Drupal::config('bandsintown.settings');
  $variables['show_button'] = $module_config->get('show_track_button');
  $variables['version'] = $module_config->get('widget_version');

  // Retrieve block settings.
  $config = $variables['settings'];

  // Replace underscores with dashes of each key in our settings array
  // and encode track button Hex color codes.
  $conf = array();
  foreach ($config as $setting => $value) {
    if ($service->isBandsintown($setting, 'button')) {
      $value = str_replace('#', '%23', $value);
    }
    $conf[str_replace('_', '-', $setting)] = $value;
  }

  // URL-encode "data-share-url" attribute.
  $conf['data-share-url'] = urlencode($conf['data-share-url']);

  // Translate the boolean into a string for the boolean attributes.
  $vars = array(
    'data-force-narrow-layout',
    'data-bandsintown-footer-link',
    'data-notify-me',
    'data-share-links',
    'button-display-tracker-count',
    'button-allowtransparency',
    'data-display-local-dates',
    'data-display-past-dates',
    'data-auto-style',
  );
  foreach ($vars as $var) {
    $conf[$var] = $conf[$var] ? 'true' : 'false';
  }

  // Set "artist" variable.
  $variables['artist'] = $conf['data-artist'];

  // Set "data_attributes" variable which adds the following attributes:
  // Widget v1:
  // - "data-force-narrow-layout"
  // - "data-bg-color"
  // - "data-width"
  // - "data-bandsintown-footer-link"
  // - "data-notify-me"
  // - "data-share-links"
  // - "data-share-url"
  // Widget v2:
  // - "data-link-text-color"
  // - "data-background-color"
  // - "data-popup-background-color"
  // - "data-font"
  // - "data-widget-width"
  // - "data-display-local-dates"
  // - "data-display-past-dates"
  // - "data-auto-style"
  // Both versions:
  // - "data-display-limit"
  // - "data-text-color"
  // - "data-link-color"
  // - "data-separator-color"
  // - "data-div-id"
  // - "data-facebook-page-id".
  $data_attributes = array();
  foreach ($conf as $attribute => $value) {
    if ($service->isBandsintown($attribute, 'data') && $attribute != 'data-artist') {
      $data_attributes[$attribute] = $value;
    }
  }
  if (!empty($module_config->get('widget_language'))) {
    $data_attributes['data-language'] = $module_config->get('widget_language');
  }
  if (!empty($module_config->get('widget_affil_code'))) {
    $data_attributes['data-affil-code'] = $module_config->get('widget_affil_code');
  }
  if (!empty($module_config->get('widget_app_id'))) {
    $data_attributes['data-app-id'] = $module_config->get('widget_app_id');
  }
  if ($module_config->get('widget_version')) {
    unset($data_attributes['data-force-narrow-layout']);
    unset($data_attributes['data-bg-color']);
    unset($data_attributes['data-width']);
    unset($data_attributes['data-bandsintown-footer-link']);
    unset($data_attributes['data-notify-me']);
    unset($data_attributes['data-share-links']);
    unset($data_attributes['data-share-url']);
  }
  else {
    unset($data_attributes['data-link-text-color']);
    unset($data_attributes['data-background-color']);
    unset($data_attributes['data-popup-background-color']);
    unset($data_attributes['data-font']);
    unset($data_attributes['data-widget-width']);
    unset($data_attributes['data-display-local-dates']);
    unset($data_attributes['data-display-past-dates']);
    unset($data_attributes['data-auto-style']);
  }
  $variables['data_attributes'] = new Attribute($data_attributes);

  // Set variables to add the following attributes:
  // - "size"
  // - "display-tracker-count"
  // - "text-color"
  // - "background-color"
  // - "hover-color".
  $other_button_attributes = array(
    'button_size',
    'button_display_tracker_count',
    'button_text_color',
    'button_background_color',
    'button_hover_color',
  );
  foreach ($other_button_attributes as $attribute => $value) {
    $variables[str_replace('button_', '', $value)] = $conf[str_replace('_', '-', $value)];
  }

  // Set "button_attributes" variable which adds the following attributes:
  // - "height"
  // - "width"
  // - "scrolling"
  // - "frameborder"
  // - "style"
  // - "allowtransparency".
  $button_attributes = array();
  foreach ($conf as $attribute => $value) {
    if ($service->isBandsintown($attribute, 'button') && !in_array(str_replace('-', '_', $attribute), $other_button_attributes)) {
      $button_attributes[str_replace('button-', '', $attribute)] = $value;
    }
  }
  $variables['button_attributes'] = new Attribute($button_attributes);
}
