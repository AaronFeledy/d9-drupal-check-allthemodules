<?php

/**
 * @file
 * Use Drupal\Core\Form\FormStateInterface;.
 */
use  Drupal\server_disk_space_notification\Form;
/**
 * Implements hook_mail().
 */
function server_disk_space_notification_mail($key, &$message, $params) {
  $options = [
    'langcode' => $message['langcode'],
  ];
  switch ($key) {
    case 'send_notify':
      //$message['from'] = \Drupal::config('system.site')->get('mail');
      $message['from'] = 'a@a.com';
      $message['subject'] = $params['subject'];
      $message['body'][] = $params['message'];
      break;
  }

}

/**
 * Implements hook_cron().
 */
function server_disk_space_notification_cron() {

   $email_notification_var = \Drupal::config('server_disk_space_notification.settings')->get('server_space_cron');
   $server_space_email_to = \Drupal::config('server_disk_space_notification.settings')->get('server_space_email_to');
   $server_space_email_from_name = \Drupal::config('server_disk_space_notification.settings')->get('server_space_email_from_name');
   $server_space_email_from_address = \Drupal::config('server_disk_space_notification.settings')->get('server_space_email_from_address');

 if ($email_notification_var == 1) {
     _server_disk_space_notification_email_details($server_space_email_to, $server_space_email_from_name, $server_space_email_from_address);
    }
}


/**
 * @param $server_space_email_to
 * @return none
 */
function _server_disk_space_notification_email_details($server_space_email_to = '', $server_space_email_from_name = '', $server_space_email_from_address = '') {

  $server_space_email_to = explode("\n", $server_space_email_to);

  foreach ($server_space_email_to as $key => $value) {
    if (!empty($value)) {
      $temp[] = trim($value);
    }

  }

  $server_space_email_to = implode(',', $temp);

  $server_space_email_to = trim($server_space_email_to);
  $message = "<h6>Server Disk Space</h6>";
  $message .= "<pre>" . shell_exec('df -h') . "</pre>"; /* Body of your email here */
  $message .= "<br><br><h6>Server RAM</h6>";
  $message .= "<pre>" . shell_exec('free -m') . "</pre>"; /* Body of your email here */
  $todays_date = date("d-m-Y"); /* Today's date */
  $subject = 'Server Space Information for ' . $todays_date; /* Subject of your email */
  $params = [
    'message' => $message,
    'subject' => $subject,
  ];

  if ($server_space_email_from_name != '') {
    $from_name = $server_space_email_from_name;
  }
  else {
    $from_name = \Drupal::config('system.site')->get('name');
  }

  $from = '"' . $from_name . '" <' . $server_space_email_from_address . '>';

  $mailManager = \Drupal::service('plugin.manager.mail');
  $module = 'server_disk_space_notification';
  $key = 'send_notify';

  $langcode = \Drupal::currentUser()->getPreferredLangcode();
  $send = TRUE;
  $result = $mailManager->mail($module, $key, $server_space_email_to, $langcode, $params, NULL, $send);
  if ($result['result'] !== TRUE) {
    drupal_set_message(t('There was a problem sending your message and it was not sent.'), 'error');
  }
  else {
    drupal_set_message(t('Your message has been sent.'));
  }

}
