<?php

/**
 * @file
 * Contains layout_builder_modal.module.
 */

use Drupal\Component\Serialization\Json;

/**
 * Implements hook_contextual_links_alter().
 */
function layout_builder_modal_contextual_links_alter(array &$links, $group, array $route_parameters) {
  if (isset($links['layout_builder_block_update'])) {
    $config = \Drupal::config('layout_builder_modal.settings');

    $links['layout_builder_block_update']['localized_options']['attributes']['data-dialog-type'] = 'dialog';
    $links['layout_builder_block_update']['localized_options']['attributes']['data-dialog-options'] = Json::encode([
      'width' => $config->get('modal_width'),
      'height' => $config->get('modal_height'),
      'target' => 'layout-builder-modal',
      'autoResize' => FALSE,
      'modal' => TRUE,
    ]);
    unset($links['layout_builder_block_update']['localized_options']['attributes']['data-dialog-renderer']);
  }
}

/**
 * Implements hook_element_info_alter().
 */
function layout_builder_modal_element_info_alter(array &$types) {
  if (isset($types['layout_builder'])) {
    $types['layout_builder']['#attached']['library'][] = 'layout_builder_modal/layout_builder_modal';
  }
}

/**
 * Implements hook_link_alter().
 */
function layout_builder_modal_link_alter(&$variables) {
  /** @var Drupal\Core\Url $url */
  $url = $variables['url'];

  if (!$url->isRouted()) {
    return;
  }

  if ($url->getRouteName() !== 'layout_builder.add_block') {
    return;
  }

  if (!in_array('use-ajax', $variables['options']['attributes']['class'], TRUE)) {
    return;
  }

  $config = \Drupal::config('layout_builder_modal.settings');

  $data_dialog_options = Json::encode([
    'width' => $config->get('modal_width'),
    'height' => $config->get('modal_height'),
    'target' => 'layout-builder-modal',
    'autoResize' => FALSE,
    'modal' => TRUE,
  ]);

  $variables['options']['attributes']['data-dialog-options'] = $data_dialog_options;
  $variables['options']['attributes']['data-dialog-type'] = 'dialog';
  unset($variables['options']['attributes']['data-dialog-renderer']);
}
