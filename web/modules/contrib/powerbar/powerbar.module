<?php

/**
 * @file
 * Extends the commandbar to additional utilities.
 */


///// PERMISSIONS AND ACCESS /////

/**
 * Implements hook_permission().
 */
function powerbar_permission() {
  return array(
    'access powerbar' => array(
      'title' => t('Access powerbar utilities'),
    ),
  );
}

/**
 * Implements hook_commandbar_build_alter().
 */
function powerbar_commandbar_build_alter(&$matches, &$continue, $string) {
  if (!$continue) {
    return;
  }
  
  // Search users
  if (substr($string, 0, 1) == '@') {
    $string = str_replace('@', '', $string);
    $or = db_or();
    $strlen = 1;
    if (is_numeric($string)) {
      $strlen = 0;
      $or->condition('uid', $string, '=');
    }
    if (strlen($string) > $strlen) {
      $or->condition('name', '%' . db_like($string) . '%', 'LIKE');
      $or->condition('mail', '%' . db_like($string) . '%', 'LIKE');
      $result = Drupal::database()->select('users')->fields('users', array('name', 'uid', 'mail'))->condition($or)->range(0, 25)->execute();
      foreach ($result as $account) {
        $path = 'user/' . $account->uid;
        $matches[$path] = theme('powerbar_user_item', array('url' => url($path), 'path' => $path, 'uid' => $account->uid, 'name' => $account->name, 'mail' => $account->mail));
      }
    }
    $continue = FALSE;
  }
  
  
  if (substr($string, 0, 1) == '>') {
    
    // Add commands.
    $commands['cc'] = array(
      'command' => 'cc',
      'description' => t('Clear the caches'),
    );
    $commands['encourage'] = array(
      'command' => 'encourage',
      'description' => t('Receive encouragement'),
    );
    
    // Allow other modules to add commands.
    drupal_alter('powerbar_commands', $commands);
    
    // Apply search to command list.
    $string = substr($string, 1);
    $string_parts = explode(' ', $string);
    foreach ($commands as $command) {
      $searchable = $command['command'] . ' ' . $command['description'];
      $match = TRUE;
      foreach ($string_parts as $part) {
        if (!stristr($searchable, $part)) {
          $match = FALSE;
        }
      }
      if ($match) {
        $matches['>' . $command['command']] = theme('powerbar_command_item', array('command' => $command['command'], 'description' => $command['description']));
      }
    }
  }
}

/**
 * Implements hook_commandbar_submit_alter().
 */
function powerbar_commandbar_submit_alter($string, &$continue) {
  switch ($string) {
    
    // Clear caches
    case '>cc':
      drupal_flush_all_caches();
      drupal_set_message(t('Caches cleared.'));
      $continue = FALSE;
      break;
    
    // Message of love
    case '>encourage':
      drupal_set_message(t('You are awesome. Keep up the good work!'));
      $continue = FALSE;
      break;
  }
}

/**
 * Implements hook_theme().
 */
function powerbar_theme() {
  return array(
    'powerbar_user_item' => array(
      'variables' => array('uid' => '', 'username' => '', 'email' => '', 'path' => ''),
      'template' => 'powerbar-user-item',
    ),
    'powerbar_command_item' => array(
      'variables' => array('command' => '', 'description' => ''),
      'template' => 'powerbar-command-item',
    ),
  );
}