<?php

/**
 * @file
 * Contains coral_talk.module.
 */

use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;

/**
 * Implements hook_theme().
 */
function coral_talk_theme($existing, $type, $theme, $path) {
  return [
    'coral_talk_comments' => [
      'variables' => [
        'domain' => '',
      ],
      'path' => "{$path}/templates",
      'template' => 'coral-talk-comments',
    ],
  ];
}

/**
 * Implements hook_entity_extra_field_info().
 */
function coral_talk_entity_extra_field_info() {
  $config = \Drupal::config('coral_talk.settings');
  $extra = [];

  foreach ($config->get('content_types') as $bundle) {
    if ($bundle) {
      $extra['node'][$bundle]['display']['coral_talk_comments'] = [
        'label' => t('Coral Talk Comments'),
        'description' => t('Place Coral Talk on the page.'),
        'weight' => 100,
        'visible' => TRUE,
      ];
    }
  }

  return $extra;
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function coral_talk_node_view(
  array &$build,
  EntityInterface $entity,
  EntityViewDisplayInterface $display,
  $view_mode
) {
  if (
    $display->getComponent('coral_talk_comments') &&
    \Drupal::currentUser()->hasPermission('create coral comment')
  ) {
    $config = \Drupal::config('coral_talk.settings');
    $build['coral_talk_comments'] = [
      '#theme' => 'coral_talk_comments',
      '#domain' => $config->get('domain') ?? '',
    ];
  }
}
