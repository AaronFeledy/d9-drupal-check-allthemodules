<?php

/**
 * @file
 * Integrates Everyday Online Payment with Ubercart.
 */

/**
 * Implements hook_ucga_display().
 */
function uc_everyday_ucga_display() {
  // Tell UC Google Analytics to display the e-commerce JS on the custom
  // order completion page for this module.
  if (arg(0) == 'cart' && arg(1) == 'everyday' && arg(2) == 'finalize') {
    return TRUE;
  }
}

/**
 * Return url for posting data.
 */
function _uc_everyday_post_url() {
  $url = 'https://everyday.opr-vakuus.fi/maksu.php';

  return $url;
}

/**
 * Returns reference to given reference number as used by Finnish banks.
 *
 * @param int $reference
 *   Reference number based on order id.
 *
 * @return string
 *   Reference (with check number) as used by Finnish banks.
 */
function _uc_everyday_reference($reference) {
  $everyday_config = \Drupal::configFactory()->getEditable('uc_everyday.settings');

  $tmp_multip = array(7, 3, 1);

  // Calculated sum for given reference.
  $reference_prefix = $everyday_config->get('uc_everyday_reference_prefix');
  $tmp_str = (string) $reference_prefix . $reference;
  $tmp_sum = 0;
  $tmp_index = 0;
  for ($i = strlen($tmp_str) - 1; $i >= 0; $i--) {
    $tmp_sum += intval(substr($tmp_str, $i, 1)) * intval($tmp_multip[$tmp_index % 3]);
    $tmp_index++;
  }

  // Nearest decimal number for calculated sum.
  $next_ten = ceil(intval($tmp_sum) / 10) * 10;

  // Return reference.
  return $tmp_str . (string) (abs($next_ten - $tmp_sum));
}
