<?php

/**
 * @file
 * Processes input using the writeup markup language.
 *
 * @todo better help tips (maybe two versions or custom tips)
 * @todo better documentation on how to install
 */

module_load_include('inc', 'writeup');

function writeup_status_page() {
  return '<h2>This page is not yet implemented for Drupal 8</h2>';
  $sql = "SELECT n.nid, t.name AS format, f.format AS format_id, n.title, b.body_value AS body FROM {node} n
    JOIN {field_data_body} b on b.entity_id = n.nid
    JOIN {filter} f on f.format = b.body_format
    JOIN {filter_format} t on t.format = b.body_format
    WHERE b.entity_type = 'node'
      AND f.status = 1
      AND f.module='writeup'
    ORDER BY t.name, n.title";
 return writeup_status($sql);
}

/**
 * Returns a status page from a user-supplied SQL string.
 * Designed to be used for displaying the status of pages where fields other than the body
 * use the Writeup input filter.
 *
 * @param $sql
 *   SQL string that returns five fields: node id, format (name), format id, title and body
 *
 * @return $page
 *   resulting status page
 */
function writeup_status($sql) {
  // build an array of filter objects so we can get settings info later
  $filter_setting = db_query("SELECT format, settings from {filter} WHERE module = 'writeup'");
  $fsetting = array();
  foreach ($filter_setting as $filter) {
    $fsetting[$filter->format] = unserialize($filter->settings);
  }
  $result = db_query($sql);
  $page = '<table><tr><th>Format</th><th>Status</th><th>Title</th></tr>';
  $tmpfile = file_directory_temp() . '/writeupif.txt';
  foreach ($result as $item) {
    file_unmanaged_save_data($item->body, $tmpfile, FILE_EXISTS_REPLACE);
    $format_incname = $fsetting[$item->format_id]['writeup_incname'];
    $format_settings = $fsetting[$item->format_id]['writeup_settings'];
    $errors = '';
    switch (_writeup_get_errors($tmpfile, $item->format, $format_incname, $format_settings, $errors)) {
      case 0:
        $err = "good";
        break;
      case 1:
        $err = "warning";
        break;
      default:
        $err = "error";
        break;
    }
    if ($err != "good") { // need to replace ' with " so that the title tag is never broken
      $err = "<abbr style='color:red; font-weight:bold;' title='" . str_replace("'", '"', $errors) . "'>" . $err . "</abbr>";
    }
    $page .= '<tr><td>' . $item->format . '</td><td>' . $err . '</td><td><a href="/node/' . $item->nid . '">' . $item->title . '</a></td></tr>';

  }
  $page .= '</table>';
  return $page;
}
