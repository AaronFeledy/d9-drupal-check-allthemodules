<?php

/**
 * @file
 * Contains rpb.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

define('REST_EXPORT', 'rest_export');

/**
 * Implements hook_help().
 */
function rpb_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the rpb module.
    case 'help.page.rpb':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Beautifies REST export preview in Views.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function rpb_form_view_preview_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  // Get the current view.
  $storage = $form_state->getStorage();
  $dispaly_id = $storage['display_id'];
  $view = $storage['view'];
  $view_executable = $view->getExecutable();

  $display_infos = $view->getDisplay($view_executable->current_display);
  // Use JSON as default.
  if ($display_infos['display_plugin'] == REST_EXPORT) {
    $format = 'json';
  }

  if (isset($display_infos['display_options']['style']['options']['formats']) && $formats = $display_infos['display_options']['style']['options']['formats']) {
    // XML support.
    if (count($formats) == 1 && array_shift($formats) == 'xml') {
      $format = 'xml';
    }
  }

  if ($format) {
    $form['#attached']['library'][] = 'rpb/rpb.preview';
    $form['#attached']['drupalSettings']['rpb']['format'] = $format;
  }
}
