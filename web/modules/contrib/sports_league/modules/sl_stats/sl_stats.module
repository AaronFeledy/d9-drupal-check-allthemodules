<?php

/**
 * Implements hook_entity_update().
 * @param \EntityInterface $entity
 */
function sl_stats_entity_update($entity) {
  if ($entity->getEntityTypeId() == 'node' && $entity->bundle() == 'sl_person') {

    if (!isset($entity->sl_stats_already_computed)) {
      $queue_factory = \Drupal::service('queue');
      $queue = $queue_factory->get('sl_stats_worker');

      $item = new \stdClass();
      $item->nid = $entity->id();
      $queue_items = \Drupal::service('database')->select('queue')
        ->fields('queue', array(
          'item_id'
        ))
        ->condition('name', 'sl_stats_worker')
        ->condition('data', serialize($item))->execute()->fetchAll();

      if (!count($queue_items)) {
        $queue->createItem($item);
      }
    }
  }
}