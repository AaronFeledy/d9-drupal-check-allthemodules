<?php

/*
 * Implements hook_entity_type_alter().
 */
function sl_rosters_entity_type_alter(array &$entity_types) {
  if (isset($entity_types['sl_rosters'])) {
    $entity_types['sl_rosters']->setClass('Drupal\sl_rosters\Entity\SlRostersEntity');
  }
}

/*
 * Implements hook_inline_entity_form_entity_form_alter().
 */
function sl_rosters_inline_entity_form_entity_form_alter(&$entity_form, &$form_state) {
  // entering new roster

  if ($entity_form['#entity_type'] == 'sl_rosters' ) {
    $parent_entity = $form_state->getFormObject()->getEntity();
    $id = $parent_entity->id();
    $bundle = $entity_form['#bundle'];

    // hard coded minutes
    if (in_array($bundle, ['sl_roster_text', 'sl_rosters']) && (!$entity_form['#entity']->id())) {
      $entity_form['field_sl_roster_in']['widget'][0]['value']['#default_value'] = 0;
      $entity_form['field_sl_roster_out']['widget'][0]['value']['#default_value'] = 90;
    }

    // define players
    if (in_array($bundle, ['sl_rosters', 'sl_rosters_coach'])) {
      $entity_form['field_sl_roster_player']['widget'][0]['target_id']['#type'] = 'select';
      $team_to_pick = $entity_form['#parents'][0];

      if (strstr($team_to_pick, 'field_sl_match_home')) {
        $team_to_pick = 'field_sl_match_team_home';
      }
      else {
        $team_to_pick = 'field_sl_match_team_away';
      }


      $slBaseHelper = \Drupal::service('sl_base.helper');
      $team = $parent_entity->get($team_to_pick)->entity->id();
      $options = [];
      $players = $slBaseHelper->findTeamPlayers($team, $formatted = TRUE);
      $options[] = '';
      foreach ($players as $player_id => $player) {
        $options[$player_id] = $player['label'];
        $numbers[$player_id] = $player['number'];
      }

      asort($options);

      // for automatic number selection
      $rand = substr(uniqid('', true), -5);
      $entity_form['#attached']['drupalSettings']['sl_rosters'] = $numbers;
      $entity_form['field_sl_roster_num']['widget'][0]['value']['#attributes']['class'] = ['sl_roster_player_number_' . $rand];
      $entity_form['field_sl_roster_player']['widget'][0]['target_id']['#attributes']['class'] = ['sl_roster_player_selection'];
      $entity_form['field_sl_roster_player']['widget'][0]['target_id']['#attributes']['data-attribute-number'] = $rand;
      $entity_form['field_sl_roster_player']['widget'][0]['target_id']['#size'] = 1;
      $entity_form['field_sl_roster_player']['widget'][0]['target_id']['#options'] = $options;

      // default _value
      if (!empty($entity_form['#entity']->id())) {
        $entity_form['field_sl_roster_player']['widget'][0]['target_id']['#default_value'] = $entity_form['#entity']->field_sl_roster_player->entity->id();
      }
    }

    $entity_form['field_sl_match']['widget'][0]['target_id']['#default_value'] = $parent_entity->id();
    $entity_form['field_sl_match']['widget'][0]['target_id']['#type'] = 'hidden';

    // hide minutes
    if (!empty($entity_form['field_sl_roster_in']['widget'][0]['value']['#type'])) {
      $entity_form['field_sl_roster_in']['widget'][0]['value']['#type'] =
      $entity_form['field_sl_roster_out']['widget'][0]['value']['#type'] = 'hidden';
    }

  }
}