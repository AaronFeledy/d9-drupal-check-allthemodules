<?php

/*
 * Implements hook_entity_type_alter().
 */
function sl_match_moments_entity_type_alter(array &$entity_types) {
  if (isset($entity_types['sl_match_moments'])) {
    $entity_types['sl_match_moments']->setClass('Drupal\sl_match_moments\Entity\SlMatchMomentsEntity');
  }
}

/*
 * Implements hook_inline_entity_form_entity_form_alter().
 */
function sl_match_moments_inline_entity_form_entity_form_alter(&$entity_form, &$form_state) {

  // entering new roster

  if ($entity_form['#entity_type'] == 'sl_match_moments') {

    $parent_entity = $form_state->getFormObject()->getEntity();

    // define players
    $entity_form['field_sl_match_moments_player']['widget'][0]['target_id']['#type'] = 'select';
    $team_to_pick = $entity_form['#parents'][0];

    if (strstr($team_to_pick, 'field_sl_match_home')) {
      $team_to_pick = 'field_sl_match_team_home';
    }
    else {
      $team_to_pick = 'field_sl_match_team_away';
    }

    $slBaseHelper = \Drupal::service('sl_base.helper');
    $team = $parent_entity->get($team_to_pick)->entity->id();
    $players = $slBaseHelper->findTeamPlayers($team, TRUE);

    $options[] = '';
    foreach ($players as $player_id => $player) {
      $options[$player_id] = $player['label'];
      $numbers[$player_id] = $player['number'];
    }

    asort($options);

    $entity_form['field_sl_match_moments_player']['widget'][0]['target_id']['#size'] = 1;
    $entity_form['field_sl_match_moments_player']['widget'][0]['target_id']['#options'] = $options;

    if (!empty($entity_form['field_sl_match_moments_player_in']['widget'][0])) {
      $entity_form['field_sl_match_moments_player_in']['widget'][0]['target_id']['#type'] = 'select';
      $entity_form['field_sl_match_moments_player_in']['widget'][0]['target_id']['#size'] = 1;
      $entity_form['field_sl_match_moments_player_in']['widget'][0]['target_id']['#options'] = $options;
    }

    // default _value
    if (!empty($entity_form['#entity']->id())) {
      $entity_form['field_sl_match_moments_player']['widget'][0]['target_id']['#default_value'] = $entity_form['#entity']->field_sl_match_moments_player->entity->id();
    }
    else {
      if (!empty($entity_form['field_sl_match_moments_player_in']['widget'][0]) && !empty($entity_form['#entity']->id())) {
        $entity_form['field_sl_match_moments_player_in']['widget'][0]['target_id']['#default_value'] = $entity_form['#entity']->field_sl_match_moments_player_in->entity->id();
      }
    }


    $entity_form['field_sl_match']['widget'][0]['target_id']['#default_value'] = $parent_entity->id();
    $entity_form['field_sl_match']['widget'][0]['target_id']['#type'] = 'hidden';

  }
}