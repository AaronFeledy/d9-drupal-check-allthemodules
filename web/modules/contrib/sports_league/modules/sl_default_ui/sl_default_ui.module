<?php

use \Drupal\views\ViewExecutable;

function sl_default_ui_theme_suggestions_alter(array &$suggestions, array $variables, $hook) {
  if ($hook == 'views_view_table' && $view = $variables['view']) {
    if ($view->id() == 'sl_stats_players' && in_array($view->current_display, ['block_1', 'block_3', 'block_5'])) {
      $suggestions = ['views-sl-stats-main'];
    }
    if ($view->id() == 'sl_stats_players' && in_array($view->current_display, ['block_2', 'block_4'])) {
      $suggestions = ['views-sl-stats-secondary'];
    }
  }
}

function sl_default_ui_theme($existing, $type, $theme, $path) {

  return array(
    'views-sl-stats-main' => array(
      'variables' => array(
        'view' => NULL, 'rows' => NULL, 'title' => NULL, 'options' => NULL, 'theme_hook_original' => '', 'responsive' => NULL, 'sl_stats_footer' => NULL
      ),
      'render element' => 'elements',
      'template' => 'sl_stats_main',
      "preprocess functions" => [
        "sl_stats_table_preprocess",
        "template_preprocess",
        "template_preprocess_views_view_table",
        "contextual_preprocess"
      ]
    ),
    'views-sl-stats-secondary' => array(
      'variables' => array(
        'view' => NULL, 'rows' => NULL, 'title' => NULL, 'options' => NULL, 'theme_hook_original' => '', 'responsive' => NULL
      ),
      'render element' => 'elements',
      'template' => 'sl_stats_secondary',
      "preprocess functions" => [
        "template_preprocess",
        "template_preprocess_views_view_table",
        "contextual_preprocess"
      ]
    ),
  );
}

function sl_stats_table_preprocess(&$variables) {
  $view = $variables['view'];

  // builds footer total

  foreach ($view->field as $fid => $field) {
    if (isset($field->options['type']) && $field->options['type'] == 'number_integer') {
      $footer[$fid] = 0;
    }
  }

  foreach ($view->result as $rid => $row) {
    foreach ($view->field as $fid => $field) {
      $value = $field->getValue($row);

      if (is_numeric($value) && isset($footer[$fid])) {
        $footer[$fid] += $value;
      }
    }
  }

  $footer['field_sl_administrative_title'] = t('Total');
  $variables['sl_stats_footer'] = $footer;
}