<?php

/**
 * @file
 * Enables users to limit where quickedit appears.
 */

use Drupal\Core\Field\BaseFieldDefinition;
use Drupal\Core\Form\FormStateInterface;
use Drupal\field\Entity\FieldConfig;

/**
 * Implements hook_form_alter().
 */
function restricted_quickedit_form_field_ui_field_edit_form_alter(array &$form, FormStateInterface $form_state) {
  $form['field']['third_party_settings']['restricted_quickedit']['disable_quick_edit'] = array(
    '#type' => 'checkbox',
    '#title' => t('Disable quick edit'),
    '#default_value' => $form_state->get('field')->getThirdPartySetting('restricted_quickedit', 'disable_quick_edit', FALSE),
    '#weight' => -1,
  );
}

/**
 * Implements hook_preprocess_HOOK() for field templates.
 */
function restricted_quickedit_preprocess_field(&$variables) {
  $element = $variables['element'];
  /** @var $entity \Drupal\Core\Entity\EntityInterface */
  $entity = $element['#object'];

  $definition = $entity->getFieldDefinition($element['#field_name']);
  if ($definition && $definition instanceof FieldConfig && $definition->getThirdPartySetting('restricted_quickedit', 'disable_quick_edit', FALSE)) {
    unset($variables['attributes']['data-quickedit-field-id']);
  }
  elseif ($definition && $definition instanceof BaseFieldDefinition && $definition->getSetting('disable_quick_edit')) {
    unset($variables['attributes']['data-quickedit-field-id']);
  }
}
