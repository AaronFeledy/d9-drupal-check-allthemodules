<?php

/**
 * @file
 * Module.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\field\FieldConfigInterface;
use Drupal\Core\Entity\EntityFormInterface;
use Drupal\Core\Entity\ContentEntityInterface;
use Drupal\video_embed_vkontakte\Plugin\video_embed_field\Provider\Vkontakte;

function video_embed_vkontakte_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if ($form_state->getFormObject() instanceof EntityFormInterface) {
    /** @var \Drupal\Core\Entity\EntityInterface $entity */
    $entity = $form_state->getFormObject()->getEntity();

    if ($entity instanceof ContentEntityInterface) {
      $entity = $form_state->getFormObject()->getEntity();
      /** @var \Drupal\Core\Entity\EntityFieldManagerInterface $entity_field_manager */
      $entity_field_manager = Drupal::service('entity_field.manager');
      $entity_type = $entity->getEntityTypeId();
      $entity_bundle = $entity->bundle();
      $fields = $entity_field_manager->getFieldDefinitions($entity_type, $entity_bundle);
      $form_has_video_embed_field = FALSE;

      if (!empty($fields)) {
        foreach ($fields as $key => $field) {
          if ($field instanceof FieldConfigInterface && $field->getType() === 'video_embed_field') {
            $form_has_video_embed_field = TRUE;
            $temp = $form_state->getTemporaryValue('video_embed_field_fields');
            $temp[] = $field->getName();
            $form_state->setTemporaryValue('video_embed_field_fields', $temp);
          }
        }
      }

      if ($form_has_video_embed_field) {
        array_unshift($form['actions']['submit']['#submit'], 'video_embed_vkontakte_form_submit');
      }
    }
  }
}

/**
 * Submit.
 *
 * @param $form
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 */
function video_embed_vkontakte_form_submit($form, FormStateInterface $form_state) {
  $temp = $form_state->getTemporaryValue('video_embed_field_fields');

  if (!empty($temp)) {
    foreach ($temp as $field_name) {
      $values = $form_state->getValue($field_name);

      if (!empty($values)) {
        foreach ($values as $key => $value) {
          $values[$key]['value'] = Vkontakte::getUrlFromInput($value['value']);
        }

        $form_state->setValue($field_name, $values);
      }
    }
  }
}

