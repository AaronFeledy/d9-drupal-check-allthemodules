<?php

/**
 * @file
 * Arbitrary Token module code.
 */

use Drupal\Core\Render\BubbleableMetadata;

/**
 * Implements hook_token_info().
 */
function arb_token_token_info() {
  $types['arb'] = [
    'name' => t("Arbitrary"),
    'description' => t("Arbitrary tokens."),
  ];

  $arb = [];
  foreach (\Drupal::entityTypeManager()->getStorage('arb_token')->loadMultiple() as $token) {
    /** @var \Drupal\arb_token\Entity\ArbitraryToken $token */
    $plugin = $token->getPlugin();
    $arb[$token->id()] = $plugin->tokenInfo();
  }
  $arb = array_filter($arb);

  return [
    'types' => $types,
    'tokens' => [
      'arb' => array_filter($arb),
    ],
  ];
}

/**
 * Implements hook_tokens().
 */
function arb_token_tokens($type, $tokens, array $data, array $options, BubbleableMetadata $bubbleable_metadata) {
  $replacements = [];

  if ($type != 'arb') {
    return $replacements;
  }

  foreach (\Drupal::entityTypeManager()->getStorage('arb_token')->loadMultiple() as $token) {
    /** @var \Drupal\arb_token\Entity\ArbitraryToken $token */
    $replacements += $token->tokens($tokens, $data, $options, $bubbleable_metadata);
  }

  return $replacements;
}
