<?php

/**
 * Implements hook_modules_installed().
 */
function advpoll_modules_installed($modules) {
  // necessary to do this since it can't be done in config and field config needs to have been installed first.
  // using https://www.drupal.org/docs/8/api/update-api/updating-entities-and-fields-in-drupal-8 example as guide
  $form_display = \Drupal::entityManager()->getStorage('entity_form_display')->load('poll.poll.default');

  if ($form_display) {
    $form_display->setComponent('field_poll_type', [
      'type' => 'options_select',
      'weight' => 1,
      'region' => 'content'
    ]);
    $form_display->save();
    $form_display->setComponent('field_writein', [
      'type' => 'boolean_checkbox',
      'weight' => 2,
      'settings' => [
        'display_label' => TRUE
      ],
      'region' => 'content'
    ]);
    $form_display->save();
    $form_display->setComponent('field_number_of_votes', [
      'type' => 'number',
      'weight' => 3,
      'region' => 'content'
    ]);
    $form_display->save();
    $form_display->setComponent('field_start_date', [
      'type' => 'datetime_default',
      'weight' => 4,
      'region' => 'content'
    ]);
    $form_display->save();
  }
}


/**
 * Implements hook_entity_view().
 */
function advpoll_entity_view(array &$build, \Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display, $view_mode) {
  // reset lazy loader in Poll to use our service which will allow specific form output per poll type
  if ($entity->getEntityType()->id() == 'poll') {
    $build['poll'] = array(
      '#lazy_builder' => [
        'advpoll.post_render_cache:renderViewForm',
        [
          'id' => $entity->id(),
          'view_mode' => $view_mode,
          'langcode' => $entity->language()->getId(),
        ],
      ],
      '#create_placeholder' => TRUE,
      '#cache' => [
        'tags' => $entity->getCacheTags(),
      ],
    );
  }
}
