<?php

function replain_page_bottom(array &$page_bottom) {
	
	$token = \Drupal::state()->get('replain_token');
	$status = \Drupal::state()->get('replain_status');	
	$jsCode = 'var __REPLAIN_ = \''.$token.'\';(function(u){var s=document.createElement(\'script\');s.type=\'text/javascript\';s.async=true;s.src=u;var x=document.getElementsByTagName(\'script\')[0];x.parentNode.insertBefore(s,x);})(\'https://widget.replain.cc/dist/client.js\');';
	$jsCode = stripslashes( $jsCode );
	
	if (\Drupal::service('router.admin_context')->isAdminRoute(\Drupal::routeMatch()->getRouteObject()))
		return;
	
	if (isset($token) && ($status == 1)) {
		$page_bottom['replain'] = [
			'#type' => 'html_tag',
			'#tag' => 'script',
			'#value' => $jsCode,
			'#attributes' => array(
				'src' => NULL
			),
		];
	}
}

function replain_page_attachments(array &$page) {

		$page['#attached']['library'][] = 'replain/replain';
}