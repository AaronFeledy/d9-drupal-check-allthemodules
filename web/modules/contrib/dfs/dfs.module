<?php

/**
 * @file
 * Module file for the default file settings module.
 */

/**
 * Implements hook_form_alter().
 */
function dfs_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  $config = \Drupal::config('dfs.settings');
  // Check and set default values for image and file fields.
  if ($form['#id'] === 'field-config-edit-form') {
    $type = isset($form['settings']['default_image']) ? 'image' : 'file'; 
    $defaults = array();
    $defaults['default_image'] = $config->get('dfs_default_image');
    $defaults['min_resolution'] = $config->get('dfs_min_resolution');
    $defaults['max_resolution'] = $config->get('dfs_max_resolution');
    $defaults['max_filesize'] = $config->get('dfs_' . $type . '_max_filesize');
    $defaults['file_extensions'] = $config->get('dfs_' . $type . '_file_extensions');
    $require_filesize = $config->get('dfs_' . $type . '_require_filesize');
    foreach ($defaults as $key => $value) {
      // This setting is overridden from the default.
      if (!empty($form['settings'][$key]['#default_value']) || !isset($form['settings'][$key])) {
        continue;
      }
      // Optionally require the maximum filesize.
      if ($key == 'max_filesize' && $require_filesize) {
        $form['settings'][$key]['#required'] = TRUE;
      }
      if ($key == 'default_image') {
        $form['settings'][$key]['uuid']['#default_value'] = $value;
      }
      elseif (is_array($value)) {
        // Array items for things like Width, Height (x, y).
        foreach ($value as $id => $item) {
          if (empty($form['settings'][$key]['#default_value'])) {
            $form['settings'][$key][$id]['#default_value'] = $item;
          }
        }
      }
      else {
        if (empty($form['settings'][$key]['#default_value'])) {
          $form['settings'][$key]['#default_value'] = $value;
        }
      }
    }
  }
}
