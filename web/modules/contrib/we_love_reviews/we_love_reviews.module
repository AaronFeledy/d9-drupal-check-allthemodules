<?php

/**
 * @author Yury "yurg" Gomankov <yurg@yurg.org> for ReputationAegis.com
 * for support head over to https://reputationaegis.com/
*/

/**
 * Add JavaScript code .
 */


/*
function  we_love_reviews_editor_js_settings_alter(array &$settings) {
  if (empty($settings['editor']['formats']['html'])) {
    return;
  }
 $settings['editor']['formats']['html']['editorSettings']['forcePasteAsPlainText'] = true;
  	dsm($settings);
}
*/

function we_love_reviews_page_attachments(array &$page) {



/*
 *  Request
 */


  $config = \Drupal::config('we_love_reviews.settings');

 if(!empty($config->get('companyid'))  && !empty($config->get('apikey'))) {

  $client = \Drupal::httpClient();
  $url = 'https://reputationcrm.com/v2/getOverallRatingAndReviewCountForPlatformReviewsByCompanyId?companyid='
    .$config->get('companyid').'&key='.$config->get('apikey');
  $method = 'GET';
  $options = [
   'http_errors' => FALSE,
  ];

  $response = $client->request($method, $url, $options);
  $code = $response->getStatusCode();
  $print_rating = $response->getBody(); 

// Replace response key returned by server to one https://search.google.com/structured-data/testing-tool accepts 
 $print_rating = str_replace('OverallRating', 'ratingValue', $print_rating);
 $print_rating = '",aggregateRating": {"@type": "AggregateRating","worstRating": "1","bestRating": "5",' .substr($print_rating, 1);
     /*
     * Clear zero rating
     */

     /* 
      * Exact ZERO search, not as part of  a digit  
     */

      preg_match("~\b0\b~",  $print_rating, $matches);
      empty($matches)? $print_rating : $print_rating = ''; 
}

/*
 *  Code
 */

if(isset($code)) {

if($code == '200') {
$we_love_reviewsJS ='
{"@context":"http://schema.org",
"@type":"LocalBusiness","name":"'.\Drupal::config('we_love_reviews.data')->get('business_name').'", 
"url":"'. \Drupal::config('we_love_reviews.data')->get('business_url').'",
"sameAs":["'.\Drupal::config('we_love_reviews.data')->get('business_sameas').'"],
"image":"'.\Drupal::config('we_love_reviews.data')->get('business_logourl').'",
"telephone":"' . \Drupal::config('we_love_reviews.data')->get('business_phone').'",
"email":"'.\Drupal::config('we_love_reviews.data')->get('business_email').'",
"address": {
"@type":"PostalAddress",
"addressCountry":"'.\Drupal::config('we_love_reviews.data')->get('business_country').'",
"addressLocality":"'.\Drupal::config('we_love_reviews.data')->get('business_town').'",
"addressRegion":"'.\Drupal::config('we_love_reviews.data')->get('business_state').'",
"postalCode":"'.\Drupal::config('we_love_reviews.data')->get('business_zip').'",
"streetAddress":"'.\Drupal::config('we_love_reviews.data')->get('business_address').'"
}'.$print_rating.'}';

  $we_love_reviewsJS = str_replace(array("\r\n", "\n", "\r"), '', $we_love_reviewsJS);

} else {
  $we_love_reviewsJS = t('Sorry, Reputation CRM API returned an error code. Please, try again!');
}

  // Add code to the front-end only.
  if (\Drupal::service('router.admin_context')->isAdminRoute()) {
    return;
  }

  $page['#attached']['html_head'][] = [
     [
     '#tag' => 'script',
     '#value' =>   $we_love_reviewsJS,
     '#attributes' => [
      'type' => 'application/ld+json',
     ],
    ],
  ];
} else {
  
  if (\Drupal::service('router.admin_context')->isAdminRoute()) {
    global $base_url;
    drupal_set_message(t('Finish the installation: go to the We â™¥ Reviews settings in the <a href="@we_love_reviews-account">Module Administration Page</a>', [
        '@we_love_reviews-account' => $base_url . '/admin/config/services/we_love_reviews'
    ]));
  }
 }
}