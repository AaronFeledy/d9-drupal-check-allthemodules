<?php
/**
 * @file
 *   Video JS module functions
 */

use Drupal\Component\Utility\Unicode;

/**
 * Implements hook_theme().
 */
function video_js_theme($existing, $type, $theme, $path) {
  $path = drupal_get_path('module', 'video_js') .'/templates';
  return [
    'video_js__video' => [
      'variables' => ['source' => [], 'format' => NULL],
      'path' => $path,
    ],
  ];
}

/**
 * Implements hook_page_attachments().
 *
 * @param array $attachments
 * @throws \Drupal\Component\Plugin\Exception\InvalidPluginDefinitionException
 */
function video_js_page_attachments(array &$attachments) {
  $entity_type_manager = \Drupal::entityTypeManager();
  $page_storage = $entity_type_manager->getStorage('video_js');
  if ($pages = $page_storage->loadByProperties(['status' => TRUE])) {
    $matcher = \Drupal::service('path.matcher');
    $current_path = \Drupal::service('path.current')->getPath();
    /** @var \Drupal\video_js\Entity\VideoJsInterface $page */
    foreach ($pages as $page) {

      if ($matcher->matchPath($current_path, $page->getPath())) {
        $attachments['#attached']['drupalSettings']['video_js'] = [
          'element' => $page->getElement(),
          'html' => $page->getHtml()
        ];
        $attachments['#attached']['library'][] = 'video_js/video_js';
      }
    }
  }
}
