<?php
/**
 * @file
 * .install for junk_test_project
 */

function junk_test_project_install() {
  // Set weight higher than token module so we can alter actions.
  $system_entry = array('weight' => 11);
  try {
    $result = db_update('system')
    ->fields($system_entry)
    ->condition('name', 'junk_test_project')
    ->execute();
  }
  catch(Exception $e) {
    throw(DrupalUpdateException(t('db_update failed. Message = %message, query= %query',
      array('%message' => $e->getMessage(), '%query' => $e->query_string))));
  }
}

function junk_test_project_uninstall() {
  //TODO: Check that this works.
  db_delete('variable')
    ->condition('name', 'junk_test_project%', 'LIKE')
    ->execute();

  cache_clear_all('variables', 'cache');
}

/**
 * Attempt to update existing [role] or [role-changed] to new format.
 */
function junk_test_project_update_7100() {
  $subject = variable_get('junk_test_project_role_added_subject', "");
  $body = variable_get('junk_test_project_role_added_body', "");
  if (!empty($subject)) {
    $subject = preg_replace('/(\[role\]|\[role_changed\])/', '[user:role-changed]', $subject);
  }
  if (!empty($body)) {
    $body = preg_replace('/(\[role\]|\[role_changed\])/', '[user:role-changed]', $body);
  }
  variable_set('junk_test_project_role_added_subject', $subject);
  variable_set('junk_test_project_role_added_body', $body);
  return(t('Role Change Notify updated the [user:role-changed] token but other tokens may still be obsolete in various messages. Please check your messages in <a href="@rcn_link">Role Change Notification admin</a> and in any actions that use the Role Change Notification triggers.'));
}
