<?php

/**
 * @file
 * Module file.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\panels_extended\Form\AdminSettingsForm;

/**
 * Implements hook_theme().
 */
function panels_extended_theme() {
  return [
    'panels_extended_content_form_block_info' => [
      'variables' => [
        'title' => '',
        'title_visible' => TRUE,
        'plugin_id' => NULL,
        'schedule_start' => '',
        'schedule_end' => '',
        'disabled' => FALSE,
        'unscheduled' => FALSE,
        'visible' => FALSE,
        'notVisibleReason' => NULL,
        'primary_info' => [],
        'secondary_info' => [],
      ],
      'template' => 'content_form_block_info',
    ],

    'panels_extended_base_block_build' => [
      'variables' => [
        'blockType' => NULL,
        'loadtime' => NULL,
        'content' => [],
      ],
      'template' => 'base_block_build',
    ],
  ];
}

/**
 * Check if JSON is requested by checking the GET-parameter '_format'.
 *
 * @return bool
 *   TRUE if JSON is requested, FALSE otherwise.
 */
function _panels_extended_is_json_requested() {
  static $drupal_static_fast;
  if (!isset($drupal_static_fast)) {
    $drupal_static_fast['panels_extended_json_requested'] = &drupal_static(__FUNCTION__);
  }
  $jsonRequested = &$drupal_static_fast['panels_extended_json_requested'];
  if ($jsonRequested === NULL) {
    $jsonRequested = \Drupal::request()->query->get('_format') === 'json';
  }
  return $jsonRequested;
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function panels_extended_form_page_manager_general_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  _panels_extended_set_default_display_variant($form);
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function panels_extended_form_page_manager_add_variant_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  _panels_extended_set_default_display_variant($form);
}

/**
 * Set the default display variant in the form if configured.
 *
 * @param array $form
 *   The form.
 */
function _panels_extended_set_default_display_variant(array &$form) {
  if (isset($form['variant_plugin_id']) && empty($form['variant_plugin_id']['#default_value'])) {
    $default = \Drupal::config(AdminSettingsForm::CFG_NAME)->get(AdminSettingsForm::CFG_DEFAULT_DISPLAY_VARIANT);
    if (!empty($default)) {
      $form['variant_plugin_id']['#default_value'] = $default;
    }
  }
}