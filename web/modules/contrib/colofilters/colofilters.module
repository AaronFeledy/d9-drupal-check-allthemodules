<?php

/**
 * @file
 * Contains colofilters.module..
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Entity\Entity\EntityViewDisplay;

/**
 * Helper function to get all the effects.
 */
function colofilters_get_effects() {
  return [
    0 => 'No Effect',
    'blend-blue' => 'blend-blue',
    'blend-blue-dark' => 'blend-blue-dark',
    'blend-blue-light' => 'blend-blue-light',
    'blend-orange' => 'blend-orange',
    'blend-orange-dark' => 'blend-orange-dark',
    'blend-orange-light' => 'blend-orange-light',
    'blend-red' => 'blend-red',
    'blend-red-dark' => 'blend-red-dark',
    'blend-red-light' => 'blend-red-light',
    'blend-green' => 'blend-green',
    'blend-green-dark' => 'blend-green-dark',
    'blend-green-light' => 'blend-green-light',
    'blend-yellow' => 'blend-yellow',
    'blend-yellow-dark' => 'blend-yellow-dark',
    'blend-yellow-light' => 'blend-yellow-light',
    'blend-purple' => 'blend-purple',
    'blend-purple-dark' => 'blend-purple-dark',
    'blend-purple-light' => 'blend-purple-light',
    'blend-pink' => 'blend-pink',
    'blend-pink-dark' => 'blend-pink-dark',
    'blend-pink-light' => 'blend-pink-light',
    'blend-blue-yellow' => 'blend-blue-yellow',
    'blend-blue-yellow-dark' => 'blend-blue-yellow-dark',
    'blend-blue-yellow-light' => 'blend-blue-yellow-light',
    'blend-pink-yellow' => 'blend-pink-yellow',
    'blend-pink-yellow-dark' => 'blend-pink-yellow-dark',
    'blend-pink-yellow-light' => 'blend-pink-yellow-light',
    'blend-red-blue' => 'blend-red-blue',
    'blend-red-blue-dark' => 'blend-red-blue-dark',
    'blend-red-blue-light' => 'blend-red-blue-light',
  ];
}

/**
 * Implements hook_help().
 */
function colofilters_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the colofilters module.
    case 'help.page.colofilters':
      $output = file_get_contents(drupal_get_path('module', 'colofilters') . '/README.md');
      return $output;

    default:
  }
}

/**
 * Implements hook_field_formatter_info_alter().
 */
function colofilters_field_formatter_info_alter(array &$info) {
  $info['image']['settings']['colofilters_filters'] = '';
}

/**
 * Implements hook_field_formatter_third_party_settings_form().
 */
function colofilters_field_formatter_third_party_settings_form($plugin, $field_definition, $view_mode, $form, $form_state) {
  // Initialize.
  $element = [];
  // If image.
  if ($plugin->getPluginId() == 'image') {
    $effects = colofilters_get_effects();
    $element['colofilters_filters'] = [
      '#type' => 'select',
      '#title' => t('Select Effect'),
      '#default_value' => $plugin->getThirdPartySetting('colofilters', 'colofilters_filters'),
      '#options' => $effects,
    ];
  }
  return $element;
}

/**
 * Implements hook_field_formatter_settings_summary_alter().
 */
function colofilters_field_formatter_settings_summary_alter(&$summary, $context) {
  if ($context['formatter']->getPluginId() == 'image') {
    $getFilter = $context['formatter']->getThirdPartySetting('colofilters', 'colofilters_filters');
    // Add our effects.
    if ($getFilter) {
      $effects = colofilters_get_effects();
      $summary[] = t('Effects:') . ' ' . $effects[$getFilter];
    }
  }
}

/**
 * Implements hook_preprocess_field().
 */
function colofilters_preprocess_field(&$variables) {
  if ($variables['element']['#formatter'] == 'image') {
    $entity = $variables['element']['#object'];
    $view_mode = $variables['element']['#view_mode'];
    $field_name = $variables['element']['#field_name'];

    $entity_display = EntityViewDisplay::collectRenderDisplay($entity, $view_mode);
    $field_display = $entity_display->getComponent($field_name);

    $variables['attributes']['class'] = $field_display['third_party_settings']['colofilters']['colofilters_filters'];
    if (isset($field_display['third_party_settings']['colofilters']['colofilters_filters'])) {
      $variables['attributes']['class'] .= ' colofiltersfield';
    }
    $variables['#attached']['library'][] = 'colofilters/colofilters';
  }
}
