<?php
/**
 * @file
 * The Pines Notify module displays messages through growl notifications.
 */

/**
 * Implements hook_page_attachments().
 */
function pines_notify_page_attachments(&$attachments) {
  // Load jquery UI for styling purposes.
  //drupal_add_library('system', 'ui');

  // Add and initialize the Pines Notify plugin.
  libraries_load('pnotify');
  $config = \Drupal::config('pines_notify.settings');

  // Pines Notify configurations and settings.
  $settings = array();
  $settings['title_success'] = t($config->get('title_success'));
  $settings['title_error'] = t($config->get('title_error'));
  $settings['animation'] = $config->get('animation');
  $settings['delay'] = $config->get('delay');
  $settings['opacity'] = $config->get('opacity');
  $settings['shadow'] = $config->get('shadow');
  $settings['hide'] = $config->get('hide');
  $settings['nonblock'] = $config->get('nonblock');
  $settings['desktop'] = $config->get('desktop');
  // Attach the settings and library.
  $attachments['#attached']['drupalSettings']['pines_notify'] = $settings;
  $attachments['#attached']['library'][] = 'pines_notify/pines_notify.pnotify';
}

/**
 * Implements hook_menu().
 */
function pines_notify_menu() {
  $items['admin/config/user-interface/pines-notify'] = array(
    'title' => 'Pines Notify',
    'description' => "Configure Pines Notify messge settings.",
    'route_name' => 'pines_notify.settings',
  );
 
  return $items;
}

/**
 * Implements hook_theme().
 */
function pines_notify_theme() {
  return array(
    'pines_notify' => array(
      'arguments' => array('content' => NULL),
    ),
  );
}

/**
 * Implements hook_preprocess_page().
 */
function pines_notify_preprocess_page(&$vars) {
  $message = drupal_get_messages();
  if (!empty($message)) {
    // Success messages.
    if (isset($message['status'])) {
      foreach ($message['status'] as $status_message) {
        // Exclude devel output from pnotify output.
        if (strpos($status_message, 'krumo-root') === FALSE) {
          // Add the drupal message to our module's settings message bin.
          $vars['#attached']['drupalSettings']['pines_notify']['messages'] = array('success' => $status_message);
        }
      }
    }
    // Error messages.
    if (isset($message['error'])) {
      foreach ($message['error'] as $error_message) {
        // Add the drupal message to our module's settings message bin.
        $vars['#attached']['drupalSettings']['pines_notify']['messages'] = array('error' => $error_message);
      }
    }
  }
}
