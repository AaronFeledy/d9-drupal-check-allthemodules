<?php

/**
 * Implements hook_preprocess_HOOK().
 *
 * Hide the stripoe_checkout field if the user already has a license.
 */
function stripe_licensing_preprocess_field(&$variables) {
   if ($variables['field_type'] == 'stripe_checkout') {
     $entity = $variables['element']['#object'];
     $account = $variables['user'];

     // Licensing does not apply to administrators.
     $is_admin = $account->hasPermission('administer license entities');

     // If user has active license for this entity, hide stripe_checkout field.
     if ($is_admin || $active_license = licensing_load_active_user_license_for_entity($account, $entity)) {
       $variables['label_hidden'] = TRUE;
       unset($variables['items']);
     }
   }
}

/**
 * Implements hook_stripe_checkout_charge_succeeded().
 *
 * This is a bit of a belt and suspenders approach because we also have an
 * event subscriber doing exactly the same thing. Remove subscriber?
 */
function stripe_licensing_stripe_checkout_charge_succeeded(\Stripe\Charge $charge, \Drupal\node\NodeInterface $node, \Drupal\Core\Session\AccountInterface $account) {
  $licensing = \Drupal::service('licensing.licensing');
  // @todo Ensure that this entity type should be licensed.
  $licensing->createOrUpdateLicense($account->id(), $node->id(), LICENSE_ACTIVE);
}
