<?php

/**
 * @file
 * Module file for welcome mail.
 */

use Drupal\Core\Entity\EntityInterface;

define('WELCOME_MAIL_QUEUE_NAME', 'welcome_mail');

/**
 * Implements hook_ENTITY_TYPE_insert().
 */
function welcome_mail_user_insert(EntityInterface $entity) {
  $config = \Drupal::configFactory()
    ->get('welcome_mail.settings');
  // If it is not enabled, do nothing.
  if (!$config->get('enabled')) {
    return;
  }
  $queue = \Drupal::queue(WELCOME_MAIL_QUEUE_NAME);
  $queue->createItem($entity->id());
}

/**
 * Implements hook_mail().
 */
function welcome_mail_mail($key, &$message, $params) {
  $config = \Drupal::config('welcome_mail.settings');
  $message['subject'] = $config->get('subject');
  $body = $config->get('body');
  $message['body'][] = check_markup($body['value'], $body['format']);
  // Let other modules alter it.
  \Drupal::moduleHandler()
    ->alter('welcome_mail_mail', $message);
}
