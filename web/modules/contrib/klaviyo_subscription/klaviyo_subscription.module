<?php

use Drupal\Core\Form\FormStateInterface;
/**
 * @file
 * Subscribe user on register.
 */

 /**
  * Implements hook_form_alter().
  */
function klaviyo_subscription_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
	 $account = \Drupal::currentUser();
	 if($form_id == 'user_register_form' || $form_id == 'user_form') {
		module_load_include('inc', 'klaviyo_subscription', 'includes/klaviyo_subscription');
		$lists = klaviyo_subscription_get_drupal_list();
		
		if(!empty($lists)) {
				foreach($lists as $list_id => $list_name) {
					$form['klaviyo_subscribe']['subscribe_' .$list_id] = [
					  '#type' => 'checkbox',
					  '#title' => 'Subscribe to ' . $list_name,
					];
			}
			
			// Submit handler for handler actual subscription					
			if($account->id() > 0) {
				$form['actions']['submit']['#submit'][] = 'klaviyo_subscription_subscribe_klaviyo_edit';	
			} else {
				$form['actions']['submit']['#submit'][] = 'klaviyo_subscription_subscribe_klaviyo';	
			}			
		} 
	}  
}

 /**
  * Submit handler for subscribe uesr on kalviyo on user register.
  */
function klaviyo_subscription_subscribe_klaviyo(array $form, FormStateInterface $form_state) {
	module_load_include('inc', 'klaviyo_subscription', 'includes/klaviyo_subscription');
	$lists = klaviyo_subscription_get_drupal_list();
			foreach($lists as $list => $kl_list) {
				if($form_state->getValue('subscribe_' . $list)) {
					if(klaviyo_subscription_subscribe_list($list, $form_state->getValue('mail'))) {
						drupal_set_message(t($form_state->getValue('mail') .' is successfully subscribe to klaviyo.'), 'status');
					} else {
						drupal_set_message(t('There is some problem in subscribe to klaviyo.'), 'warning');
					}
					
				}
			}
}

/**
 * Submit handler for subscribe or unsubscribe user on kalviyo on user edit page.
 */
function klaviyo_subscription_subscribe_klaviyo_edit(array $form, FormStateInterface $form_state) {
	$user = \Drupal::currentUser();
	module_load_include('inc', 'klaviyo_subscription', 'includes/klaviyo_subscription');
	$lists = klaviyo_subscription_get_drupal_list();
	foreach($lists as $list => $kl_list) {
		$statue = klaviyo_subscription_check_subscribe($list, $form_state->getValue('mail'));
		if($statue == true && $form_state->getValue('subscribe_' . $list) == 0) {
			klaviyo_subscription_unsubscribe_list($list, $form_state->getValue('mail'));
		} elseif($statue == false && $form_state->getValue('subscribe_' . $list) == 1) {
			if(klaviyo_subscription_subscribe_list($list, $form_state->getValue('mail'))) {
				drupal_set_message(t($form_state->getValue('mail') .' is successfully subscribe to klaviyo.'), 'status');
			} else {
				drupal_set_message(t('There is some problem in subscribe to klaviyo.'), 'warning');
			}
		}
	}
}