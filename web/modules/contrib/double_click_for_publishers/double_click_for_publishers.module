<?php

/**
 * @file
 * Contains double_click_for_publishers.module.
 */

/**
 * Implements hook_preprocess_HOOK().
 */
function double_click_for_publishers_preprocess_block(&$variables) {
  $drupal_settings_array = [];
  if ($variables['configuration']['provider'] == 'double_click_for_publishers') {
    $blocks = \Drupal::entityTypeManager()
      ->getStorage('block')
      ->loadByProperties([
        'theme' => \Drupal::config('system.theme')
          ->get('default'),
        'plugin' => 'dfp_add_block',
      ]);

    $i = 0;
    /** @var \Drupal\block\Entity\Block $block */
    foreach ($blocks as $block) {
      $visible = $block->access('view');
      if ($visible) {
        $settings = $block->get('settings');
        $drupal_settings_array[$i] = $settings;
        $i++;
      }
    }
    $variables['content']['#attached']['drupalSettings']['drupal_settings_array'] = $drupal_settings_array;
    $variables['content']['#attached']['library'][1] = 'double_click_for_publishers/js-header';
    $variables['content']['#attached']['library'][2] = 'double_click_for_publishers/js-body';
  }
}
