# Override file for the DrupalCI automated build system.
# Runs the tests for the User Guide. Customizations:
# - No codebase validation. It's just not really necessary for this project.
# - Suppress deprecation messages.
# - Only run FunctionalJavascript tests (it's the only kind we have for now).
# - Apply patches to get around Core issues:
#   https://www.drupal.org/project/drupal/issues/2905295
#   https://www.drupal.org/project/drupal/issues/3037729
# - Download the backup and migrate library manually, as it is currently not
#   in Packagist. See issue
#   https://github.com/backupmigrate/backup_migrate_core/issues/3
# - Add version number strings to the contrib module/theme we download in the
#   composer.json file.
build:
  assessment:
    testing:
      container_command:
        commands:
          - "cd ${SOURCE_DIR} && sudo -u www-data curl https://www.drupal.org/files/issues/2019-02-26/2905295-work-around.patch | git apply -"
          - "cd ${SOURCE_DIR} && sudo -u www-data curl https://www.drupal.org/files/issues/2019-03-05/3037729.patch | git apply -"
          - "cd ${SOURCE_DIR} && sudo -u www-data /usr/local/bin/composer require psr/log dev-master --prefer-source --prefer-stable --no-progress --no-suggest --no-interaction --working-dir /var/www/html"
          - "cd ${SOURCE_DIR} && sudo -u www-data /usr/local/bin/composer config repositories.bm vcs https://github.com/backupmigrate/backup_migrate_core --working-dir /var/www/html"
          - "cd ${SOURCE_DIR} && sudo -u www-data /usr/local/bin/composer require backupmigrate/core --prefer-source --prefer-stable --no-progress --no-suggest --no-interaction --working-dir /var/www/html"
          - "cd ${SOURCE_DIR} && cd modules/contrib/admin_toolbar && sudo -u www-data /bin/echo 'version: 8.x-1.25' >> admin_toolbar.info.yml"
          - "cd ${SOURCE_DIR} && cd modules/contrib/admin_toolbar && sudo -u www-data /bin/sed -i -e '/VERSION/d' admin_toolbar.info.yml"
          - "cd ${SOURCE_DIR} && cd modules/contrib/admin_toolbar && sudo -u www-data /bin/echo 'project: admin_toolbar' >> admin_toolbar.info.yml"
          - "cd ${SOURCE_DIR} && cd modules/contrib/admin_toolbar && sudo -u www-data /bin/echo 'datestamp: 1542915184' >> admin_toolbar.info.yml"
          - "cd ${SOURCE_DIR} && cd modules/contrib/admin_toolbar && cat admin_toolbar.info.yml"
          - "cd ${SOURCE_DIR} && cd themes/contrib/mayo && sudo -u www-data /bin/echo 'version: 8.x-1.2' >> mayo.info.yml"
          - "cd ${SOURCE_DIR} && cd themes/contrib/mayo && sudo -u www-data /bin/sed -i -e '/VERSION/d' mayo.info.yml"
          - "cd ${SOURCE_DIR} && cd themes/contrib/mayo && sudo -u www-data /bin/echo 'project: mayo' >> mayo.info.yml"
          - "cd ${SOURCE_DIR} && cd themes/contrib/mayo && sudo -u www-data /bin/echo 'datestamp: 1459203843' >> mayo.info.yml"
          - "cd ${SOURCE_DIR} && cd themes/contrib/mayo && cat mayo.info.yml"
        halt-on-fail: true
      run_tests.js:
        concurrency: 1
        types: 'PHPUnit-FunctionalJavascript'
        suppress-deprecations: true
        testgroups: '--all'
        halt-on-fail: false
