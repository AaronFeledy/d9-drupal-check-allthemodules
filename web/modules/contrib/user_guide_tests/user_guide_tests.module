<?php

/**
 * @file
 * Fixes and alters for running tests and making screenshots.
 *
 * Note that this module must be given a higher weight in core.extension config
 * than the locale module.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\update\UpdateManagerInterface;

/**
 * Implements hook_form_FORM_ID_alter() for language_admin_add_form().
 */
function user_guide_tests_form_language_admin_add_form_alter(&$form, FormStateInterface $form_state) {
  // Remove the custom submit that the locale module added, to avoid bulk
  // operations.
  $form['predefined_submit']['#submit'] = array_diff(
    $form['predefined_submit']['#submit'],
    ['locale_form_language_admin_add_form_alter_submit']);
}

/**
 * Implements hook_module_preinstall().
 *
 * Fools the locale module into not doing its batch.
 */
function user_guide_tests_module_preinstall($module) {
  if (!drupal_installation_attempted()) {
    // This makes drupal_installation_attempted() return TRUE, so the locale
    // module will not run its batch.
    $GLOBALS['install_state'] = ['foo'];
  }
}

/**
 * Implements hook_page_attachments().
 *
 * Adds the CSS library that turns off transitions, to avoid random test
 * fails. This can be removed if
 * https://www.drupal.org/project/drupal/issus/2901792
 * is fixed.
 */
function user_guide_tests_page_attachments(array &$attachments) {
  $attachments['#attached']['library'][] = 'user_guide_tests/screenshot_disable_transitions';
}

/**
 * Implements hook_update_status_alter().
 *
 * Getting data from drupal.org about updates can be unreliable. This hook
 * implementation makes sure that both Admin Toolbar and Mayo show up as needing
 * updates on the Available Updates report.
 */
function user_guide_tests_update_status_alter(&$projects) {
  $projects['admin_toolbar'] = [
    'title' => 'Admin Toolbar',
    'link' => 'https://www.drupal.org/project/admin_toolbar',
    'project_type' => 'module',
    'recommended' => '8.x-1.26',
    'existing_major' => 1,
    'existing_version' => '8.x-1.25',
    'status' => UpdateManagerInterface::NOT_CURRENT,
    'releases' => [
      '8.x-1.26' => [
        'version' => '8.x-1.26',
        'version_major' => 1,
        'release_link' => 'https://www.drupal.org/project/admin_toolbar/releases/8.x-1.26',
        'download_link' => 'https://www.drupal.org/project/admin_toolbar/releases/8.x-1.26',
      ],
    ],
  ];

  $projects['mayo'] = [
    'title' => 'Mayo',
    'link' => 'https://www.drupal.org/project/mayo',
    'project_type' => 'theme',
    'recommended' => '8.x-1.3',
    'existing_major' => 1,
    'existing_version' => '8.x-1.3',
    'status' => UpdateManagerInterface::NOT_CURRENT,
    'releases' => [
      '8.x-1.3' => [
        'version' => '8.x-1.3',
        'version_major' => 1,
        'release_link' => 'https://www.drupal.org/project/mayo/releases/8.x-1.3',
        'download_link' => 'https://www.drupal.org/project/admin_toolbar/releases/8.x-1.26',
      ],
    ],
  ];

}
