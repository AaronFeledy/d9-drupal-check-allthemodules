<?php

use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormState;
use Drupal\state_machine\Form\StateTransitionForm;
use Drupal\views\ViewExecutable;

/**
 * Implements hook_views_pre_render().
 */
function user_request_ui_views_pre_render(ViewExecutable $view) {
  $view_id = $view->storage->id();
  if ($view_id == 'user_request_received' || $view_id == 'user_request_sent') {
    // Adds the CSS.
    $view->element['#attached']['library'][] = 'user_request_ui/user_request_ui';
  }
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function user_request_ui_user_request_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {
  if ($view_mode == 'full') {
    // Adds the CSS.
    $build['#attached']['library'][] = 'user_request_ui/user_request_ui';

    // Adds the state transition form.
    $form_object = \Drupal::classResolver(StateTransitionForm::class);
    $form_object->setEntity($entity);
    $form_object->setFieldName('state');
    $form_state = new FormState();
    $form = \Drupal::formBuilder()->buildForm($form_object, $form_state);
    $build['state_transition_form'] = $form;
    $build['state_transition_form']['#weight'] = 999;
  }
}
