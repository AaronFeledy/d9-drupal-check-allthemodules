<?php

/**
 * @file
 * E-mail No-Reply module.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Render\BubbleableMetadata;

/**
 * Implements hook_form_FORM_ID_alter().
 */
function email_noreply_form_system_site_information_settings_alter(&$form, FormStateInterface $form_state) {
  $form['site_information']['site_mail']['#description'] = t("The default site
    e-mail address, used for sending notifications and in token replacements.
    (Use an address ending in your site's domain to help prevent this e-mail
    being flagged as spam.)");
  $form['site_information']['email_noreply_mail'] = array(
    '#type' => 'email',
    '#title' => t('No-Reply E-mail Address'),
    '#description' => t('Set this if you would like all email to come from a no-reply e-mail address.'),
    '#default_value' => \Drupal::config('email_noreply.settings')->get('email_noreply_mail'),
  );
  $form['#submit'][] = 'email_noreply_site_information_submit';
}

/**
 * Form validation handler for system_site_information_settings().
 */
function email_noreply_site_information_submit(&$form, FormStateInterface $form_state) {
  \Drupal::configFactory()->getEditable('email_noreply.settings')
      ->set('email_noreply_mail', $form_state->getValue('email_noreply_mail'))
      ->save();
}

/**
 * Implements hook_mail_alter().
 */
function email_noreply_mail_alter(array &$message) {
  $noreply = \Drupal::config('email_noreply.settings')->get('email_noreply_mail');
  // If we don't have a no-reply email address, or the from field isn't using
  // the site_mail e-mail address, do nothing.
  if (!$noreply || !isset($message['from']) || $message['from'] != \Drupal::config('system.site')->get('mail')) {
    return;
  }
  $message['from'] = $message['headers']['From'] = $message['headers']['Sender'] = $message['headers']['Return-Path'] = $noreply;
}

/**
 * Implements hook_token_info_alter().
 */
function email_noreply_token_info_alter(&$data) {
  $data['tokens']['site']['noreply-mail'] = array(
    'name' => t('No-reply E-mail ssAddress'),
    'description' => t("The site's no-reply e-mail address"),
  );
}

/**
 * Implements hook_tokens_alter().
 */
function email_noreply_tokens_alter(array &$replacements, array $context, BubbleableMetadata $bubbleable_metadata) {
  if ($context['type'] == 'site') {
    $replacements['[site:noreply-mail]'] = \Drupal::config('email_noreply.settings')->get('email_noreply_mail');
  }
}
