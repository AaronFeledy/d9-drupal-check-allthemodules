<?php

/**
 * @file
 * Module file.
 */

/**
 * Implements hook_theme().
 */
function customers_canvas_theme($existing, $type, $theme, $path) {
  return [
    'customers_canvas_builder' => [
      'template' => 'customers_canvas_builder',
      'variables' => [
        'owner' => NULL,
        'entity' => NULL,
        'finish_form' => NULL,
      ],
    ],
    'customers_canvas_multi_editor_builder' => [
      'template' => 'customers_canvas_multi_editor_builder',
      'variables' => [
        'owner' => NULL,
        'entity' => NULL,
        'finish_form' => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_page_attachments().
 */
function customers_canvas_page_attachments(array &$attachments) {
  $path = \Drupal::configFactory()->get('customers_canvas.settings')->get('builder_url');
  $current_path = \Drupal::service('path.current')->getPath();
  if (stripos($current_path, $path) === 1) {
    $api_key = \Drupal::configFactory()->get('customers_canvas.settings')->get('iframe_script');
    $builder_javscript = 'https://h.customerscanvas.com/Users/' . $api_key . '/SimplePolygraphy/Resources/SPEditor/Scripts/IFrame/IframeApi.js';
    // The Customer's Canvas JS file should have an "id" attribute.
    $attachments['#attached']['html_head'][] = [
      [
        '#type' => 'html_tag',
        '#tag' => 'script',
        '#attributes' => [
          'src' => $builder_javscript,
          'type' => 'text/javascript',
          'id' => 'CcIframeApiScript',
        ],
        '#suffix' => '</script>',
      ],
      'customers_canvas'
    ];
  }
}

/**
 * Implements hook_js_alter().
 */
function customers_canvas_js_alter(&$javascript, \Drupal\Core\Asset\AttachedAssetsInterface $assets) {
  // Force requirejs and the multi_editor js files after jquery as setting the
  // weights in the library definition is somehow getting overridden.
  if (!empty($javascript['core/assets/vendor/jquery/jquery.min.js'])) {
    $jquery_lib = $javascript['core/assets/vendor/jquery/jquery.min.js'];

    if (!empty($javascript['https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js'])) {
      $javascript['https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js']['weight'] = -1;
      $javascript['https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js']['group'] = $jquery_lib['group'] + 1;
    }
    if (!empty($javascript['modules/contrib/customers_canvas/js/customers_canvas_multi_editor.js'])) {
      $javascript['modules/contrib/customers_canvas/js/customers_canvas_multi_editor.js']['weight'] = 0;
      $javascript['modules/contrib/customers_canvas/js/customers_canvas_multi_editor.js']['group'] = $jquery_lib['group'] + 2;
    }
  }
}
