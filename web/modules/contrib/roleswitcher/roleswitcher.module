<?php

use Drupal\Core\Session\AccountProxyInterface;
use Drupal\user\UserInterface;

function roleswitcher_user_load(array $entities) {
  if (!empty($_SESSION['roleswitcher_roles'])) {
    /** @var AccountProxyInterface */
    $sessionUser = \Drupal::currentUser();
    if (!empty($entities[$sessionUser->id()])) {
      /** @var UserInterface $user */
      $user = $entities[$sessionUser->id()];

      // Clear current roles.
      foreach ($user->getRoles() as $rid) {
        if ($rid != 'roleswitcher') {
          $entities[$sessionUser->id()]->removeRole($rid);
        }
      }

      // Use roles stored into session as user roles.
      foreach ($_SESSION['roleswitcher_roles'] as $rid) {
        // Assign requested role.
        $entities[$sessionUser->id()]->addRole($rid);
      }


      $sessionUser->setAccount($entities[$sessionUser->id()]);
      drupal_set_message(print_r($sessionUser->getRoles(),1));
    }
  }
}