<?php

/**
 * @file
 * Cyrillic to Latin transliteration.
 */

use Drupal\Core\Entity\ContentEntityInterface;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_entity_insert().
 *
 * @throws \Drupal\Core\Entity\EntityStorageException
 */
function cyr2lat_entity_insert(EntityInterface $entity) {
  if ($entity instanceof ContentEntityInterface) {
    $config = \Drupal::config('cyr2lat.settings');
    if ($config->get('enabled')) {
      _cyr2lat_transliterate_node($entity);
    }
  }
}

/**
 * Implements hook_entity_update().
 *
 * @throws \Drupal\Core\Entity\EntityStorageException
 */
function cyr2lat_entity_update(EntityInterface $entity) {
  if ($entity instanceof ContentEntityInterface) {
    $config = \Drupal::config('cyr2lat.settings');
    if ($config->get('enabled')) {
      _cyr2lat_transliterate_node($entity);
    }
  }
}

/**
 * Transliterate cyrillic entity to latin.
 *
 * @param \Drupal\Core\Entity\ContentEntityInterface $entity
 *   Entity Object.
 *
 * @throws \Drupal\Core\Entity\EntityStorageException
 */
function _cyr2lat_transliterate_node(ContentEntityInterface $entity) {
  /** @var \Drupal\cyr2lat\Services\Cyr2LatTransliterator $transliterator */
  $transliterator = \Drupal::service('cyr2lat.transliterator');

  // Transliterate only if entity satisfies all conditions.
  if ($transliterator->isTransliterable($entity)) {
    $transliterator->transliterateEntity($entity);
  }
}

/**
 * Implements hook_transliteration_overrides_alter().
 */
function cyr2lat_transliteration_overrides_alter(&$overrides, $langcode) {

  // Get cyrillic language code.
  $config = \Drupal::config('cyr2lat.settings');
  $cyr_language = $config->get('cyrillic_language');

  if ($langcode == $cyr_language) {

    // Mapping characters.
    $overrides[1033] = 'Lj'; // "Љ"
    $overrides[1113] = 'lj'; // "љ"

    $overrides[1034] = 'Nj'; // "Њ"
    $overrides[1114] = 'nj'; // "њ"

    $overrides[1064] = 'S';  // "Ш"
    $overrides[1096] = 's';  // "ш"

    $overrides[1026] = 'Dj'; // "Ђ"
    $overrides[1106] = 'dj'; // "ђ"

    $overrides[1046] = 'Z';  // "Ж"
    $overrides[1078] = 'z';  // "ж"

    $overrides[1061] = 'H';  // "Х"
    $overrides[1093] = 'h';  // "х"

    $overrides[1063] = 'C';  // "Ч"
    $overrides[1095] = 'c';  // "ч"

    $overrides[1039] = 'Dz'; // "Џ"
    $overrides[1119] = 'dz'; // "џ"
  }
}
