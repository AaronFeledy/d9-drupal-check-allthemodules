<?php
/**
 * @file
 * Primary module hooks for OWMS module.
 */

use Drupal\owms\Entity\OwmsData;
use Drupal\owms\OwmsManager;

/**
 * Implements hook_cron().
 */
function owms_cron() {
  $last_checked = \Drupal::state()->get('owms.last_checked', 0);
  $request_time = Drupal::time()->getRequestTime();
  if ($request_time > $last_checked + OwmsManager::OWMS_CHECK_INTERVAL) {
    Drupal::state()->set('owms.last_checked', $request_time);
    /** @var \Drupal\owms\Entity\OwmsDataInterface[]  $owmsDataObjects*/
    $owmsDataObjects = OwmsData::loadMultiple();
    $owmsManager = Drupal::getContainer()->get('owms.manager');
    foreach ($owmsDataObjects as $owmsData) {
      try {
        $owmsManager->updateItems($owmsData);
      }
      catch (Exception $exception) {
        Drupal::logger('owms')->error('XML could not be processed');
      }
    }
  }
}

/**
 * Implements hook_field_formatter_info_alter().
 *
 * Make list_string formatters available to the owms field type.
 */
function owms_field_formatter_info_alter(array &$info) {
  foreach ($info as $key => $type) {
    if (in_array('list_string', $type['field_types'])) {
      $info[$key]['field_types'][] = 'owms_list_item';
    }
  }
}

/**
 * Implements hook_field_widget_info_alter().
 *
 * Make list_string widgets available to the owms field type.
 */
function owms_field_widget_info_alter(array &$info) {
  foreach ($info as $key => $type) {
    if (in_array('list_string', $type['field_types'])) {
      $info[$key]['field_types'][] = 'owms_list_item';
    }
  }
}
