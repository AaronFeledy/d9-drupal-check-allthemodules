<?php

/**
 * @file
 * Provides the main functionality of the module.
 */

/**
 * Implements hook_cron().
 */
function user_prune_cron() {
  $config = \Drupal::config('user_prune.settings');

  $cron_v = $config->get('delete_users_on_cron');
  if ($cron_v) {
    $selectr = list_of_user();
    $uids = [];

    foreach ($selectr as $row) {
      $uids[] = $row->uid;
    }

    user_delete_multiple($uids);
  }
}

/**
 * Preview button functionality.
 */
function preview_button_action($form, &$form_state) {
  $selectr = list_of_user();
  if ($selectr) {
    $uids = [];
    foreach ($selectr as $row) {
      $uids[] = $row->uid;
      drupal_set_message($row->uid . " " . $row->Name);
    }
  }
  else {
    drupal_set_message(t("No users fit the listed criterias."));
  }

}

/**
 * Building and running the sql command.
 */
function list_of_user() {
  $config = \Drupal::config('user_prune.settings');

  $values['user_prune_time_year'] = $config->get('year_select');
  $values['user_prune_time_month'] = $config->get('month_select');
  $values['user_prune_time_day'] = $config->get('day_select');
  $values['user_never_logged_in'] = $config->get('user_never_logged_in');
  $values['user_status'] = $config->get('user_status');
  $values['roles'] = $config->get('roles');
  $values['user_with_comment'] = $config->get('user_with_comment');

  // Filter on user created time.
  $logged_in_limit = time() - $values['user_prune_time_year'] - $values['user_prune_time_month'] - $values['user_prune_time_day'];
  $sql = 'SELECT u.uid AS uid, name AS Name, created AS Created, access AS Lastaccess, login AS Lastlogin, status AS Status FROM {users_field_data} u WHERE created < ' . $logged_in_limit;

  // Make sure not to include power users.
  $sql .= ' AND uid <> 0 AND uid <> 1';

  // Option to filter only never logged in users.
  if ($values['user_never_logged_in']) {
    $sql .= ' AND access = 0';
    $sql .= ' AND login  = 0';
  }
  else {
    $sql .= ' AND access < ' . $logged_in_limit;
    $sql .= ' AND login < ' . $logged_in_limit;
  }

  // Option to exclude users with comments.
  if ($values['user_with_comment'] == 1) {
    $sql .= ' AND u.uid NOT IN (SELECT c.uid FROM {comment_field_data} c)';
  }

  // Limit based on users active or blocked.
  switch ($values['user_status']) {
    case 'blocked':
      $sql .= ' AND status = 0';
      break;

    case 'active':
      $sql .= ' AND status = 1';
      break;
  }

  // Limit batches.
  $sql .= ' ORDER BY uid limit ' . $config->get('user_number_select');

  $connection = \Drupal::database();
  $query = $connection->query($sql);
  $selectr = $query->fetchAll();

  return $selectr;
}
