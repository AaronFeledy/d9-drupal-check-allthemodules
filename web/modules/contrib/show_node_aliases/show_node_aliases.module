<?php

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Database\Database;
use Drupal\Core\Url;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\node\NodeForm;

/**
 * @file
 * This is the main module file for Show Node Aliases module.
 */

/**
 * Implements hook_help().
 */
function show_node_aliases_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.show_node_aliases':
      $output = file_get_contents(drupal_get_path('module', 'show_node_aliases') . '/README.txt');
      return \Drupal::service('module_handler')->moduleExists('markdown') ? module_invoke('markdown', 'filter', 'process', 0, -1, $output) : '<pre>' . $output . '</pre>';
  }
}

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter().
 */
function show_node_aliases_field_widget_path_form_alter(&$element, FormStateInterface $form_state, $context) {
  $paths = [];
  $form_object = $form_state->getFormObject();
  if ($form_object instanceof NodeForm) {
    $node = $form_object->getEntity();
    $paths = show_node_aliases_get_paths('/node/' . $node->id());
  }

  if (!empty($paths)) {
    $rows = [];
    foreach ($paths as $path) {
      $row = [$path->alias, $path->langcode];
      if (\Drupal::currentUser()->hasPermission('administer url aliases')) {
        $uri_options = [
          'query' => ['destination' => 'node/' . $node->id() . '/edit'],
        ];
        $links['edit'] = [
          'title' => t('Edit'),
          'url' => Url::fromUri('internal:/admin/config/search/path/edit/' . $path->pid, $uri_options),
        ];
        $links['delete'] = [
          'title' => t('Delete'),
          'url' => Url::fromUri('internal:/admin/config/search/path/delete/' . $path->pid, $uri_options),
        ];
        $row[] = [
          'data' => [
            '#type' => 'operations',
            '#links' => $links,
          ],
        ];
      }
      $rows[] = $row;
    }

    $header = [t('Alias'), t('Language')];
    if (\Drupal::currentUser()->hasPermission('administer url aliases')) {
      $header[] = t('Operations');
    }

    $element['all_aliases'] = [
      'label' => [
        '#type' => 'html_tag',
        '#tag' => 'label',
        '#value' => t('Existing Aliases'),
      ],
      'table' => [
        '#theme' => 'table',
        '#header' => $header,
        '#rows' => $rows,
      ],
    ];
  }
}

/**
 * Get all aliases for a given Drupal $nid.
 */
function show_node_aliases_get_paths($internal) {

  $aliases = Database::getConnection()->select('url_alias')
    ->fields('url_alias')
    ->condition('source', $internal)
    ->execute()
    ->fetchAll();

  return $aliases;
}
