<?php

/**
 * @file
 * Add AMP validation for SVG files.
 */

use Drupal\file\FileInterface;
use Drupal\Component\Utility\Html;

/**
 * Implements hook_file_validate().
 */
function amp_validator_svg_file_validate(FileInterface $file) {
  $errors = [];
  if ($file->getMimeType() == 'image/svg+xml' &&
    $svgFile = file_get_contents($file->getFileUri())) {

    $config = \Drupal::config('amp_validator_svg.settings');
    $warnOnly = $config->get('warn_only');

    $svgDom = Html::load($svgFile);
    $svgImage = $svgDom->saveHTML($svgDom->getElementsByTagName('svg')->item(0));

    $ampTest = [
      '#theme' => 'amp_validator_basic',
      '#validate' => $svgImage,
    ];
    $ampHtml = \Drupal::service('renderer')->render($ampTest);

    $ampFile = \Drupal::service('file_system')
      ->realpath(file_unmanaged_save_data($ampHtml));

    $ampValidator = \Drupal::service('amp_validator.file');
    $ampValidator->setFile($ampFile);
    $ampValidator->validate();

    if (!$ampValidator->isValid()) {
      $errors[] = t('Uploaded SVG file is not AMP valid! You can try the following tool to make the SVG file AMP valid: <a href="@svgo_web_app" target="_blank">SVGO Web App</a>', ['@svgo_web_app' => 'https://jakearchibald.github.io/svgomg/']);
      foreach ($ampValidator->getErrors() as $error) {
        $errors[] = $error['code'] . ': ' . $error['info'];
      }

      if ($warnOnly == TRUE) {
        $messenger = \Drupal::messenger();
        foreach ($errors as $error) {
          $messenger->addWarning($error);
        }
        $errors = [];
      }
    }
    file_unmanaged_delete($ampFile);
  }
  return $errors;
}
