<?php
/**
 * @file Views CSS module.
 */


/**
 * Implements hook_theme().
 */
function viewscss_theme($existing, $type, $theme, $path) {
  return [
    'viewscss_dummy' => [
      'variables' => [
        'children' => '',
        'view' => NULL,
      ],
    ],
  ];
}

/**
 * Prepare variables.
 */
function template_preprocess_viewscss_dummy(&$variables) {
  /** @var \Drupal\views\ViewExecutable $view */
  $view = $variables['view'];
  $viewIdentifier = $view->id() . '__' . $view->current_display;

  $rawCss = trim(strip_tags((string)$variables['children']));
  $sanitizedCss = \Drupal\viewscss\CssSanitizer::sanitize($rawCss, $errors, $viewIdentifier);
  if ($errors) {
    \Drupal::logger('viewscss')
      ->error(sprintf('Errors:<pre>%s</pre>', implode("\n", $errors)));
  }
  else {
    // We only do this when there are no errors.
    // Workaround https://www.drupal.org/project/drupal/issues/2391025
    $variables['#attached']['html_head'][] = [[
      '#tag' => 'style',
      '#value' => $sanitizedCss,
    ], "viewscss_$viewIdentifier"];
  }
}
