<?php

/**
 * @file
 * Core functions for the Linklay module.
 */

use Drupal\Core\Entity\ContentEntityInterface;

function linklay_token_info() {

  $types['linklay'] = [
    'name' => t('Linklay'),
    'description' => t('Token related to Linklay shoppable images.')
  ];

  $token['image'] = [
    'name' => t('Image'),
    'description' => t('The Linklay image to be rendered.'),
  ];

  return [
    'types' => $types,
    'tokens' => ['linklay' => $token],
  ];

}

function linklay_tokens( $type, $tokens, array $data, array $options, \Drupal\Core\Render\BubbleableMetadata $bubbleable_metadata ) {
  $replacements = array();
  if ($type === 'linklay') {
    foreach ($tokens as $name => $original) {
      if (strpos($name, 'image:') === 0) {
        $token_def = explode(';', substr($name, 6) );
        $output = linklayembed_output($token_def);
        if (!empty($output)) {
           $replacements[$original] = \Drupal\Core\Render\Markup::create( $output );
        }
        else {
          $replacements[$original] = NULL;
        }
      }
    }
  }
  return $replacements;
}

/**
 * Returns shoppable image wrapped in context.
 */
function linklayembed_output($token_def) {
  // validate argument.
  if (!is_array($token_def)) {
    return '';
  }
  $content = array_shift($token_def); // the image hash.
  if ($content === NULL) {
    return NULL;
  }
  else {
    // endpoints
    $image = "https://images.linklay.com/" . $content;
    $linklay = "https://assets.linklay.com/embed_cloud.html?uuid_hash=" . $content;
    $base_url = "https://linklay.com/app/";
    $script_src = "https://assets.linklay.com/responsive.js";
    $token = array();
    foreach ($token_def as $value) {
      str_replace(' ', '', $value);
      $def = explode(":", $value);
      $token[$def[0]] = $def[1];
    }
  }
  if ($imgsize = linklayembed_imgsize($image)) {
    list($imgwidth, $imgheight) = $imgsize;
  }
  else {
    $imgwidth = $imgheight = 0;
  }
  $align = empty($token['align']) ? NULL : 'text-align:' . $token['align'] .';';
  $class = empty($token['class']) ? NULL : 'class="' . $token['class'] .'"';
  $markup = <<<EOD
    <div {$class}style="{$align}margin:0px; padding:0px; flex: 1 1 0%; position:relative;">
      <iframe width="{$imgwidth}" height="{$imgheight}" style="overflow:hidden;margin-top:-0px;" src="{$linklay}&base_url={$base_url}" allowtransparency="true" frameborder="0">
      </iframe>
      <script src="{$script_src}" onerror="javascript:var el = this.parentElement; el.innerHTML=''; var imgEl = document.createElement( 'img' ); imgEl.src='{$image}'; imgEl.style.width='100%'; imgEl.style.maxWidth='{$imgwidth}px'; el.appendChild( imgEl );window.dispatchEvent(new Event('resize'));" >
      </script>
    </div>
EOD;
  if ($class) {
    $markup = '<div ' . $class . '>' . $markup . '</div>';
  }
  return $markup;
}

/**
 * Computes remote image size if available.
 */
function linklayembed_imgsize($image) {
  if(ini_get('allow_url_fopen')) {
    return @getimagesize($image);
  } else {
    return NULL;
  }
}