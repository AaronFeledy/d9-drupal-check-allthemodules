<?php
/**
 * Implements hook_help()
 */

function seoredirect_help($path, $arg)
{
    switch ($path) {
        case "admin/help#iaseo":
            $content = t('<p>This module will help you to resolve below SEO recommendations:</p>
                        <ol>
                                <li>Remove Trailing Slash</li>
                                <li>Convert URL to lower case</li>
                                <li>Remove index.php from URL.</li>
                        </ol>');
            return $content;
            break;
    }
}
/**
 * hook_menu to access form to import SEO 301/302 redirections
 */

function seoredirect_menu()
{
    $items = array();
    
    $items['admin/config/search/seoredirect'] = array( 
        'title' => 'SEO 301 Redirection',
        'description' => 'Use this form setting to apply SEO Recommendations.',
        'page callback' => 'drupal_get_form', 
        'page arguments' => array(
            'seoredirect_form'
        ), 
        'access callback' => 'user_access',
        'access arguments' => array(
            'administer users'
        ),
        'file' => 'seoredirect.admin.inc'
    );
    
    return $items;
}

/**
 * Implements hook_init().
 */
function seoredirect_init()
{
    global $base_url;
    $protocol   = stripos($_SERVER['SERVER_PROTOCOL'], 'https') === true ? 'https://' : 'http://';
    $currentUrl = $protocol . $_SERVER['HTTP_HOST'] . $_SERVER['REQUEST_URI'];
    
    $exceptionStrings = array(
        "/admin/",
        "/ajax/",
        "sites/default/files/"
    );
    $url_exception    = variable_get('url_exception');
    if (trim($url_exception) != "") {
        $stringUrls = explode("\r\n", $url_exception);
        foreach ($stringUrls as $value) {
            $chkVal = trim(drupal_html_to_text($value));
            if (!in_array($chkVal, $exceptionStrings)) {
                $exceptionStrings[] = $chkVal;
            }
        }
    }
    $flag = 1; //URL flag to convert lower case
    foreach ($exceptionStrings as $value) {
        if (stristr($currentUrl, $value)) {
            $flag = 0; //URL will not converted to lower case
            break;
        }
    }
    
    if ($flag) {
        $settings = variable_get('seosettings');
        //remove trailing slash
        if (substr($currentUrl, -1) == '/' && ($currentUrl != $base_url . '/') && isset($settings["trailingslash"])) {
            if ($settings["trailingslash"]) {
                if ($settings["urllower"]) {
                    seoredirect_redirect_page(rtrim(strtolower($currentUrl), '/'));
                } else {
                    seoredirect_redirect_page(rtrim($currentUrl, '/'));
                }
            }
        }
        //remove index.php
        else if ($currentUrl == $base_url . '/index.php' && isset($settings["removeindex"])) {
            if ($settings["removeindex"])
                seoredirect_redirect_page($base_url);
        }
        //convert URLs to lower case URL
        else if ($currentUrl != strtolower($currentUrl)) {
            if ($settings["urllower"])
                seoredirect_redirect_page(strtolower($currentUrl));
        }
    }
    
}

/**
 * 301 redirect page using drupal_goto
 */
function seoredirect_redirect_page($path, $statuscode = 301)
{
    $options = array();
    drupal_goto($path, $options, $statuscode);
    exit;
}