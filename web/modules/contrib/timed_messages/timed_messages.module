<?php

/**
 * @file
 * Contains timed_messages.module..
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function timed_messages_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the timed_messages module.
    case 'help.page.timed_messages':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('My Awesome Module') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_page_attachments().
 *
 * Adds the timed.messages library to the page if a message is set.
 *
 */
function timed_messages_page_attachments(array &$page) {
  // Load the configuration for timed messages.
  $config = \Drupal::config('timed_messages.settings');

  // Show some test messages if enabled in the config.
  if($config->get('always_testing')) {
    drupal_set_message('Man-of-war bring a spring upon her cable sloop prow ho lateen sail brig starboard coffer heave down.');
    drupal_set_message('Doubloon Spanish Main gangplank Nelsons folly to go on account rigging red ensign run a shot across the bow Barbary Coast keel. ', 'warning');
    drupal_set_message('Hail-shot schooner pirate gun driver Barbary Coast aft code of conduct hulk pinnace.', 'error');
    drupal_set_message('Square-rigged cog scuppers no prey, no pay barque aft rigging parley loot black jack. ');
    drupal_set_message('Heave down splice the main brace topgallant pirate doubloon squiffy parrel piracy cable six pounders.', 'warning');
    drupal_set_message('Black spot Gold Road barque fore bounty belaying pin tack heave down draft list.', 'error');
  }

  // Do nothing if no messages are set.
  if (empty($_SESSION['messages'])) {
    return;
  }

  // Otherwise attach the timed messages library and pass the settings.
  $page['#attached']['library'][] = 'timed_messages/timed_messages';
  $page['#attached']['drupalSettings']['timed_messages']['message_class'] = $config->get('message_class');
  $messageTypes = \Drupal\timed_messages\Form\TimedMessagesForm::availableMessageTypes();

  foreach($messageTypes as $key => $messageType) {
    $page['#attached']['drupalSettings']['timed_messages'][$key.'_type'] = $config->get($key);
    $page['#attached']['drupalSettings']['timed_messages'][$key.'_hide'] = $config->get($key.'_hide');
    $page['#attached']['drupalSettings']['timed_messages'][$key.'_time'] = $config->get($key.'_time');
    $page['#attached']['drupalSettings']['timed_messages'][$key.'_class'] = $config->get($key.'_class');
  }
}
