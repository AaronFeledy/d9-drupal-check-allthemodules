<?php

/**
 * @file
 * Update form fields newsletter.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_help().
 */
function simplenews_advance_help($path, $arg) {
  switch ($path) {
    case 'admin/help#simplenews_advance':
      return '<p>' . t('In the help of simplenews letter advance plugins user can manage our Newsletter subscription on account configure time and user registration page.') . '</p>';
  }
}

/**
 * Implements hook_form_alter().
 */
function simplenews_advance_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $default_value = [];
  $user = \Drupal::currentUser();
  // Update user subscription on user profile page.
  if ($form_id == 'user_form') {
    // Remove existing subscriptions fieldset.
    $form['subscriptions']['#access'] = FALSE;

    // Check login user session.
    if (!empty($user->id())) {
      // Load all subscription for logged in user.
      $subscriber = simplenews_subscriber_load_by_mail($user->getEmail());
    }
    // Get all newsletters from CMS.
    foreach (simplenews_newsletter_get_visible() as $newsletter) {
      $options[$newsletter->id] = $newsletter->name;
    }
    // Get subscribed newsletter for logged in user.
    if (!empty($subscriber)) {
      foreach ($subscriber->get('subscriptions')->getValue() as $value) {
        if (!empty($value['status'])) {
          $default_value[] = $value['target_id'];
        }
      }
    }
    // Attach fields on user form.
    if (count($options)) {
      // @todo Change this text: use less words;
      $form['simplenews_subscriptions'] = [
        '#type' => 'fieldset',
        '#title' => t('NEWSLETTER SUBSCRIPTIONS'),
        '#description' => t('Select the newsletter(s) to which you wish to subscribe.'),
        '#weight' => 50,
        '#collapsible' => TRUE,
        '#collapsed' => FALSE,
      ];
      $form['simplenews_subscriptions']['newsletters'] = [
        '#type' => 'checkboxes',
        '#options' => $options,
        '#default_value' => $default_value,
      ];
    }
    if (count($options)) {
      $form['simplenews_hidden'] = [
        '#type' => 'hidden',
        '#value' => implode(',', $options),
      ];
    }
    // Attach new submit handler in user form.
    $form['actions']['submit']['#submit'][] = 'simplenews_advance_update_subscriptions';
  }
  // Subscribe newsletter on user registration page.
  if ($form_id == 'user_register_form') {
    if (isset($form['simplenews'])) {
      $form['simplenews']['#title'] = t('NEWSLETTER SUBSCRIPTIONS');
      $form['simplenews']['#collapsible'] = TRUE;
      $form['simplenews']['#collapsed'] = FALSE;
    }
  }
}

/**
 * Add custom submit callback to update user subscription.
 */
function simplenews_advance_update_subscriptions($form, FormStateInterface $form_state) {
  // Load Drupal service.
  $subscription_manager = \Drupal::service('simplenews.subscription_manager');
  $user = \Drupal::currentUser();

  foreach ($form_state->getValues()['newsletters'] as $key => $val) {
    // Load all subscribed newsletter by user.
    if (!empty($val)) {
      // Subscribe newsletter.
      $subscription_manager->subscribe($user->getEmail(), $key, FALSE);
    }
    else {
      // Unsubscribe newsletter.
      $subscription_manager->unsubscribe($user->getEmail(), $key, FALSE);
    }
  }
}
