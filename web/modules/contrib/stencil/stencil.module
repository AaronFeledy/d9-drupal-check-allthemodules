<?php

/**
 * Implements hook_page_attachments().
 */
function stencil_page_attachments(array &$attachments) {
  $attachments['#attached']['library'][] = 'stencil/loader';
}

/**
 * Implements hook_library_info_alter().
 */
function stencil_library_info_alter(&$libraries, $extension) {
  if ($extension === 'stencil') {
    /** @var \Drupal\stencil\Asset\StencilDiscovery $stencil_discovery */
    $stencil_discovery = \Drupal::service('stencil.discovery');
    /** @var string $root */
    $root = \Drupal::service('app.root');
    foreach ($stencil_discovery->getRegistries() as $registry) {
      $registry->root = str_replace($root, '', $registry->root) . '/';
      $libraries['loader']['drupalSettings']['stencilRegistries'][] = $registry;
    }
  }
}
