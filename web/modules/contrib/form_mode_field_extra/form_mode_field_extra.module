<?php

/**
 * Implements hook_element_info_alter().
 */
function form_mode_field_extra_element_info_alter(array &$types) {
  foreach ($types as $type => $info) {
    $types[$type]['#after_build'][] = '_form_mode_field_extra_fields_element_after_build';
  }
}

function _form_mode_field_extra_fields_element_after_build($element, &$form_state) {
  if (!isset($element['#title']) && !isset($element['widget']['#title'])) {
    return $element;
  }
  if (!isset($element['#field_name']) && !isset($element['widget']['#field_name'])) {
    return $element;
  }

  if (isset($element['widget']['#title'])) {
    $field = $element['widget'];
  } else {
    $field = $element;
  }
  $field_name = $field['#field_name'];
  if(isset($form_state->getStorage()['form_display'])){
    $form_mode = $form_state->getStorage()['form_display']->getMode();
    $components = $form_state->getStorage()['form_display']->getComponent($field_name);

    if (empty($components['third_party_settings']['form_mode_field_extra'])) {
      return $element;
    }
    $form_mode_field_extra = $components['third_party_settings']['form_mode_field_extra'];
    $element['#prefix'] = $form_mode_field_extra['wrapper_prefix'];
    $element['#suffix'] = $form_mode_field_extra['wrapper_suffix'];
    $element['#attributes']['class'][] = $form_mode_field_extra['extra_class'];

  }
  return $element;
}

/**
 * Implements hook_field_widget_settings_summary_alter().
 */
function form_mode_field_extra_field_widget_settings_summary_alter(&$summary, $context){
  $wrapper_prefix = $context['widget']->getThirdPartySetting('form_mode_field_extra', 'wrapper_prefix');
  $wrapper_suffix = $context['widget']->getThirdPartySetting('form_mode_field_extra', 'wrapper_suffix');
  $extra_class = $context['widget']->getThirdPartySetting('form_mode_field_extra', 'extra_class');

  $summary_items = array();

  if ($wrapper_prefix) {
    $summary_items[] = t('Prefix: @wrapper_prefix', array('@wrapper_prefix' => $wrapper_prefix));
  }
  if ($wrapper_suffix) {
    $summary_items[] = t('Suffix: @wrapper_suffix', array('@wrapper_suffix' => $wrapper_suffix));
  }
  if ($extra_class) {
    $summary_items[] = t('Extra Class: @extra_class', array('@extra_class' => $extra_class));
  }
  if (!empty($summary_items)) {
    $item_list = array(
      '#theme' => 'item_list',
      '#items' => $summary_items,
      '#title' => '',
    );
    $summary[] = render($item_list);
  }
}

/**
 * Implements hook_field_widget_third_party_settings_form().
 *
 * Adds a 'class' textfield to all formatters.
 */
function form_mode_field_extra_field_widget_third_party_settings_form(\Drupal\Core\Field\WidgetInterface $plugin, \Drupal\Core\Field\FieldDefinitionInterface $field_definition, $form_mode, $form, \Drupal\Core\Form\FormStateInterface $form_state) {
  $element['wrapper_prefix'] = array(
      '#type'           => 'textfield',
      '#title'          => t('Prefix'),
      '#description'    => t('Prefix will display before the widget.'),
      '#default_value'  => $plugin->getThirdPartySetting('form_mode_field_extra', 'wrapper_prefix'),
  );
  $element['wrapper_suffix'] = array(
      '#type'           => 'textfield',
      '#title'          => t('Suffix'),
      '#description'    => t('Suffix will display after the widget.'),
      '#default_value'  => $plugin->getThirdPartySetting('form_mode_field_extra', 'wrapper_suffix'),
  );
  $element['extra_class'] = array(
      '#type'           => 'textfield',
      '#title'          => t('Extra Class'),
      '#description'    => t('Extra Class will be added to the widget.'),
      '#default_value'  => $plugin->getThirdPartySetting('form_mode_field_extra', 'extra_class'),
  );
  return $element;
}
