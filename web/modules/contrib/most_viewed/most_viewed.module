<?php
/**
 * @file
 * Main module file.
 */

define('MOST_VIEWED_MODULE_PATH', drupal_get_path('module', 'most_viewed'));

use Drupal\Core\Url;
use Drupal\Core\Database\Database;

/**
 * Implements hook_page_bottom().
 */
function most_viewed_page_bottom(&$page_bottom) {
  $send_data = [];
  $path = \Drupal::request()->getpathInfo();
  $args = explode('/', ltrim($path, '/'));

  if ($node = \Drupal::request()->attributes->get('node')) {
    $node_config = \Drupal::config('most_viewed.settings')->get('most_viewed_node_types');
    $node_config = array_filter($node_config);
    if (empty($node_config)) {
      return;
    }

    if (in_array($node->getType(), $node_config) && (!$args[2] || $args[2] == 'view')) {
      $send_data = [
        'entity_type' => 'node',
        'bundle' => $node->getType(),
        'entity_id' => $node->id(),
      ];
    }
  }
  elseif ($term = \Drupal::request()->attributes->get('taxonomy_term')) {
    $term_config = \Drupal::config('most_viewed.settings')->get('most_viewed_taxonomy_term_types');
    $term_config = array_filter($term_config);
    if (empty($term_config)) {
      return;
    }

    if (in_array($term->Bundle(), $term_config) && (!$args[3])) {
      $send_data = array(
        'entity_type' => 'taxonomy_term',
        'bundle' => $term->Bundle(),
        'entity_id' => $term->id(),
      );
    }
  }
  elseif ($user = \Drupal::request()->attributes->get('user')) {
    $user_config = \Drupal::config('most_viewed.settings')->get('most_viewed_user_types');
    $user_config = array_filter($user_config);
    if (empty($user_config)) {
      return;
    }

    if (in_array($user->Bundle(), $user_config) && (!$args[2] || $args[2] == 'view')) {
      $send_data = array(
        'entity_type' => 'user',
        'bundle' => $user->Bundle(),
        'entity_id' => $user->id(),
      );
    }
  }
  else {
    return;
  }

  if (!empty($send_data)) {
    // @todo change to fromRoute(
    $url = Url::fromUserInput('/most-viewed/stat', ['query' => $send_data]);
    $url->setAbsolute(TRUE);
    $page_bottom['most_viewed']['#markup'] = '<img style="position: fixed;" src="'
      . $url->toString() . '" width="1" height="1" />';
  }
}

/**
 * Implements hook_cron().
 */
function most_viewed_cron() {
  $lifetime = \Drupal::config('most_viewed.settings')->get('most_viewed_hits_max_life_time');
  if (empty($lifetime) || !is_numeric($lifetime)) {
    $lifetime = 30;
  }
  $lifetime *= 86400;

  // Clean up expired hits.
  Database::getConnection()->delete('most_viewed_hits')
    ->condition('created', REQUEST_TIME - $lifetime, '<')
    ->execute();
}
