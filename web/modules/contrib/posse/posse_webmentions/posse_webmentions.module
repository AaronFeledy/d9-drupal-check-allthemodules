<?php

use Drupal\Core\Url;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;

/**
 * Implements hook_page_attachments().
 */
function posse_webmentions_page_attachments(&$page) {
  $config = \Drupal::service('config.factory')->get('posse.webmention');

  if ($config->get('status')) {
    $accounts = $config->get('accounts');
    $networks = explode(',', $accounts);
    foreach($networks as $delta => $url) {
      $page['#attached']['html_head'][] = [
        [
          '#tag' => 'link',
          '#attributes' => [
            'href' => trim($url),
            'rel' => 'me'
          ],
        ],
        "posse_webmentions_{$delta}"
      ];
    }

    $webmention_user = $config->get('webmention_user');
    $domain = (!empty($_SERVER['HTTPS'])) ? "https://".$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'] : "http://".$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'];
    $page['#attached']['html_head'][] = [
      [
        '#tag' => 'link',
        '#attributes' => [
          'href' => "https://webmention.io/webmention?forward=" . $domain,
          'rel' => 'pingback'
        ],
      ],
      "posse_webmentions_pingback"
    ];

    $page['#attached']['html_head'][] = [
      [
        '#tag' => 'link',
        '#attributes' => [
          'href' => "https://webmention.io/{$webmention_user}/webmention",
          'rel' => 'webmention'
        ],
      ],
      "posse_webmentions_webmention"
    ];

  }
}

/**
* Implements hook_theme
*/
function posse_webmentions_theme($existing, $type, $theme, $path) {
  return [
    'webmentions_counter' => [
      'variables' => [ 'url' => NULL ],
      'template' => 'posse_webmentions_counter'
    ]
  ];
}

/**
* Implements hook_entity_view_alter
*/
function posse_webmentions_entity_view_alter(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display){
  $build['#attached']['library'][] = 'posse_webmentions/webmentionsio';
  $url = (!empty($_SERVER['HTTPS'])) ? "https://".$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'] : "http://".$_SERVER['SERVER_NAME'].$_SERVER['REQUEST_URI'];
  $build['mentions'] = [
    '#theme' => 'webmentions_counter',
    '#url' => $url,
  ];
}
