<?php

/**
 * @file
 * The server notice module.
 */

use Drupal\server_notice\Entity\ServerNotice;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function server_notice_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.server_notice':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('This module provides a visual cue to let users know which server they are on. This is implemented through a coloured border around the viewport, and additional text if desired.') . '</p>';
      $output .= '<h3>' . t('Uses') . '</h3>';
      $output .= '<dt>' . t('Creating Server Notices') . '</dt>';
      $output .= '<dd>' . t('<em>Server Notices</em> can be created by clicking <em>Add Server Notice</em> on the <a href=":paragraphs">Server Notice page</a>. FQDN and Colour are both required fields.', [':paragraphs' => Url::fromRoute('entity.server_notice.collection')->toString()]) . '</dd>';
      $output .= '<dt>' . t('Editing/Deleting Server Notices') . '</dt>';
      $output .= '<dd>' . t('<em>Server Notices</em> can be edited or deleted by visiting the <a href=":paragraphs">Server Notice page</a> and selecting the appropriate option from the dropdown menu located beside the Server Notice you wish to edit or delete.', [':paragraphs' => Url::fromRoute('entity.server_notice.collection')->toString()]) . '</dd>';
      $output .= '<p>' . t('For more information, visit the module page at: <a href="https://www.drupal.org/project/server_notice">https://www.drupal.org/project/server_notice</a>') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_page_attachments().
 */
function server_notice_page_attachments(array &$page) {

  if (\Drupal::currentUser()->hasPermission('view server_notices')) {
    $host = \Drupal::request()->getHost();
    $server_notice_entity_array = ServerNotice::loadMultiple(NULL);
    $active_server_notice = NULL;

    foreach ($server_notice_entity_array as $server_notice) {
      $fqdn = $server_notice->get('fqdn')->value;
      if ($host == $fqdn) {
        $active_server_notice = $server_notice;
      }
    }

    if ($active_server_notice !== NULL) {
      $page['#attached']['library'][] = 'server_notice/server_notice';
      $page['#attached']['drupalSettings']['servernotice']['colour'] = $active_server_notice->get('colour')->color;
      if (!$active_server_notice->get('notice')->isEmpty()) {
        $page['#attached']['drupalSettings']['servernotice']['notice'] = $active_server_notice->get('notice')->value;
      }
    }
  }
}
