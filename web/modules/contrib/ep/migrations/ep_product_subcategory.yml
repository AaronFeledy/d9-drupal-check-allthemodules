# This migration uses the source URL using the Elastic Path Cortex API.
id: ep_product_subcategory
label: Migrate Elastic Path sub-categories to taxonomy terms.
status: true
migration_tags:
  - Elastic Path
  - Elastic Path Content
idMap:
  plugin: ep_sync
migration_group: ep
source:
  plugin: url
  data_fetcher_plugin: http
  data_parser_plugin: jsonpath
  authentication:
    plugin: oauth2
    base_uri: '!cortex_url'
    token_url: /cortex/oauth2/tokens
    username: '!cortex_username'
    password: '!cortex_password'
    scope: '!cortex_store'
    grant_type: password
    client_id: ep_drupal
    role: REGISTERED
  headers:
    Accept: 'application/json; charset=utf-8'
    Content-Type: 'application/x-www-form-urlencoded'
    x-api-key: '!aws_api_key'
    x-amzn-apigateway-api-id: '!aws_api_id'
  urls:
    - '!cortex_url/cortex/navigations/!cortex_store?zoom=element,element:child,element:child:child,element:child:child:child,element:child:child:child:child'
  item_selector: '$.._child[*]'
  fields:
    -
      name: name
      label: 'Category Machine name'
      selector: name
    -
      name: display_name
      label: 'Category display name'
      selector: '"display-name"'
    -
      name: self_uri
      label: 'Category Json information object.'
      selector: self.uri
    -
      name: parent_uri
      label: 'Category parent Json information object.'
      selector: links[0].uri
  ids:
    self_uri:
      type: string
  constants:
    vocabulary: category
process:
  vid: constants/vocabulary
  name: display_name
  description: name
  parent_id:
    -
      plugin: skip_on_empty
      method: process
      source: parent_uri
    -
      plugin: migration_lookup
      migration:
        - ep_product_category
        - ep_product_subcategory
      source: parent_uri
  parent:
    plugin: default_value
    default_value: 0
    source: '@parent_id'
destination:
  plugin: entity:taxonomy_term
migration_dependencies:
  required:
    - ep_product_category
dependencies:
  enforced:
    module:
      - ep
