<?php

/**
 * @file
 * Contains dialect.module..
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function dialect_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the dialect module.
    case 'help.page.dialect':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Provides tools for dealing with the language switcher, like custom template or language fallback to a single node.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_theme().
 */
function dialect_theme($existing, $type, $theme, $path) {
  return [
    'dialect' => [
      'render element' => 'elements',
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_HOOK().
 *
 * Adds suggestion per instance id.
 */
function dialect_theme_suggestions_dialect(array $variables) {
  $suggestions = [];
  // Adding suggestions for each block instance.
  $instanceIds = \Drupal::service('dialect.manager')->getBlockInstanceIds();
  foreach ($instanceIds as $id) {
    // Hyphens (-) and underscores (_) play a special role in theme suggestions.
    // Theme suggestions should only contain underscores, because within
    // drupal_find_theme_templates(), underscores are converted to hyphens to
    // match template file names, and then converted back to underscores
    // to match pre-processing and other function names.
    // So if your theme suggestion contains a hyphen, it will end up as an
    // underscore after this conversion, and your function names won't be
    // recognized. So, we need to convert hyphens to underscores in block
    // deltas for the theme suggestions.
    $suggestions[] = 'dialect__' . strtr($id, '-', '_');
  }
  return $suggestions;
}

/**
 * Prepares variables for dialect templates.
 *
 * Default template: dialect.html.twig.
 *
 * Prepares the values passed to the theme_dialect function to be passed
 * into a pluggable template engine. Uses dialect properties to generate a
 * series of template file suggestions. If none are found, the default
 * dialect.html.twig is used.
 *
 * Most themes use their own copy of dialect.html.twig. The default is located
 * inside "dialect/templates/dialect.html.twig". Look in there for the
 * full list of available variables.
 *
 * @param array $variables
 *   An associative array containing:
 *   - elements: An associative array containing the properties of the element.
 *     Properties used: #current_language_id, #current_language_label,
 *     #default_languages, #has_fallback_languages, #fallback_languages.
 */
function template_preprocess_dialect(array &$variables) {
  $variables['current_language_id'] = $variables['elements']['#current_language_id'];
  $variables['current_language_label'] = $variables['elements']['#current_language_label'];
  $variables['default_languages'] = $variables['elements']['#default_languages'];
  $variables['has_fallback_languages'] = $variables['elements']['#has_fallback_languages'];
  $variables['fallback_languages'] = $variables['elements']['#fallback_languages'];
}
