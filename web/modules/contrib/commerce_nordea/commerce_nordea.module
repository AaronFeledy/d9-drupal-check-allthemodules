<?php

/**
 * Implements hook_cron().
 */
function commerce_nordea_cron()
{
  $last_run = \Drupal::state()->get('commerce_nordea.last_run', 0);

  // If 60 minutes passed since last time.
//  if ((\Drupal::time()->getRequestTime() - $last_run) > 3600) {
  // Do something.

  $query = \Drupal::entityQuery('commerce_order')
    ->condition('created', \Drupal::time()->getRequestTime() - 14400, '>=')//4hours
    ->condition('placed', '', 'IS NULL');

  $nids = $query->execute();

  $entity_type_manager = \Drupal::entityTypeManager();
  $order_type_storage = $entity_type_manager->getStorage('commerce_order');
  /** @var \Drupal\commerce_order\Entity\OrderInterface[] $orders */
  $orders = $order_type_storage->loadMultiple($nids);

  $orderHelper = new \Drupal\commerce_nordea\DependencyInjection\OrderHelper();

  foreach ($orders as $order) {
    $orderHelper->checkOrderStatus($order);
  }

  // Update last run.
  \Drupal::state()->set('commerce_nordea.last_run', \Drupal::time()->getRequestTime());
//  }
}

/**
 * Implements hook_form_alter().
 */
function commerce_nordea_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id)
{
  /**
   * Hook on order form alter on checkout page
   */
  if ($form_id === 'commerce_checkout_flow_multistep_default') {

    /**
     * @var \Drupal\commerce_checkout\Plugin\Commerce\CheckoutFlow\MultistepDefault $formObject
     */
    $formObject = $form_state->getFormObject();

    if ($formObject && $formObject->getOrder()) {

      $entity = $formObject->getOrder()->get('payment_gateway')->first()->entity;

      /**
       * Check payment method, apply modification just for nordea_payment module
       */
      if ($entity && $entity->get('plugin') === 'nordea_payment') {

        $buildInfo = $form_state->getBuildInfo();

        /**
         * Check step, apply modification just for last step - payment.
         */
        if (isset($buildInfo['args']) && in_array('payment', $buildInfo['args'])) {
          /**
           * Remove conflict fields from payment request data.
           */
          unset($form['form_build_id'], $form['form_token'], $form['form_id']);
        }

      }
    }

  }

}