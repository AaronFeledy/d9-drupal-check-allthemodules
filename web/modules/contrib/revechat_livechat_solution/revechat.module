<?php

/**
 * @file
 * REVE Chat is powerful and intuitive real-time customer engagement software.
 */

use Drupal\Component\Utility\Unicode;

/**
 * Pages that ReveChat by default will not be shown on.
 */
define('REVECHAT_VISIBILITY_DEFAULT_PAGES', "/admin\n/admin/*\n/node/add*\n/node/*/*\n/user/*/*\n");

/**
 * Attach REVE Chat widget in front end.
 */
function revechat_page_attachments(array &$attachments) {
  if (!revechat_check_visibility() || !revechat_is_installed()) {
    return;
  }
  $aid = \Drupal::configFactory()->getEditable('revechat.settings')->get('revechat.revechat_aid');
  $attachments['#attached']['library'][] = 'revechat/revechat.revechat';
  $attachments['#attached']['drupalSettings']['revechat']['revechat']['aid'] = $aid;
}

/**
 * Check if REVE Chat is installed.
 */
function revechat_is_installed() {
  $aid = \Drupal::configFactory()->getEditable('revechat.settings')->get('revechat.revechat_aid');
  if (!empty($aid)) {
    return TRUE;
  }
  return FALSE;
}

/**
 * Load admin script and js in backend.
 */
function revechat_preprocess_page(&$variables) {
  $variables['page']['#cache']['contexts'][] = 'route';
  if (\Drupal::routeMatch()->getRouteName() === 'revechat.revechat') {
    $variables['#attached']['library'][] = 'revechat/revechat.revechat_admin_assets';
    $variables['#attached']['library'][] = 'revechat/revechat.revechat_admin_assets';
  }
}

/**
 * Check if front end.
 */
function revechat_check_visibility($path = NULL) {
  // Default to the current path.
  if (!isset($path)) {
    $path = \Drupal::service('path.current')->getPath();
  }
  $pages = REVECHAT_VISIBILITY_DEFAULT_PAGES;
  $expanded_path = Unicode::strtolower(\Drupal::service('path.alias_manager')->getAliasByPath($path));
  $page_match = \Drupal::service('path.matcher')->matchPath($expanded_path, $pages);
  if ($expanded_path != $path) {
    $page_match = $page_match || drupal_match_path($path, $pages);
  }
  return !$page_match;
}
