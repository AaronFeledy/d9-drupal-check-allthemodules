services:
  http_middleware.prefetch_cache_before_page_cache:
    class: Drupal\prefetch_cache\StackMiddleware\PrefetchCacheBeforePageCache
    arguments: ['@cache.render', '@prefetch_cache_cache_tags_generator']
    tags:
      - { name: http_middleware, priority: 201}

  http_middleware.prefetch_cache_after_session_initialized:
    class: Drupal\prefetch_cache\StackMiddleware\PrefetchCacheAfterSessionInitialized
    arguments: ['@cache.render', '@prefetch_cache_request_policy', '@prefetch_cache_response_policy']
    tags:
      - { name: http_middleware, priority: 49, responder: true }

  prefetch_cache_cache_tags_generator:
    class: Drupal\prefetch_cache\Cache\ChainCacheTagsGenerator
    tags:
      - { name: service_collector, tag: prefetch_cache_cache_tags_generator, call: addGenerator}

  prefetch_cache_request_policy:
    class: Drupal\Core\PageCache\ChainRequestPolicy
    tags:
      - { name: service_collector, tag: prefetch_cache_request_policy, call: addPolicy}

  prefetch_cache_response_policy:
    class: Drupal\Core\PageCache\ChainResponsePolicy
    tags:
      - { name: service_collector, tag: prefetch_cache_response_policy, call: addPolicy}
    lazy: true

  prefetch_cache_get_request:
    class: Drupal\prefetch_cache\RequestPolicy\GetRequest
    tags:
      - { name: prefetch_cache_request_policy }

  prefetch_cache_no_session_user:
    class: Drupal\prefetch_cache\RequestPolicy\NoSessionUser
    tags:
      - { name: prefetch_cache_request_policy }

  prefetch_cache_kill_switch:
    class: Drupal\Core\PageCache\ResponsePolicy\KillSwitch
    tags:
      - { name: prefetch_cache_response_policy }

  prefetch_cache_no_server_error:
    class: Drupal\Core\PageCache\ResponsePolicy\NoServerError
    public: false
    tags:
      - { name: prefetch_cache_response_policy }

  prefetch_cache_set_cache_only_prefetch_cache_requests:
    class: Drupal\prefetch_cache\ResponsePolicy\CacheOnlyPrefetchCacheRequests
    tags:
      - { name: prefetch_cache_response_policy }
