<?php

/**
 * @file
 * Module to add Nativo ad support.
 */

use Drupal\Component\Utility\String;

/**
 * Implements hook_page_build().
 */
function nativo_page_build(&$page) {
  $config = \Drupal::config('nativo.settings');

  // Only load JS if that setting is enabled, and we're not on an admin page.
  if ($config->get('js_enabled') &&
    !preg_match($config->get('admin_path_pattern'), current_path())) {

  $script = <<< EOD
(function () {
var s = document.createElement('script');
s.type = 'text/javascript';
s.async = true;
s.src = 'http://a.postrelease.com/serve/load.js?async=true';
var x = document.getElementsByTagName('script')[0];
x.parentNode.insertBefore(s, x);
})();
EOD;
    $page['#attached']['js'][] = array('data' => $script, 'type' => 'inline');
  }
}

/**
 * Implements hook_preprocess_html().
 *
 * Because template_preprocess_html() runs the head_title through strip_tags(),
 * we must re-build head_title.
 */
function nativo_preprocess_html(&$variables) {
  // Get current page's title.
  $request = \Drupal::request();
  $route_match = \Drupal::routeMatch();
  $title = \Drupal::service('title_resolver')->getTitle($request, $route_match->getRouteObject());

  if  (_nativo_get_path() === current_path() && !empty($title)) {
    $site_name = \Drupal::config('system.site')->get('name');
    $head_title = array(
      'title' => $title,
      'name' => String::checkPlain($site_name),
    );
    $variables['head_title_array'] = $head_title;
    $variables['head_title'] = implode(' | ', $head_title);
  }
}

/**
 * Return the default path for Naitov ad page.
 */
function _nativo_get_path() {
  return 'promoted';
  //@todo Allow path name to be set by config and use that setting in router.
  //return \Drupal::config('nativo.settings')->get('path');
}
