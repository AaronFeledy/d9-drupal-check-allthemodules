<?php

/**
 * @file
 * Hook implementations and global functions for Sirv module.
 */

use Drupal\sirv\StreamWrapper\SirvStream;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function sirv_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the sirv module.
    case 'help.page.sirv':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Provides integration with the Sirv image service.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for form_field_config_edit_form.
 */
function sirv_form_field_config_edit_form_alter(&$form, $form_state, $form_id) {
  $form_object = $form_state->getFormObject();
  if (!$form_object) {
    return;
  }

  $field_config_entity = $form_object->getEntity();
  if (!$field_config_entity) {
    return;
  }

  // If this is an image field, add a field to enable integration with Sirv.
  if ($field_config_entity->getType() == 'image') {
    $entity = $form_object->getEntity();
    $form['third_party_settings']['sirv']['enable_sirv'] = [
      '#type' => 'checkbox',
      '#title' => t('Enable Sirv integration'),
      '#description' => t('Check to enable integration with Sirv for this field.'),
      '#default_value' => $entity->getThirdPartySetting('sirv', 'enable_sirv'),
    ];
  }
}

/**
 * Implements hook_field_widget_WIDGET_TYPE_form_alter().
 */
function sirv_field_widget_image_image_form_alter(&$elements, $form_state, $context) {
  if (isset($elements['#value_callback'])) {
    // Save the original value callback and replace it with Sirv's
    $elements['#original_value_callback'] = $elements['#value_callback'];
    $elements['#value_callback'] = [
      'Drupal\sirv\SirvFile',
      'value',
    ];
  }
}

/**
 * Implements hook_theme().
 */
function sirv_theme() {
  return [
    'sirv_image' => [
      'variables' => [
        'profile_name' => NULL,
        'uri' => NULL,
        'width' => NULL,
        'height' => NULL,
        'alt' => '',
        'title' => NULL,
        'attributes' => [],
      ],
      'file' => 'sirv.image.inc',
    ],
    'sirv_image_formatter' => [
      'variables' => [
        'item' => NULL,
        'item_attributes' => NULL,
        'url' => NULL,
        'sirv_profile' => NULL
      ],
      'file' => 'sirv.image.inc',
    ],
  ];
}
