<?php

/**
 * @file
 * It controls custom validation.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_FORM_ID_alter().
 */
function identification_form_user_login_form_alter(&$form, FormStateInterface $form_state) {
  array_unshift($form['#validate'], 'identification_user_login_validate');
}

/**
 * Form validation handler for user_login_form().
 */
function identification_user_login_validate(&$form, FormStateInterface $form_state) {
  $config = \Drupal::config('identification.settings');
  $field_name = $config->get('identification_field_name');
  if (empty($field_name)) {
    return;
  }
  $name = $form_state->getValue('name');
  $query = db_select('users_field_data', 'u')
      ->fields('u', array('name'))
      ->condition("fd.{$field_name}_value", $name);
  $query->join("user__$field_name", 'fd', 'u.uid = fd.entity_id');
  $result = $query->execute()->fetchObject();
  if (isset($result->name)) {
    $form_state->setValue('name', $result->name);
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function identification_form_user_form_alter(&$form, &$form_state, $form_id) {
  $form['#validate'][] = 'identification_userfield_validate';
}

/**
 * A validate handler on the User profile form.
 */
function identification_userfield_validate($form, FormStateInterface $form_state) {
  $field_name = \Drupal::config('identification.settings')->get('identification_field_name');
  // Check if the value available for field name and submitted entity values.
  if (!empty($field_name) && $form_state->hasValue($field_name)) {
    $values = $form_state->getValue($field_name);
    $account = $form_state->getFormObject()->getEntity();
    // If value already exists in database or not.
    $query = db_select('users_field_data', 'u')
      ->fields('u', array('name'))
      ->condition("u.uid", $account->id(), '!=')
      ->condition("fd.{$field_name}_value", $values[0]['value']);
    $query->join("user__$field_name", 'fd', 'u.uid = fd.entity_id');
    $result = $query->execute()->fetchObject();
    if (isset($result->name)) {
      $form_state->setErrorByName($field_name, t('The identification value already exists.'));
    }
  }
}
