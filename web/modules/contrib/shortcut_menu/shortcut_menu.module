<?php

/**
 * @file
 * shortcut_menu.module
 */

use Drupal\Core\Entity\EntityTypeInterface;
use Drupal\Core\Field\BaseFieldDefinition;
use Drupal\Component\Utility\NestedArray;
use Drupal\Core\Template\Attribute;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function shortcut_menu_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the admin_login_path module.
    case 'help.page.shortcut_menu':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('A simple module that adds the ability to nest shortcut links under others.') . '</p>';
      $output .= '<p>' . t('This creates menu like user experience that is familiar with other menus.') . '</p>';
      return $output;

    default:
      return '';
  }
}

/**
 * Implements hook_entity_base_field_info().
 */
function shortcut_menu_entity_base_field_info(EntityTypeInterface $entity_type) {
  $fields = [];
  if ($entity_type->id() == 'shortcut') {
    // Add a parent and a depth column to the shortcut table.
    $fields['parent'] = BaseFieldDefinition::create('integer')
      ->setLabel(t('Parent'))
      ->setDescription(t('Parent menu item.'))
      ->setDefaultValue(0);

    $fields['depth'] = BaseFieldDefinition::create('integer')
      ->setLabel(t('Depth'))
      ->setDescription(t('Depth within the menu.'))
      ->setDefaultValue(0);
  }
  return $fields;
}

/**
 * Implements hook_toolbar().
 *
 * Overwrites the core shortcut toolbar and adds the customized shortcuts as a
 * menu. All permissions and access will be handled by shortcut module.
 */
function shortcut_menu_toolbar() {
  $items = shortcut_toolbar();
  $configure_link = $items['shortcuts']['tray']['configure'] ?? [];

  $items['shortcuts']['tray'] = [
    '#theme' => 'menu',
    '#menu_name' => 'shortcut_menu',
    '#items' => [],
    '#theme_hook_original' => 'menu__shortcut_menu',
  ];

  /** @var \Drupal\shortcut\ShortcutSetInterface $shortcut_set */
  $shortcut_set = shortcut_current_displayed_set();
  $shortcuts = $shortcut_set->getShortcuts();

  // Find the max depth of the menu.
  $max_depth = 0;
  foreach ($shortcuts as $shortcut) {
    $shortcut_depth = $shortcut->get('depth')->getString();
    $max_depth = $shortcut_depth > $max_depth ? $shortcut_depth : $max_depth;
  }

  $menu_items = [];
  $depth = 0;

  // Copy the shortcuts so that we dont loop through every shortcut everytime.
  $remaining_shortcuts = $shortcuts;

  // Loop through the menu depths, constructing each level from the top down.
  while ($depth <= $max_depth) {
    foreach ($remaining_shortcuts as $shortcut) {
      if ($shortcut->get('depth')->getString() == $depth) {

        // Get the path where this shortcut should be rendered.
        $path = shortcut_menu_get_item_parents($shortcuts, $shortcut->id());
        $menu_item = [
          'title' => $shortcut->getTitle(),
          'url' => $shortcut->getUrl(),
        ];

        // Set the new item within the menu.
        NestedArray::setValue($menu_items, $path, $menu_item);
        unset($remaining_shortcuts[$shortcut->id()]);
      }
    }
    $depth++;
  }

  // If the toolbar contains a link to configure the shortcuts, add it to the
  // end of the first level.
  if ($configure_link) {
    $attributes = new Attribute($configure_link['#options']['attributes']);
    $menu_items['configure'] = [
      'title' => $configure_link['#title'],
      'url' => $configure_link['#url'],
      'attributes' => $attributes,
    ];
  }

  $items['shortcuts']['tray']['#items'] = $menu_items;
  $items['shortcuts']['#attached']['library'][] = 'shortcut_menu/toolbar';

  return $items;
}

/**
 * Implements hook_theme_suggestions_HOOK().
 */
function shortcut_menu_theme_suggestions_menu(array $variables) {
  if ($variables['menu_name'] == 'shortcut_menu') {
    return ['menu__shortcut_menu'];
  }
  return [];
}

/**
 * Get the path of the given link id to build a nested menu.
 *
 * @param \Drupal\shortcut\ShortcutInterface[] $shortcuts
 *   Array of shortcuts.
 * @param int $link_id
 *   Shortcut link id.
 *
 * @return array
 *   Render array parent path.
 */
function shortcut_menu_get_item_parents(array $shortcuts, $link_id) {
  $shortcut = $shortcuts[$link_id];

  // The given shortcut has a parent, lets get it's path.
  if ($parent_id = $shortcut->get('parent')->getString()) {
    $path = shortcut_menu_get_item_parents($shortcuts, $parent_id);
    $path[] = 'below';
    $path[] = $link_id;
    return $path;
  }

  // No parent for this item. It must be at the root of the menu.
  return [$link_id];
}

/**
 * Implements hook_entity_type_build().
 */
function shortcut_menu_entity_type_build(array &$entity_types) {
  if (isset($entity_types['shortcut_set'])) {
    $entity_types['shortcut_set']->setFormClass('customize', '\Drupal\shortcut_menu\Form\ShortcutMenuSetCustomize');
  }
}
