<?php

/**
 * @file
 * Prevent your Drupal site from being framed.
 *
 * @author David Norman
 * @link https://deekayen.net
 */

/**
 * Implements hook_page_attachments().
 *
 * @param array $page
 *
 * @return array
 */
function frameprevention_page_attachments(array &$page) {
  if (!frameprevention_check()) {
    $x_frame = \Drupal::config('frameprevention.settings')->get('frameprevention_x_frame_options');

    if ($x_frame == 'SAMEORIGIN' || $x_frame == 'DENY') {
      $page['#attached']['http_header'] = array(
        array('X-Frame-Options', $x_frame),
      );
    }

    if (\Drupal::config('frameprevention.settings')->get('frameprevention_enabled')) {
      $path = drupal_get_path('module', 'frameprevention');

      // The OWASP-recommended CSS requires an ID attribute
      // on the style tag, which isn't supported by _drupal_add_css()
      // so the alternate Stanford one is here instead because
      // Drupal 8.0.0-beta2 didn't seem to support attaching HTML
      // tags in the header in a consistent manner yet.
      $page['#attached']['css'][] = $path . '/frameprevention.css';
      $page['#attached']['js'][] = $path . '/frameprevention.js';
    }
  }
}

/**
 * Checks to see if the requested page should be ignored.
 *
 * @return integer
 */
function frameprevention_check() {
  $pages = \Drupal::config('frameprevention.settings')->get('frameprevention_pages');
  $path = request_path();

  $regexp = '/^(' . preg_replace(array('/(\r\n?|\n)/', '/\\\\\*/', '/(^|\|)\\\\<front\\\\>($|\|)/'), array('|', '.*', '\1' . \Drupal::config('frameprevention.settings')->get('site_frontpage') . '\2'), preg_quote($pages, '/')) . ')$/';

  return preg_match($regexp, $path);
}
