<?php

/**
 * @file
 * Node Access by Field module code.
 */
use Drupal\Core\Session\AccountInterface;
use Drupal\field\Entity\FieldConfig;
use Drupal\node\NodeInterface;

/**
 * Implements hook_node_grants().
 */
function node_access_field_node_grants(AccountInterface $account, $op) {
  $grants = [];

  if ($id = $account->id()) {
    $grants['node_access_field'] = array($id);
  }

  return $grants;
}

/**
 * Implements hook_node_access_records().
 */
function node_access_field_node_access_records(NodeInterface $node) {
  $grants = [];

  if (!$field_info = FieldConfig::loadByName('node', $node->bundle(), 'field_associated_users')) {
    return $grants;
  }

  // Default, deny all.
  $grants[] = array(
    'realm' => 'all',
    'gid' => 0,
    'grant_view' => 0,
    'grant_update' => 0,
    'grant_delete' => 0,
  );

  if (!$node->isPublished()) {
    return $grants;
  }

  // Add a realm for each associated user.
  foreach ($node->field_associated_users->getValue() as $delta => $item) {
    $grants[] = [
      'realm' => 'node_access_field',
      'gid' => $item['target_id'],
      'grant_view' => 1,
      'grant_update' => 0,
      'grant_delete' => 0,
    ];
  }

  return $grants;
}
