<?php

/**
 * @file
 * Google analytics server triggered events module.
 */

use Drupal\google_analytics\Component\Render\GoogleAnalyticsJavaScriptSnippet;

/**
 * Implements hook_page_attachments_alter().
 */
function ga_server_events_page_attachments_alter(array &$page) {
  if (empty($page['#attached']['html_head'])) {
    // Nothing to do here.
    return;
  }
  $add_events = FALSE;
  foreach ($page['#attached']['html_head'] as $item) {
    if (empty($item[1])) {
      continue;
    }
    if ($item[1] == 'google_analytics_tracking_script') {
      $add_events = TRUE;
      break;
    }
  }
  if ($add_events) {
    /** @var \Drupal\ga_server_events\EventManager $mgr */
    $mgr = \Drupal::service('ga_server_events.event_manager');
    $events = $mgr->getEvents();
    foreach ($events as $delta => $event) {
      $script = $event->getScript();
      $page['#attached']['html_head'][] = [
        [
          '#tag' => 'script',
          '#value' => new GoogleAnalyticsJavaScriptSnippet($script),
        ],
        'ga_server_events_event_' . $delta,
      ];
    }
    $mgr->clearEvents();
  }
}
