<?php
/**
 * @file
 * Mail headers main module file
 */

/**
 * Implements hook_help().
 */
function mail_headers_help($path, $arg) {
  switch ($path) {
    case 'admin/help#mail_headers':
      // Main module help for the block module.
      return '<p>' . t('Mail Headers allows you to take control over the headers of every mail Drupal sends and limit the allowed domains for the sender e-mail address. You can override almost any header. The FROM address can be changed for those using an address whose domain is not in the allowed list or for every e-mail sent. You can change the settings in the module\'s <a href="@mail_headers">admin page</a>. ', array('@mail_headers' => url('admin/config/system/mail_headers'))) . '</p>';

    case 'admin/config/system/mail_headers':
      // Help for another path in the block module.
      return '<p>' . t('This page allows allows you to Limit the allowed domains for the sender e-mail address used on any e-mail sent through Drupal. You can override the value for every e-mail sent, or only for those using an address whose domain is not in the allowed list. You can also override almost any mail header. Tokens are supported.') . '</p>';
  }
}

/**
 * Implements hook_permission().
 */
function mail_headers_permission() {
  return array(
    'administer mail headers' => array(
      'title' => t('Administer Mail Headers'),
      'description' => t('Perform administration tasks for Mail Headers.'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Implements hook_menu().
 */
function mail_headers_menu() {
  $items['admin/config/system/mail_headers'] = array(
    'title' => 'Mail Headers',
    'description' => 'Limit the domains form where e-mails can be sent and customise the headers for all e-mails sent by Drupal.',
    'page callback' => 'mail_headers_config',
    'access arguments' => array('administer mail headers'),
    'file' => 'mail_headers.admin.inc',
  );
  $items['admin/config/system/mail_headers/config'] = array(
    'title' => 'Config',
    'type' => MENU_DEFAULT_LOCAL_TASK,
  );
  $items['admin/config/system/mail_headers/headers'] = array(
    'title' => 'Headers',
    'description' => 'Limit the domains form where e-mails can be sent.',
    'type' => MENU_LOCAL_TASK,
    'page callback' => 'mail_headers_headers',
    'access arguments' => array('administer mail headers'),
    'file' => 'mail_headers.admin.inc',
  );
  $items['mail_headers/autocomplete'] = array(
    'title' => 'Mail Headers autocomplete',
    'description' => 'Customise headers for ell e-mails sent by Drupal.',
    'page callback' => 'mail_headers_autocomplete',
    'access arguments' => array('administer mail headers'),
    'file' => 'mail_headers.admin.inc',
  );
  return $items;
}

/**
 * Implements hook_mail_alter().
 *
 * We do it here and not in MailHeadersSystem::format to make it work regardless
 * of the class being used to send format the e-mails
 */
function mail_headers_mail_alter(&$message) {
  $site_mail = config('system.site')->get('mail');
  $site_name = config('system.site')->get('name');
  // // This shouldn't be necesary since it happens again in ->mail(), but per our
  // // tests, when site's name has, say, an accent (รก) mail won't go through.
  $site_name = $site_name ? mime_header_encode($site_name) : $site_mail;

  $settings = config('mail_headers.settings');

  // Include user headers.
  $headers = $settings->get('headers');
  foreach ($headers as $header) {
    $name = $header['name'];
    $value = token_replace($header['value'], array('sanitize' => FALSE));
    $message['headers'][$name] = $value;
  }

  // // Override for all mails.
  if ($settings->get('use_default') && $site_mail) {
    $message['headers']['Reply-To'] = $message['headers']['X-Drupal-From'] = $message['headers']['From'];
    $message['headers']['From'] = "$site_name <$site_mail>";
    return;
  }

  // // Override if not in allowed list.
  if ($patterns = $settings->get('domains')) {
    // newlines.
    $to_replace = array(
      '/(\r\n?|\n)/',
    );
    $replacements = array(
      '|',
    );
    $patterns_quoted = preg_quote($patterns, '/');
    $regexps = '/@(' . preg_replace($to_replace, $replacements, $patterns_quoted) . ')$/';
    if (!preg_match($regexps, $message['from'])) {
      if ($site_mail) {
        $message['headers']['Reply-To'] = $message['headers']['X-Drupal-From'] = $message['headers']['From'];
        $message['headers']['From'] = "$site_name <$site_mail>";
      }
      else {
        drupal_set_message(t('The email couldn\'t be sent because the sender e-mail address was not in the allowed list and there is no default site mail address. You can configue the list in the !admin_page.', array('!admin_page' => l(t('Mail Header admin page'), 'admin/config/system/mail_headers'))), 'error');
        $message['to'] = $message['headers']['to'] = $message['headers']['cc'] = $message['headers']['bcc'] = FALSE;
      }
    }
  }
}
