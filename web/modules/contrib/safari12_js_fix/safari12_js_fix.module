<?php

/**
 * @file
 * Safari 12 JS fix module.
 */

/**
 * Implements hook_page_attachments().
 */
function safari12_js_fix_page_attachments(array &$page) {
  // @see https://www.npmjs.com/package/array-reverse-polyfill
  $safari_js_fix = <<<'SAFARI_JS_FIX'
(function() {
  function buggy() {
    function detect() {
      var a = [0, 1];
      a.reverse();
      return a[0] === 0;
    }
    return detect() || detect();
  }
  if(!buggy()) return;
  Array.prototype._reverse = Array.prototype.reverse;
  Array.prototype.reverse = function reverse() {
    if (Array.isArray(this)) this.length = this.length;
    return Array.prototype._reverse.call(this);
  }
  var nonenum = {enumerable: false};
  Object.defineProperties(Array.prototype, {
    _reverse: nonenum,
    reverse: nonenum,
  });
})();
SAFARI_JS_FIX;

  $page['#attached']['html_head'][] = [
    [
      '#type' => 'html_tag',
      '#tag' => 'script',
      '#value' => $safari_js_fix,
      '#weight' => -1000,
    ],
    'safari12-js-fix',
  ];
}
