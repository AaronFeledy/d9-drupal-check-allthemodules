<?php

function meu_paragraphs_paragraph_insert(\Drupal\paragraphs\Entity\Paragraph $entity) {
  static $handled = [];
  /** @var \Drupal\meu_paragraphs\Service\ParagraphPersistance $persistance */
  $persistance = \Drupal::service('meu_paragraphs.persistance');
  if ($persistance->canHandle($entity) && !in_array($entity->id(), $handled)) {
    $media = $persistance->getMedia($entity);
    if (!$media) {
      return false;
    }
    $persistance->store($entity, $media);
    $handled[] = $entity->id();
    return true;
  }
  return false;
}

function meu_paragraphs_paragraph_update(\Drupal\paragraphs\Entity\Paragraph $entity) {
  static $handled = [];
  /** @var \Drupal\meu_paragraphs\Service\ParagraphPersistance $persistance */
  $persistance = \Drupal::service('meu_paragraphs.persistance');
  if ($persistance->canHandle($entity) && !in_array($entity->id(), $handled)) {
    $persistance->purge($entity);
    $media = $persistance->getMedia($entity);
    if (!$media) {
      return false;
    }
    $persistance->store($entity, $media);
    $handled[] = $entity->id();
    return true;
  }
  return false;
}

function meu_paragraphs_paragraph_delete(\Drupal\paragraphs\Entity\Paragraph $entity) {
  static $handled = [];
  /** @var \Drupal\meu_paragraphs\Service\ParagraphPersistance $persistance */
  $persistance = \Drupal::service('meu_paragraphs.persistance');
  if ($persistance->canHandle($entity) && !in_array($entity->id(), $handled)) {
    $persistance->purge($entity);
    $handled[] = $entity->id();
    return true;
  }
  return false;
}