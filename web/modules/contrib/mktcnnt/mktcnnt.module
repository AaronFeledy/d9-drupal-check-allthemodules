<?php

/**
 * @file
 * Provides the marketo functionalities.
 */
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\user\Entity;
use Drupal\user\Entity\Role;

/**
 * Implements hook_help().
 */
function mktcnnt_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.mktcnnt':
      $output = '<h3>' . t('About marketo connect') . '</h3>';
      $output .= '<p>';
      $output .= t('Provides all the marketo connect functionality.');
      $output .= '</p>';
      return $output;
  }
}

function mktcnnt_entity_insert(Drupal\Core\Entity\EntityInterface $entity) {
    $entityType = $entity->getEntityTypeId();
	if($entityType == 'user'){
		$moduleHandler = \Drupal::service('module_handler');
		if ($moduleHandler->moduleExists('mktcnnt')){
			$configRoles = \Drupal::config('mktcnnt.mktcnnt_roles');
			$configConnect = \Drupal::config('mktcnnt.mktcnnt_variables');
			$UserRoles = $configRoles->get('UserRoles');
			$marketo_object = new \Drupal\mktcnnt\Controller\MarketoAPIController();
			$marketo_object->marketoSoapEndPoint = $configConnect->get('marketoSoapEndPoint');
			$marketo_object->marketoUserId = $configConnect->get('marketoUserId');
			$marketo_object->marketoSecretKey = $configConnect->get('marketoSecretKey');
			$marketo_object->marketoNameSpace = $configConnect->get('marketoNameSpace');
			
			$loading = $marketo_object->load();
			$role_objects = Role::loadMultiple();
			$system_roles = array_combine(array_keys($role_objects), array_map(function($a){ return $a->label();}, $role_objects));
			foreach($system_roles as $key_role => $role_title){
				if(in_array($key_role, $UserRoles)){
					if($entity->hasRole($key_role)){
						$email = $entity->getEmail();
						if($loading === true){
							$marketo_object->createLeadinMarketo($email);
						}
					}
				}
			}
		}
	}
}