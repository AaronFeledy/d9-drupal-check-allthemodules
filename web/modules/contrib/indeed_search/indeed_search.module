<?php
/**
 * @file
 * This module holds functions of indeed_search module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;

/**
 * Implements hook_help().
 */
function indeed_search_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'indeed_search.content':
      return '<p>' . t('Displays Jobs') . '</p>';
  }
}

function indeed_search_xml($keyWord='', $loc ='', $sort='', $country='', $type='', $page=0) {

  $array = indeed_search_xml2array($keyWord, $loc, $sort, $country, $type, $page);
  $total_result = (int)$array->totalresults[0];
  $list = '<ul class="indeed_list">'; 
  foreach ($array->results->result as $value) {
    $list .= '<li><a href="' . $value->url . '" target="_blank">' . $value->jobtitle . '</a></li>';
    $list .= '<ul class="indeed_list_inner">';
    $list .= '<li>' . $value->company . '</li>';
    $list .= '<li>' . $value->formattedLocation . '</li>';
    $list .= '<li>' . $value->formattedRelativeTime . '</li>';
    $list .= '<li>' . $value->snippet . '</li>';
    $list .= '<li><a href="' . $value->url . '" target="_blank">Apply</a></li>';
    $list .= '</ul>';
  }
  $list .= '</ul>';

  return $list;
}

function indeed_search_xml2array($keyWord, $loc, $sort, $country, $type, $page) {
  $config = Drupal::config('indeed_search.settings');
  $url = "http://api.indeed.com/ads/apisearch?publisher=";
  $url .= $config->get('indeed_pubid');
  if(!$keyWord) {
    $url .= "&q=";
    $url .= preg_replace('/\s+/', '%20',$config->get('indeed_q'));
  }
  else {
    $url .= "&q=";
    $url .= preg_replace('/\s+/', '%20', $keyWord);
  }

  if($loc) {
    $url .= "&l=";
    $url .= preg_replace('/\s+/', '%20', $loc);
  }

  if($type) {
    $url .= "&jt=";
    $url .= $type;
  }

  if($page) {
    $url .= "&start=";
    $url .= $page*20;
  }

  $url .= "&v=2&radius=";
  $url .= preg_replace('/\s+/', '', $config->get('indeed_radius'));

  if(!$sort) {
    $url .= "&sort=";
    $url .= $config->get('indeed_sort');
  }
  else {
    $url .= "&sort=";
    $url .=  $sort;
  }

  $url .= "&limit=20";
  $url .= "&co=";
  $url .= $config->get('indeed_country');
  $url .= "&useragent=";
  $url .= $_SERVER['HTTP_USER_AGENT'];

  $xml = indeed_search_download_page($url);

  $array = simplexml_load_string($xml);

  return $array;
}

function indeed_search_download_page($path) {
  if (function_exists('curl_init')) {
    $ch = curl_init();
    curl_setopt($ch, CURLOPT_URL, $path);
    curl_setopt($ch, CURLOPT_FAILONERROR, 1);
    curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1);
    curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
    curl_setopt($ch, CURLOPT_TIMEOUT, 15);
    $ret_value = curl_exec($ch);
    curl_close($ch);
    return $ret_value;
  }
  else {
    drupal_set_message(t('Error: PHP Curl is required for the Indeed module.'), 'error');
  }

}

