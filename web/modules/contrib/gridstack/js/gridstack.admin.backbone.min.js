!function(e,t,i,n,a,d){"use strict";t.gridstack=t.gridstack||{},t.gridstack.models={},t.gridstack.collections={},t.gridstack.views={},t.gridstack.ui={},t.gridstack.icon={},t.gridstack.imageStyle={};var s={x:0,y:0,width:2,height:2};t.gridstack.models.Box=n.Model.extend({defaults:a.extend(s,{index:1,nested:[]}),getDataToSave:function(e){var i=this;return e=e||i.attributes,t.gridstack.ui.getCurrentNode(e)},getDataNestedToSave:function(){var e=this,t=[],i=e.get("nested");return i.length&&(t=a.map(i,function(t){return e.getDataToSave(t)||[]},this)),t},initialize:function(e){var i=this;e=e||{},a.isUndefined(e.index)&&(e.index=i.get("index"));var n=t.gridstack.ui.buildId(e);i.set(n,{silent:!0})}}),t.gridstack.collections.Boxes=n.Collection.extend({model:t.gridstack.models.Box,initialize:function(){var e=this;e.on("add remove",e.updateIndex)},updateIndex:function(){this.each(function(e,t){e.set("ordinal",t+1)})}}),t.gridstack.views.Box=n.View.extend({className:"gridstack__box box box--root",tagName:"div",events:{change:"render"},initialize:function(){var e=this;e.listenTo(e.model,"change",e.render)},render:function(){var i=this,n=i.model,d=n.attributes,s=i.$el;return i.isNested=!!n.collection.length&&n.collection._isNested,i.useCss=!!n.collection.length&&n.collection._useCss,e("> .box__content",s).length||s.append(t.theme("gridStackContent",{nested:i.isNested,useCss:i.useCss,type:"root"})),s.attr("data-dimension",d.width+"x"+d.height),a.each(["id","index","ordinal"],function(e){a.isUndefined(d[e])||s.attr("data-"+e,d[e])}),e(".btn",s).attr("data-id",d.id),i.useCss&&e(".gridstack--nested",s).length&&e(".gridstack--nested",s).attr("data-gid",d.index).attr("data-index",d.index).attr("data-id",d.id),a.isUndefined(d.image_style)||s.attr("data-image-style",d.image_style),i.trigger("gridstack:view:render"),i}}),t.gridstack.views.GridStack=n.View.extend({gridStack:null,nodes:[],nestedNodes:[],wrapper:".gridstack-wrapper",events:{resizestop:"onResizeStop"},initialize:function(e){var n=this,d=n.$el,s=t.gridstack.ui,o=i.gridstack||{};e=a.extend({options:{breakpoint:null,currentColumn:12,isNested:!1,storage:null,useCss:!1},saveDataCallback:null},e),n.options=e.options,n.saveDataCallback=e.saveDataCallback,n.useCss=e.options.useCss,s.config=d.data("config")||{};var r=s.config,l=n.options.currentColumn;n.options.isNested&&(l=12,s.config=d.data("configFramework")||{},r=a.extend(s.config,s.nestedOptions)),l<12&&(r.width=n.options.useCss?12:l),s.opts=a.extend(o,s.baseOptions,r),n.gridStackOptions=s.opts,n.nestedOptions=a.extend(s.baseOptions,r),n.options.currentColumn=l,n.rendered=!1,n.collection&&(n.listenTo(n.collection,"add",n.onAdd),n.listenTo(n.collection,"change",n.onChange),n.listenTo(n.collection,"remove",n.onRemove),n.listenTo(n.collection,"gridstack:main:save",n.onSave),n.listenTo(n.collection,"gridstack:root:remove",n.onRootRemoveMultiple),n.useCss&&(n.listenTo(n.collection,"gridstack:root:add",n.onRootAddMultiple),n.listenTo(n.collection,"gridstack:content:remove",n.onContentRemoveMultiple)),n.collection._isNested=n.options.isNested,n.collection._useCss=n.options.useCss)},init:function(){var e=this,t=e.$el;t.gridstack(e.gridStackOptions),e.gridStack=t.data("gridstack"),e.nodes=d.GridStackUI.Utils.sort(e.getSerializedData(t)),e.nestedNodes=d.GridStackUI.Utils.sort(e.getSerializedData(t,!0)),e.$wrapper=t.parent(e.wrapper),e.gridStack.setGridWidth(e.options.currentColumn)},_onWidgetChange:function(){var e=this;e.$el.on("change",a.bind(e.onWidgetChange,e))},_offWidgetChange:function(){this.$el.off("change")},onChange:function(){this.saveData()},onWidgetChange:function(){this.updateBoxesAttributes()},onSave:function(){var e=this;e.options.updateIcon=!0,e.saveData()},onResizeStop:function(t){var i,n=this,a=e(t.target);if(n.updateBoxDimensions(a),n.options.updateStorage=!1,n.el===t.delegateTarget){var d=n.getBoxId(a);i=n.getCurrentBox(d),n.updateBoxAttributes(i,!0),n.options.updateStorage=e(t.delegateTarget).data("storage")||!1}n.saveData()},onRootAddMultiple:function(e,t,i){var n=this,a=i.index(),d={};n.isValidBox(t)||(t=n.collection.at(a));var s=t.get("index"),o=i.find(".gridstack:first");o.gridstack(n.nestedOptions),o.attr("data-gid",s);var r=n.getCurrentGrid(o),l=r.grid.nodes.length,c=t.defaults;c.index=s,c.indexNested=l+1,d=n.getRunTimeNode(c),n.addWidget(d,o),n.saveData(!0)},onAdd:function(e){this.addBox(e)},addBox:function(e){var t=this;t._offWidgetChange(),t.addWidget(e),t.rendered&&t._onWidgetChange()},addWidget:function(i,n){var d,s=this,o=i,r=!1;n=n||s.$el;var l=s.getCurrentGrid(n);if(s.isValidBox(i)){var c=s.getCurrentView(i),g=c.render().$el;o=i.attributes,d=g[0].outerHTML}else r=!0,d=t.theme("gridStackBox",{nested:s.options.useCss});if(l.willItFit(o.x,o.y,o.width,o.height,!0)){var u=l.addWidget(e(d),o.x,o.y,o.width,o.height,!0);return!a.isUndefined(n)&&a.isUndefined(u.context)&&(u.context=n[0]),s.updateBoxDimensions(u),r?s.setBoxNestedAttributes(u,o):s.useCss&&l.movable(u,!1),s.saveData(!0),u}},onRemove:function(e){var t=this;t.getCurrentView(e).remove(),t.updateBoxesAttributes(!0),t.saveData(!0)},onRootRemoveMultiple:function(e,t,i){var n=this;a.isUndefined(t)||(n.removeWidget(i),n.collection.remove(t))},onContentRemoveMultiple:function(e,t,i){var n=this;if(!a.isUndefined(t)){var d=i.index(),s=t.get("nested");s.length&&s.splice(d,1),n.removeWidget(i),n.saveData(!0)}},removeWidget:function(e){var t=this,i=e.parent(".gridstack--nested"),n=t.getCurrentGrid(i);a.isUndefined(n)||n.removeWidget(e)},updateBoxesAttributes:function(e){var t=this;t.collection.each(function(i){t.updateBoxAttributes(i,e)},t)},updateBoxAttributes:function(t,i){var n=this;if(n.isValidBox(t)){var d=t.get("id"),s=e('> .box[data-id="'+d+'"]',n.$el),o=s.data("_gridstack_node"),r=n.getCurrentNode(o);if(a.isEmpty(r)||(r.rect=s[0].firstElementChild.getBoundingClientRect(),t.set(r)),i&&s.attr("data-ordinal",s.index()+1),!s.find(".gridstack").children().length)return void t.set("nested",[]);n.options.useCss&&n.updateBoxNestedAttributes(t,s)}},updateBoxNestedAttributes:function(t,i){var n=this,d=t.get("index"),s=a.clone(t.get("nested")),o=e(".gridstack--nested:first",i),r=e("> .gridstack__box",o);r.length&&(a.each(r,function(t,i){var o=e(t),r=i+1,l=o.data("_gridstack_node");if(!a.isUndefined(l)){l.index=d,l.indexNested=r;var c=n.getRunTimeNode(l);c.rect=t.firstElementChild.getBoundingClientRect(),s[i]=a.isUndefined(s[i])?c:a.extend({},s[i],c),n.setBoxNestedAttributes(o,c)}}),s.length>0&&t.set("nested",s))},setBoxNestedAttributes:function(e,t){e.attr("data-index",t.index),e.attr("data-id",t.id),e.attr("data-ordinal",e.index()+1),e.find(".btn").attr("data-id",t.id),a.isUndefined(t.pid)||e.find(".btn").attr("data-pid",t.pid)},updateBoxDimensions:function(e){var t=e.data("_gridstack_node");e.attr("data-dimension",t.width+"x"+t.height)},getBoxId:function(e){return e.parent(".gridstack--nested").length?e.parent(".gridstack--nested").attr("data-id"):e.attr("data-id")},getCurrentBox:function(e){return this.collection.findWhere({id:e})},getCurrentNode:function(e){return t.gridstack.ui.getCurrentNode(e)},getRunTimeNode:function(e){var i=this;return a.extend(i.getCurrentNode(e),t.gridstack.ui.buildId(e))},getCurrentGrid:function(e){return e&&e.length?e.data("gridstack"):this.gridStack},getCurrentView:function(e){return new t.gridstack.views.Box({model:e})},getStoredImageStyle:function(e){var t=this,i=t.nodes;return a.isUndefined(i[e])||a.isUndefined(i[e].image_style)?"":i[e].image_style},populateImageStyle:function(t,i){var n=e(i),a=n.closest(".box"),d=a.data("imageStyle"),s='<option value="'+d+'">'+d+"</option>";d&&""!==d&&!n.children().length&&n.html(s)},onChangeImageStyle:function(t){var i=this,n=e(t.currentTarget),a=n.closest(".box"),d=e(t.delegateTarget),s=a.index(),o=i.collection.at(s),r=i.getStoredImageStyle(s),l=n.val()||r||a.data("imageStyle");n.val(l).attr("data-imageid",l),n.find("option:selected").prop("selected",!0).siblings("option").prop("selected",!1),o.set("image_style",l),i.rendered&&(i.collection.trigger("change"),i.options.updateStorage=d.data("storage"),i.saveData())},onClickImageStyle:function(i){var n=e(i.currentTarget),a=n.closest(".box"),d=a.data("imageStyle");n.children().length<2&&(n.html(t.gridstack.imageStyle.getOptions()),""!==d&&n.val(d).attr("data-imageid",d))},getSerializedData:function(e,i){return e=e||this.$el,t.gridstack.ui.getSerializedData(e,i)},buildNested:function(e,t){var i=this,n=i.nestedNodes[t],d=t+1,s=[];return!a.isUndefined(n)&&n.length>0&&(s=a.clone(e.get("nested")),a.each(n,function(e,t){e.index=d,e.indexNested=t+1,s[t]=i.getRunTimeNode(e)},this),e.set("nested",s,{silent:!0})),e.get("nested")},build:function(){var t=this,i=[],n=t.options.useCss,d=!1;t.collection.length&&(t.collection.each(function(s,o){if(n&&(i=t.buildNested(s,o),d=i.length>0),t.addBox(s),d){var r=s.get("id"),l=e('> .box[data-id="'+r+'"] .gridstack:first',t.$el);l.length>0&&(l.gridstack(t.nestedOptions),a.each(i,function(e){t.addWidget(e,l)},this))}},t),t.useCss||(t.$el.on("change.gsimg",".form-select--image-style",a.bind(t.onChangeImageStyle,t)),t.$el.on("click.gsimg",".form-select--image-style",a.bind(t.onClickImageStyle,t)),e(".form-select--image-style",t.$el).each(a.bind(t.populateImageStyle,t))))},render:function(){var e=this;return e.init(),e.build(),e.rendered=!0,e._onWidgetChange(),e},isValidBox:function(e){return e instanceof t.gridstack.models.Box},saveData:function(e){var t=this;if(!a.isEmpty(t.saveDataCallback)&&t.rendered){var i=t.options||{};!i.updateStorage&&e&&(i.updateStorage=t.options.storage),t.saveDataCallback.callback(t.collection,i)}t.options.updateIcon=!1,t.options.updateStorage=!1}}),t.gridstack.ui={config:{},opts:{},baseOptions:{itemClass:"gridstack__box",handle:".box__content",alwaysShowResizeHandle:/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),resizable:{handles:"e, se, s, sw, w"},placeholderClass:"gridstack__box--placeholder box"},nestedOptions:{isNested:!0,minWidth:1,verticalMargin:15,width:12},nodesData:[],nestedData:[],domData:[],defaultGrids:[s],buildId:function(e){var t={};if(e=e||{},a.isUndefined(e.index))return t;var i=e.index;if(t.id="root"+i,a.isUndefined(e.indexNested))t.index=i;else{var n=e.indexNested;t.pindex=i,t.pid=t.id,t.id="nested"+i+"_"+n,t.index=n}return t.ordinal=a.isUndefined(e.ordinal)?t.index:e.ordinal,t},getCurrentNode:function(e){var t={};return a.isUndefined(e)?t:(a.isUndefined(e.x)&&(e=e.data("_gridstack_node")),t={x:parseInt(e.x),y:parseInt(e.y),width:parseInt(e.width),height:parseInt(e.height)},a.isUndefined(e.image_style)||(t.image_style=e.image_style),t)},getSerializedData:function(t,i){var n=this,a=t.data("storage"),d=t.data("previewGrids");i&&(a=t.data("nestedStorage"),d=t.data("nestedGrids"));var s=e('[data-drupal-selector="'+a+'"]'),o=s.length?s.val():"",r=""===o||"[]"===o?"":o;r&&(r=JSON.parse(r));var l=r||d||[];return l.length||(l=n.defaultGrids),i&&(l=r||d||[]),l},loadCollection:function(i){var n=this,s=e(i),o=[],r=d.GridStackUI.Utils.sort(n.getSerializedData(s));if(!r.length)return o;var l=t.gridstack.collections.Boxes.extend({model:t.gridstack.models.Box});return o=a.map(r,function(e,i){return e.index=i+1,new t.gridstack.models.Box(e)},this),new l(o)},loadGridStack:function(e){var i=this;return e=e||{},e.saveDataCallback=e.saveDataCallback||{callback:i.saveData.bind(i)},new t.gridstack.views.GridStack(e)},saveData:function(i,n){var d=this,s=n.breakpoint||null,o=n.icon||null,r=[],l=[],c=[],g=n.storage||null,u=n.updateIcon||!1;if(i.each(function(e,i){if(e instanceof t.gridstack.models.Box){var n=e.getDataToSave(),d=e.get("nested"),s=e.getDataNestedToSave();if(l.push(n),c[i]=d.length?s:[],u){var o=e.attributes;r.push(a.omit(o,"nested")),d.length&&(a.omit(d,"nested"),r=r.concat(d))}}}),d.nodesData=l,d.nestedData=c,d.mergedData=r,u&&o===s&&(d.domData=d.saveIcon(n)),n.updateStorage&&!u&&n.updateStorage===g){var h=d.nodesData.length?JSON.stringify(d.nodesData):"";e('[data-drupal-selector="'+g+'"]').val(h);var f=d.nestedData.length?JSON.stringify(d.nestedData):"";e('[data-drupal-selector="'+n.nestedStorage+'"]').val(f)}},saveIcon:function(t){var i=this,n=e("#gridstack-"+t.icon),d={},s=i.opts.verticalMargin>2?i.opts.verticalMargin:15,o=s/2,r=i.opts.verticalMargin>5?0:5,l=t.noMargin;return a.map(i.mergedData,function(c){if(a.isUndefined(c.id))return d;var g=e('.box[data-id="'+c.id+'"]',n);if(a.isUndefined(g)||a.isUndefined(g[0]))return d;var u=g[0].firstElementChild.getBoundingClientRect(),h=g.index()+1,f=parseInt(g.css("left"))+o,p=parseInt(g.css("top")),v=e(".gridstack--nested:first",g),x=e("> .box",v),m=!1,k=x.length?"":h,b="#18bc9c",C=u.width;if(x.length&&(b="transparent",C+=o),g.parent(".gridstack--nested").length){var S=g.parent(".gridstack--nested"),y=S.closest(".box"),B=y.index()+1;h=g.index()+1,f+=parseInt(y.css("left")),p+=parseInt(y.css("top")),m=!0,k=a.isUndefined(B)||a.isUndefined(h)?"":B+":"+h,b="rgba(24, 288, 156, .4)",x.length&&(b="#18bc9c")}else(t.useCss||l)&&(C-=s);return 0===i.opts.verticalMargin&&12!==g.data("gsWidth")&&(C-=o),d={left:f,top:p,width:C,height:u.height-r,margin:s,id:a.isUndefined(c)?0:c._id,index:h,nested:m,title:k,color:b}},this)}},t.gridstack.icon={build:function(t,i){var n=this,a=e(t),d=a.data("icon")||"lg",s=e("#gridstack-"+d,t);if(s.length){var o=e("#gridstack-canvas",t)[0],r=parseInt(s.css("width")),l=parseInt(s.css("height")),c="";return o.width=r,o.height=l,o.style.width=r+"px",o.style.height=l+"px",i&&(c=n.draw(o)),c}},draw:function(i){var n,d=this,s=t.gridstack.ui.domData||{};if(s.length)return a.each(s,function(e){var t=i.getContext("2d"),n=e.left,a=e.top,s=e.title;t.beginPath(),t.fillStyle=e.color,"transparent"!==e.color&&(t.fillStyle="#18bc9c"),t.fillRect(n,a,e.width,e.height),t.restore(),d.drawBoxById(t,s,e)}),n=i.toDataURL("image/png"),e("#gridstack-icon").val(n),e("#gridstack-screenshot").empty().css("background-image","url("+n+")"),n},drawBoxById:function(e,t,i){var n=i.height,a=i.left+20,d=n>120?i.top+70:i.top+45;e.beginPath(),e.font="92px sans-serif",e.textBaseline="middle",e.textAlign="left",e.fillStyle="white",e.fillText(t,a,d)}},t.gridstack.imageStyle={getOptions:function(){var t=e("#gridstack-box-template .form-item--image-style").html();return e(t).clone()[0].innerHTML}},t.theme.gridStackBox=function(e){var i=e.type||"content",n="";return n+='<div class="gridstack__box box'+("content"===i&&e.nested?" box--nested":"")+'">',n+=t.theme("gridStackContent",e),n+="</div>"},t.theme.gridStackContent=function(e){var t=e.type||"content",i="";return i+='<div class="box__content">',i+='<div class="btn-group btn-group--dummy">',i+='<button class="button btn btn--box btn--'+t+' btn--remove" data-message="remove" data-type="'+t+'">&times;</button>',"root"===t&&(e.useCss?i+='<button class="button btn btn--box btn--'+t+' btn--add" data-message="add" data-type="'+t+'">+</button>':i+='<select class="form-select form-select--image-style" data-imageid="" id="" />'),i+="</div>",e.nested&&(i+='<div class="gridstack ungridstack gridstack--ui gridstack--js gridstack--nested gridstack--enabled"></div>'),i+="</div>"}}(jQuery,Drupal,drupalSettings,Backbone,_,this);
