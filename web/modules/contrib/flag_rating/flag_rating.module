<?php

/**
 * @file
 * The Flag Rating module.
 *
 * This module creates a default Flag Rating and associated views.
 */

/**
 * Implements hook_entity_type_alter().
 */
function flag_rating_entity_type_alter(array &$entity_types) {
  if (isset($entity_types['flag'])) {
    /** @var \Drupal\Core\Entity\ContentEntityTypeInterface $entity_type */
    $entity_type = $entity_types['flag'];
    $handlers = $entity_type->getHandlerClasses();
    $handlers['form']['edit'] = 'Drupal\flag_rating\Form\FlagRatingEditForm';
    $entity_type->setHandlerClass('form', $handlers['form']);
  }  
}

/**
 * Implements hook_theme().
 */
function flag_rating_theme() {
  return [
    'flag_rating' => [
      'variables' => [
        'flag' => NULL,
        'flaggable' => NULL,
        'title' => NULL,
        'score' => NULL,
        'items' => [],
      ],
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_HOOK().
 */
function flag_rating_theme_suggestions_flag(array $variables) {
  $flag = $variables['flag'];
  $flaggable = $variables['flaggable'];

  return [
    'flag_rating__' . $flag->id(),
    'flag_rating__' . $flag->id() . '_' . $flaggable->id(),
  ];
}

/**
 * Create default icons for Flag Rating link component.
 *
 * @param string $icon_filename
 *    Name of the default icon.
 * @param string $icon_directory
 *    Name of the directory where icons have to be saved.
 * 
 * @return null|\Drupal\file\FileInterface $file
 */
function flag_rating_create_default_icon($icon_filename = 'star.svg', $icon_directory = 'public://flag-rating-icon') {
  global $base_url;
  $icon_url = $base_url . '/' . drupal_get_path('module', 'flag_rating') . '/img' . '/' . $icon_filename;
  if ($icon_file = system_retrieve_file($icon_url, $icon_directory . '/' . $icon_filename , TRUE, FILE_EXISTS_REPLACE)) {
    $icon_file->setPermanent();
    $icon_file->save();
  }
  return $icon_file;
}
