<?php

use Drupal\Core\Url;

/**
 * Implements hook_page_attachments().
 */
function lang_prompt_page_attachments(array &$attachments) {
  $route = \Drupal::routeMatch()->getRouteObject();

  if (!\Drupal::service('router.admin_context')->isAdminRoute($route)) {
    $attachments['#attached']['library'][] = 'lang_prompt/dialog';
    $attachments['#attached']['drupalSettings']['langPrompt'] = [];
    $lang_prompt_settings = &$attachments['#attached']['drupalSettings']['langPrompt'];

    $language_manager = \Drupal::languageManager();
    $original_language = $language_manager->getConfigOverrideLanguage();

    foreach ($language_manager->getLanguages() as $language) {
      $langcode = $language->getId();
      $language_manager->setConfigOverrideLanguage($language);
      $config = Drupal::config('lang_prompt.config');
      $message = $config->get('message');
      $append_to_selector = $config->get('append_to_selector');

      $message_html_render = [
        '#type' => 'container',
        '#prefix' => '<div id="lang-prompt">',
        '#suffix' => '</div>',
        'lang_prompt' => [
          '#theme' => 'lang_prompt_dialog',
          '#message' => $message,
          '#language' => $language,
        ],
      ];

      $lang_prompt_settings[$langcode] = [
        'messageHtml' => \Drupal::service('renderer')->renderRoot($message_html_render),
      ];

      $lang_prompt_settings['appendToSelector'] = $append_to_selector;

      // Add language switcher links.
      $links = lang_prompt_get_language_switcher_links();
      foreach ($links as $langcode => $link) {
        $url = $link['url'];
        $url->setOptions([
          'language' => $link['language'],
          'attributes' => $link['attributes'],
          'query' => $link['query'],
        ]);
        $lang_prompt_settings['languageLinks'][$langcode] = [
          'url' => $url->toString(),
          'title' => $link['title'],
        ];
      }
    }

    $language_manager->setConfigOverrideLanguage($original_language);
    $lang_prompt_settings['langcode'] = $language_manager->getCurrentLanguage()->getId();
  }
}

/**
 * Implements hook_theme().
 */
function lang_prompt_theme($existing, $type, $theme, $path) {
  return [
    'lang_prompt_dialog' => [
      'variables' => [
        'message' => '',
        'language' => NULL
      ],
      'path' => drupal_get_path('module', 'lang_prompt') . '/templates',
    ],
  ];
}

/**
 * Get a list of language switcher links.
 *
 * @return mixed
 *   A list of links (not renderable).
 */
function lang_prompt_get_language_switcher_links() {
  $language_manager = \Drupal::service('language_manager');
  $path_matcher = \Drupal::service('path.matcher');
  $route_name = $path_matcher->isFrontPage() ? '<front>' : '<current>';
  $language_switcher_data = $language_manager->getLanguageSwitchLinks('language_interface', Url::fromRoute($route_name));

  if (!empty($language_switcher_data->links)) {
    return $language_switcher_data->links;
  }
}
