<?php

/**
 * @file
 * Contains simple_gtm.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function simple_gtm_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the simple_gtm module.
    case 'help.page.simple_gtm':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Simple implementation of Google Tag Manager') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_page_attachments().
 */
function simple_gtm_page_attachments(array &$attachments) {
  $config = \Drupal::config('simple_gtm.settings');
  // Get GTM code.
  $gtm_code = $config->get('gtm_code');
  // Attach GTM script tag to head.
  if ($gtm_code) {
    $contents = '(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push(
{\'gtm.start\': new Date().getTime(),event:\'gtm.js\'}
);var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!=\'dataLayer\'?\'&l=\'+l:\'\';j.async=true;j.src=
\'https://www.googletagmanager.com/gtm.js?id=\'+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,\'script\',\'dataLayer\',\'' . $gtm_code . '\');';

    $attachments['#attached']['html_head'][] = [
      [
        '#tag' => 'script',
        '#value' => $contents,
        '#weight' => 12,
      ],
      'key',
    ];
  }
}

/**
 * Implements hook_page_top().
 */
function simple_gtm_page_top(&$page) {
  $config = \Drupal::config('simple_gtm.settings');
  // Get GTM code.
  $gtm_code = $config->get('gtm_code');
  // Attach GTM noscript tag to body.
  if ($gtm_code) {
    $contents = '<!-- Google Tag Manager (noscript) -->
<noscript><iframe src="https://www.googletagmanager.com/ns.html?id=' . $gtm_code . '"
height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<!-- End Google Tag Manager (noscript) -->';

    $page['simple_gtm_noscript_tag'] = [
      '#markup' => $contents,
      '#allowed_tags' => ['noscript', 'iframe'],
      '#weight' => -20,
    ];
  }
}
