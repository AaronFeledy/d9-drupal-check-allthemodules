<?php

use Drupal\Core\Queue\QueueFactory;
use Drupal\Core\Queue\QueueInterface;

/**
 * Implements hook_cron().
 */
function cleverreach_cron() {
  cleverreach_group_update();
}

function cleverreach_group_update() {
  $config = \Drupal::service('config.factory')->get('cleverreach.settings');

  if ($config->get('api_key') && $config->get('wsdl_url')) {      
    $api = new SoapClient($config->get('wsdl_url'));
    $result = $api->groupGetList($config->get('api_key'));
      
    $db = \Drupal::database();

    if ($result->status == 'SUCCESS') {
      $db->truncate('cleverreach_groups')->execute();
      $query = $db->insert('cleverreach_groups')->fields(array(
        'crgid',
        'name',
        'attributes',
        'active_count',
        'inactive_count',
        'last_mailing',
        'last_changed',
      ));

      foreach ($result->data as $value) {
        $attr = array();
        $details = $api->groupGetDetails($config->get('api_key'), $value->id);

        foreach ($details->data->attributes as $valued) {
          array_push($attr, array(
            'key' => $valued->key,
            'type' => $valued->type,
            'variable' => $valued->variable,
          ));
        }

        $attr = serialize($attr);
        $query->values(array(
          'crgid' => $value->id,
          'name' => $value->name,
          'attributes' => $attr,
          'active_count' => $value->count,
          'inactive_count' => $value->inactive_count,
          'last_mailing' => $value->last_mailing,
          'last_changed' => $value->last_changed,
        ));
      } 

      $query->execute();
      \Drupal::state()->set('cleverreach.last_group_fetch', time());
      \Drupal::logger('cleverreach')->notice(t('Groups updated successfully'));
      drupal_set_message(t('CleverReach groups updated successfully'));
    }
    else {
      \Drupal::logger('cleverreach')->error(t('Group update failed with status: %status and message %message.', array('%status' => $result->status, '%message' => $result->message)));
      drupal_set_message(t('CleverReach group update failed'), 'error');
    }
    
  }
  else {
    drupal_set_message(t('CleverReach group update failed'), 'error');
  }

}

/**
 * Function to get a group name by id. 
 */
function cleverreach_get_group_name($listid) {

  if (empty($listid) || !is_numeric($listid)) {
    return FALSE;
  }
  else {
    $db = \Drupal::database();
    $name = $db->query('SELECT g.name FROM {cleverreach_groups} g WHERE g.crgid = :listid', array(':listid' => $listid))->fetchField();
    return $name;
  }

}
