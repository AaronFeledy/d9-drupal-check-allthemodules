<?php

/**
 * @file
 * Adds a commandbar form to the administration menu.
 */

use Drupal\commandbar\Commandbar;
use Drupal\commandbar\Form\CommandbarBarForm;

/**
 * Implements hook_help().
 */
function commandbar_help($path, $arg) {
  switch ($path) {
    case 'admin/help#commandbar':
      $output = '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The Commandbar module adds a menu search feature to the administrative toolbar.') . '</p>';
      $output .= '<h3>' . t('Uses') . '</h3>';
      $output .= '<dl>';
      $output .= '<dt>' . t('Searching for menu items') . '</dt>';
      $output .= '<dd>' . t('The Commandbar module displays a search form in the "menu" section of the administrative toobar. This search bar searches menu items in the "admin" menu that the user can jump directly to. This input can also be extended by other modules to include additional command-line-like features.') . '</dd>';
      $output .= '</dl>';
      return $output;
  }
}

/**
 * Implements hook_permission().
 */
function commandbar_permission() {
  return array(
    'access commandbar' => array(
      'title' => t('Access commandbar'),
    ),
  );
}

/**
 * Implements hook_toolbar_alter().
 */
function commandbar_toolbar_alter(&$items) {
  $menu_search = drupal_get_form(new CommandbarBarForm());
  array_unshift($items['administration']['tray'], $menu_search);
}

/**
 * Implements hook_library_info().
 */
function commandbar_library_info() {
  $path = drupal_get_path('module', 'commandbar');
  $libraries['drupal.commandbar'] = array(
    'title' => 'Commandbar',
    'version' => VERSION,
    'css' => array(
      $path . '/css/commandbar.base.css' => array(),
      $path . '/css/commandbar.theme.css' => array(),
    ),
    'js' => array(
      $path . '/js/commandbar.js' => array(),
    ),
  );
  return $libraries;
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Add the enable deep menu searching to an individual user's account page.
 *
 * @see user_profile_form()
 */
function commandbar_form_user_profile_form_alter(&$form, &$form_state) {
  $account = $form_state['controller']->getEntity();
  if (user_access('access commandbar', $account)) {
    $form['commandbar_control'] = array(
      '#type' => 'details',
      '#title' => t('Commandbar deep search'),
      '#weight' => 4,
    );
    $account_data = Drupal::service('user.data')->get('commandbar', $account->id(), 'deep_search_enabled');
    $form['commandbar_control']['deep_search_enabled'] = array(
      '#type' => 'checkbox',
      '#title' => t('Enable commandbar deep search.'),
      '#description' => t('By default, tabs and hidden menu items do not get searched. Enable this to add these to the commandbar search.'),
      '#default_value' => isset($account_data) ? $account_data :0,
    );
  }
}

/**
 * Implements hook_user_update().
 */
function commandbar_user_update($account) {
  if (isset($account->deep_search_enabled)) {
    drupal_container()->get('user.data')->set('commandbar', $account->id(), 'deep_search_enabled', (int) $account->deep_search_enabled);
  }
}

/**
 * Implements hook_theme().
 */
function commandbar_theme() {
  return array(
    'commandbar_item' => array(
      'variables' => array('url' => '', 'path' => '', 'description' => '', 'title' => '', 'parents' => array()),
      'template' => 'commandbar-item',
    ),
  );
}