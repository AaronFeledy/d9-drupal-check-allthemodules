<?php
/**
 * @file
 * Overrides dblog's event viewer to include paging functionality on events.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_help().
 */
function dblog_pager_help($route_name) {
  switch ($route_name) {
    case 'help.page.dblog_pager':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The DBLog Pager module adds paging functionality to the Database Logging event view For more information see <a href="!doc" target="_blank">module page</a>.', ['!doc' => 'http://drupal.org/project/dblog_pager']) . '</p>';
      return $output;
  }
}

/**
 * Implements hook_form_FORM_ID_alter() for system_logging_settings().
 */
function dblog_pager_form_system_logging_settings_alter(&$form, FormStateInterface $form_state) {
  $form['dblog_pager'] = [
    '#type' => 'details',
    '#title' => t('DBLog Pager'),
    '#open' => TRUE,
  ];
  $form['dblog_pager']['dblog_pager_show_fl'] = [
    '#type' => 'checkbox',
    '#title' => t('Show First/Last links'),
    '#default_value' => \Drupal::configFactory()->getEditable(
      'dblog_pager.settings')->get('show_first_last'),
    '#description' => t(
      "On individual log events show or hide the First/Last links."),
  ];
  $form['dblog_pager']['dblog_pager_bad_id'] = [
    '#type' => 'details',
    '#title' => t('Bad ID Processing'),
  ];
  $form['dblog_pager']['dblog_pager_bad_id']['dblog_pager_bad_id_override'] = [
    '#type' => 'checkbox',
    '#title' => t('Override Bad ID Processing'),
    '#default_value' => \Drupal::configFactory()->getEditable(
      'dblog_pager.settings')->get('bad_id_override'),
    '#description' => t(
      "Override processing of log ids that can't be found. Instead of a blank
      page display a warning."),
  ];
  $form['dblog_pager']['dblog_pager_bad_id']['dblog_pager_bad_id_last'] = [
    '#type' => 'checkbox',
    '#title' => t('Redirect To Last Log Record'),
    '#default_value' => \Drupal::configFactory()->getEditable(
      'dblog_pager.settings')->get('bad_id_last'),
    '#description' => t(
      "If overriding bad ID processing, redirect to last valid log record."),
    '#states' => [
      'visible' => [
        ':input[name="dblog_pager_bad_id_override"]' =>
        ['checked' => TRUE],
      ],
    ],
  ];
  $form['#submit'][] = 'dblog_pager_logging_settings_submit';
}

/**
 * Form submission handler for system_logging_settings().
 *
 * @see dblog_pager_form_system_logging_settings_alter()
 */
function dblog_pager_logging_settings_submit($form, FormStateInterface $form_state) {
  \Drupal::configFactory()->getEditable('dblog_pager.settings')->set(
    'show_first_last', $form_state->getValue('dblog_pager_show_fl'))->save();
  \Drupal::configFactory()->getEditable('dblog_pager.settings')->set(
    'bad_id_override', $form_state->getValue('dblog_pager_bad_id_override'))->save();
  \Drupal::configFactory()->getEditable('dblog_pager.settings')->set(
    'bad_id_last', $form_state->getValue('dblog_pager_bad_id_last'))->save();
}
