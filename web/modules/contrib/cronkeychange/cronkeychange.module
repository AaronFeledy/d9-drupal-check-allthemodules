<?php

/**
 * @file
 * Cron Key Change
 */

use Drupal\Component\Utility\Crypt;

/**
 * Implements hook_form_FORM_ID_alter().
 */
function cronkeychange_form_system_cron_settings_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  $form['cronkeychange'] = array(
    '#type' => 'fieldset',
    '#tree' => FALSE,
    '#title' => t('Change cron key'),
    '#collapsible' => FALSE,
    '#collapsed' => FALSE,
  );
  $form['cronkeychange']['current'] = array(
    '#type' => 'item',
    '#title' => t('Current cron key'),
    '#markup' => \Drupal::state()->get('system.cron_key'),
  );
  $form['cronkeychange']['generate'] = array(
    '#type' => 'submit',
    '#value' => t('Generate new key'),
    '#submit' => array('cronkeychange_generate_submit'),
  );
}

/**
 * Generate new cron key.
 */
function cronkeychange_generate_submit(&$form = array(), &$form_state = array()) {
  $cron_key = Crypt::randomBytesBase64(55);
  \Drupal::state()->set('system.cron_key', $cron_key);
  if (PHP_SAPI !== 'cli') {
    drupal_set_message(t('New cron key generated.'));
  }
  \Drupal::logger('cronkeychange')->notice('New cron key generated.');
}
