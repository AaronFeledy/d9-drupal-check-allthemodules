<?php

/**
 * @file
 * Code for the Digital Locker Requester feature.
 */

use Drupal\Core\Url;

/**
 * Implements hook_page_bottom().
 */
function digitallocker_requester_page_bottom(array &$page_bottom) {

  $config = \Drupal::config('digitallocker_requester.settings');
  $requester_id = $config->get('requester_id');

  $timstamp = date_timestamp_get(date_create());
  $hash_key = hash('sha256', $requester_id . $config->get('secret_key') . $timstamp);

  $page_bottom['#attached']['library'][] = 'digitallocker_requester/digitallocker_requester';
  $page_bottom['#attached']['drupalSettings']['DigitalLocker']['callbackUrl'] = (new Url('digitallocker_requester.callback'))->toString();
  $page_bottom['digitallocker'] = [
    '#type' => 'html_tag',
    '#tag' => 'script',
    '#attributes' => [
      'id' => 'dlshare',
      'src' => $config->get('base_url') . '/requester/api/2/dl.js',
      'type' => 'text/javascript',
      'async' => 'async',
      'defer' => 'true',
      'time-stamp' => $timstamp,
      'data-app-id' => $requester_id,
      'data-app-hash' => $hash_key,
      'data-callback' => 'digitallocker_requester_callback',
    ],
  ];
}
