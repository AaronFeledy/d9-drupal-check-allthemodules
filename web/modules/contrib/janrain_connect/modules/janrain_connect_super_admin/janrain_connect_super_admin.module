<?php

/**
 * @file
 * Default file for the project.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook form_alter().
 */
function janrain_connect_form_janrain_connect_admin_settings_alter(&$form, FormStateInterface $form_state, $form_id) {

  $config = \Drupal::config('janrain_connect_super_admin.settings');

  // Get Encrypt Status (Enabled / Disabled).
  $encrypt_enabled = \Drupal::moduleHandler()->moduleExists('encrypt');

  // Create form.
  $form['super_admin'] = [
    '#type' => 'details',
    '#title' => t('Super Admin'),
    '#open' => TRUE,
    '#weight' => 0,
  ];

  $form['super_admin']['auth_id'] = [
    '#title' => t('Auth ID'),
    '#type' => 'textfield',
    '#default_value' => $config->get('auth_id'),
    '#required' => TRUE,
  ];

  $form['super_admin']['auth_secret'] = [
    '#title' => t('Auth Secret'),
    '#type' => 'password',
    '#default_value' => $config->get('auth_secret'),
    '#description' => t('It is recommended not to use owner credentials'),
    '#required' => TRUE,
  ];

  // Form's behavior when the user clicks on checkbox.
  if ($encrypt_enabled) {

    $form['super_admin']['encrypt_option'] = [
      '#title' => t('Use Encryption Key'),
      '#type' => 'checkbox',
      '#required' => FALSE,
      '#weight' => -1,
      '#default_value' => $config->get('encrypt_option'),

    ];

    $form['super_admin']['key_id'] = [
      '#title' => t('Key'),
      '#type' => 'key_select',
      '#weight' => 2,
      '#default_value' => $config->get('key_id'),
      '#states' => [
        'visible' => [
          ':input[name="encrypt_option"]' => [
            'checked' => TRUE,
          ],
        ],
      ],
    ];

    $form['super_admin']['auth_id']['#states'] = [
      'visible' => [
        ':input[name="encrypt_option"]' => [
          'checked' => FALSE,
        ],
      ],
    ];

    $form['super_admin']['auth_secret']['#states'] = [
      'visible' => [
        ':input[name="encrypt_option"]' => [
          'checked' => FALSE,
        ],
      ],
    ];

    $form['super_admin']['auth_id']['#required'] = FALSE;
    $form['super_admin']['auth_secret']['#required'] = FALSE;
  }

  // Submit form.
  $form['#submit'][] = 'janrain_connect_super_admin_form_submit';

}

/**
 * Implements hook_form_submit().
 */
function janrain_connect_super_admin_form_submit(
  array $form,
  FormStateInterface $form_state) {

  $config = \Drupal::configFactory()
    ->getEditable('janrain_connect_super_admin.settings')
    ->set('application_id', $form_state->getValue('application_id'))
    ->set('auth_id', $form_state->getValue('auth_id'))
    ->set('key_id', $form_state->getValue('key_id'))
    ->set('encrypt_option', $form_state->getValue('encrypt_option'));

  if ("" !== $form_state->getValue('auth_secret')) {
    $config->set('auth_secret', $form_state->getValue('auth_secret'));
  }

  $config->save();
}
