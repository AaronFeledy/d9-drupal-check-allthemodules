<?php
use Drupal\node\Entity\Node;

function openlayers_examples_install() {
  //Example Node 1 - Point
  $node = Node::create([
    'type'        => 'openlayers_example',
    'title'       => 'Drupal Geofield Example Point',
    'field_examplegeofield' => 'POINT(11.597686303448903 53.29853876440106)',
  ]);
  $node->save();
  $pointID = $node->id();
  
  //Example Node 1
  $node = Node::create([
    'type'        => 'openlayers_example',
    'title'       => 'Drupal Geofield Example Polygon',
    'field_examplegeofield' => 'POLYGON ((-3.1695556640625 52.018698081044, 10.892944335938 58.602610573647, 34.096069335938 51.801821500783, 25.307006835938 37.952860918157, 6.6741943359375 44.300264411582, 19.330444335938 50.923813271913, 7.0257568359375 50.478482715642, -4.5758056640625 41.992160233376, -13.013305664062 46.521075663843, -174.02893066406 43.028745251349, -174.02893066406 54.743649765924, -18.638305664062 52.663057670759, -3.1695556640625 52.018698081044))',
  ]);
  $node->save();
  $polygonID = $node->id();
  
  //Example Node 2
  $node = Node::create([
    'type'        => 'openlayers_example',
    'title'       => 'Drupal Geofield Example Line',
    'field_examplegeofield' => 'LINESTRING(-106.17575119655112 59.684789277691465,-129.3788761965511 -30.495321187149855,-48.167938696551104 -22.967764633890624,-30.238251196551104 57.675218162699565,17.22268630344888 57.675218162699565,2.4570613034488855 -20.354169583535935,60.4648738034489 -13.975930845510376,67.1445613034489 52.87624893571541,117.41799880344888 52.44980687906403,109.33206130344891 -7.067382977832821,147.6523738034489 -2.514253347978439)',
  ]);
  $node->save();
  $lineID = $node->id();
  
  //Entity types
  $source = 'openlayers_source';
  $layer = 'openlayers_layer';
  $layeroptions = 'openlayers_layeroptions';
  $map = 'openlayers_map';

  //install Sources
  //Drupal
  $entity_source = array(
    'uuid' => 'e87e0c81-a35e-4bd7-abba-2a21a3a11cff',
    'source_name' => 'Example: Drupal',
    'source_type' => 'vector',
    'source_url' => 'none',
    'server_type' => 'drupalintern',
  );
  $new_entity = \Drupal::entityManager()->getStorage($source)->create($entity_source);
  $new_entity->save();
  $drupal_source_ID = $new_entity->id();
  
  //OpenStreetMap
  $entity_source = array(
    'uuid' => 'f6effee4-e92a-4c40-8062-a525032d9309',
    'source_name' => 'Example: OpenStreetMap',
    'source_type' => 'osm',
    'source_url' => 'none',
    'server_type' => 'none',
  );
  $new_entity = \Drupal::entityManager()->getStorage($source)->create($entity_source);
  $new_entity->save();
  $osm_source_ID = $new_entity->id();

  //Example WMS
  $entity_source = array(
    'uuid' => '9c33548b-7ac2-485b-8ec3-8cb003c41bc9',
    'source_name' => 'Example: L채rm Niedersachsen (gefunden im Geoportal.de)',
    'source_type' => 'imagewms',
    'source_url' => 'https://www.umweltkarten-niedersachsen.de/arcgis/services/GAV_wms/MapServer/WMSServer?',
    'server_type' => 'mapserver',
  );
  $new_entity = \Drupal::entityManager()->getStorage($source)->create($entity_source);
  $new_entity->save();
  $wms_source_ID = $new_entity->id();
  
  
  //Example WMS
  $entity_source = array(
    'uuid' => '9c33548b-7ac2-486b-8ec3-8cb003c41bc9',
    'source_name' => 'Example: L채rm an bayrischen Flugh채fen(gefunden im Geoportal.de)',
    'source_type' => 'imagewms',
    'source_url' => 'http://www.lfu.bayern.de/gdi/wms/laerm/flughaefen?',
    'server_type' => 'mapserver',
  );
  $new_entity = \Drupal::entityManager()->getStorage($source)->create($entity_source);
  $new_entity->save();
  $wms_source_II_ID = $new_entity->id();
  
  

  //install Layers
  //drupal node
  $entity_layer = array(
    'uuid' => '1037b835-3990-48af-8cad-f44befb43aa6',
    'layer_name' => 'Example: Drupal - Node',
    'layer_type' => 'node',
    'layer_machine' => 'none',
    'layer_node_ref' => $polygonID,
    'layer_source_ref' => $drupal_source_ID,
  );
  $new_entity = \Drupal::entityManager()->getStorage($layer)->create($entity_layer);
  $new_entity->save();
  $drupalnode_layer_ID = $new_entity->id();
  
  //drupal view
  $entity_layer = array(
    'uuid' => '9ea34919-7c3e-4e98-a7cf-9b9d23ca2b6a',
    'layer_name' => 'Example: Drupal - View',
    'layer_type' => 'view',
    'layer_machine' => 'none',
    'layer_view_ref' => 'examples_openlayers_view',
    'layer_source_ref' => $drupal_source_ID,
  );
  $new_entity = \Drupal::entityManager()->getStorage($layer)->create($entity_layer);
  $new_entity->save();
  $drupalview_layer_ID = $new_entity->id();
  
  //OSM
  $entity_layer = array(
    'uuid' => 'fc5426f3-3182-439b-859e-a414df7911ee',
    'layer_name' => 'Example: OpenStreetMap',
    'layer_type' => 'tile',
    'layer_machine' => 'none',
    'layer_source_ref' => $osm_source_ID,
  );
  $new_entity = \Drupal::entityManager()->getStorage($layer)->create($entity_layer);
  $new_entity->save();
  $osm_layer_ID = $new_entity->id();

  //WMS
  $entity_layer = array(
    'uuid' => 'da67b3bd-6293-4782-b790-74ea39638742',
    'layer_name' => 'Example: L채rm Niedersachsen (gefunden im Geoportal.de)',
    'layer_type' => 'image',
    'layer_machine' => array('Mittlere_PM10_Belastung_2008',
      'Beurteilungsgebiete_Ballungsraeume',
      'Oekosystem_Schutzgebiete',
      'Grossfeuerungsanlagen',
      'Orte_mit_Luftschadstoffberechnung'),
    'layer_source_ref' => $wms_source_ID,
  );
  $new_entity = \Drupal::entityManager()->getStorage($layer)->create($entity_layer);
  $new_entity->save();
  $wms_layer_ID = $new_entity->id();

  //install Layeroptions
  //wms
  $entity_layeroptions = array(
    'uuid' => 'a3a537f9-08f9-4485-95fd-33ea46cb2d15',
    'layeroptions_name' => 'a3a537f9-08f9-4485-95fd-33ea46cb2d15',
    'layer_opacity' => 50,
    'layer_active' => TRUE,
    'layer_ref' => $wms_layer_ID,
  );
  $new_entity = \Drupal::entityManager()->getStorage($layeroptions)->create($entity_layeroptions);
  $new_entity->save();
  $wms_layeroptions_ID = $new_entity->id();
  
  //node
  $entity_layeroptions = array(
    'uuid' => '353d3edb-8510-4b30-b683-1d9654f57353',
    'layeroptions_name' => '353d3edb-8510-4b30-b683-1d9654f57353',
    'layer_opacity' => 50,
    'layer_active' => TRUE,
    'layer_ref' => $drupalnode_layer_ID,
  );
  $new_entity = \Drupal::entityManager()->getStorage($layeroptions)->create($entity_layeroptions);
  $new_entity->save();
  $drupalnode_layeroptions_ID = $new_entity->id();
  
  $entity_layeroptions = array(
    'uuid' => 'e9c6f0a3-1a33-4918-ba73-a704c2a362e2',
    'layeroptions_name' => 'e9c6f0a3-1a33-4918-ba73-a704c2a362e2',
    'layer_opacity' => 50,
    'layer_active' => TRUE,
    'layer_ref' => $drupalview_layer_ID,
  );
  $new_entity = \Drupal::entityManager()->getStorage($layeroptions)->create($entity_layeroptions);
  $new_entity->save();
  $drupalview_layeroptions_ID = $new_entity->id();
  
  //install Maps
  //Empty Map
  $entity_map = array(
    'uuid' => '117b1539-0d5b-4618-9f7f-1b15a1a4a0de',
    'map_name' => 'Example: EmptyMap',
    'zoom' => 10,
    'minzoom' => 1,
    'maxzoom' => 18,
    'map_height' => 432,
  );
  $new_entity = \Drupal::entityManager()->getStorage($map)->create($entity_map);
  $new_entity->save();
  //OSM
  $entity_map = array(
    'uuid' => '9fd09aae-53f8-4b5a-a160-a0cb12089e62',
    'map_name' => 'Example: OSM Map',
    'zoom' => 10,
    'minzoom' => 1,
    'maxzoom' => 18,
    'map_height' => 432,
    'layer_ref_base' => $osm_layer_ID,
  );
  $new_entity = \Drupal::entityManager()->getStorage($map)->create($entity_map);
  $new_entity->save();

  //OSM with Overlay (active)
  $entity_map = array(
    'uuid' => '3fc2004d-76a9-4b7b-ac56-867b130a794c',
    'map_name' => 'Example: OSM Map with wms - overlay',
    'zoom' => 10,
    'minzoom' => 1,
    'maxzoom' => 18,
    'map_height' => 432,
    'layer_ref_base' => $osm_layer_ID,
    'layer_ref_overlay' => [$wms_layeroptions_ID,$drupalnode_layeroptions_ID,$drupalview_layeroptions_ID],
  );
  $new_entity = \Drupal::entityManager()->getStorage($map)->create($entity_map);
  $new_entity->save();
}

function openlayers_examples_uninstall() {
  
  $storage_handler = \Drupal::entityTypeManager()->getStorage("node");
  $entities = $storage_handler->loadByProperties(["type" => "openlayers_example"]);
  $storage_handler->delete($entities);
  
  //Entity types
  $source = 'openlayers_source';
  $layer = 'openlayers_layer';
  $layeroptions = 'openlayers_layeroptions';
  $map = 'openlayers_map';

  //uninstall Layeroptions
  //WMS
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($layeroptions,'a3a537f9-08f9-4485-95fd-33ea46cb2d15');
  if(isset($entity)) {
    $entity->delete();
  }
  //Node
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($layeroptions,'353d3edb-8510-4b30-b683-1d9654f57353');
  if(isset($entity)) {
    $entity->delete();
  }
  //View
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($layeroptions,'e9c6f0a3-1a33-4918-ba73-a704c2a362e2');
  if(isset($entity)) {
    $entity->delete();
  }

  //uninstall Maps
  //EmptyMap
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($map,'117b1539-0d5b-4618-9f7f-1b15a1a4a0de');
  if(isset($entity)) {
    $entity->delete();
  }
  //OSM Map
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($map,'9fd09aae-53f8-4b5a-a160-a0cb12089e62');
  if(isset($entity)) {
    $entity->delete();
  }
  //OSM with Overlay
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($map,'3fc2004d-76a9-4b7b-ac56-867b130a794c');
  if(isset($entity)) {
    $entity->delete();
  }

  //uninstall Layers
  //Drupal - Node
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($layer,'1037b835-3990-48af-8cad-f44befb43aa6');
  if(isset ($entity)) {
    $entity->delete();
  }
  //Drupal - View
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($layer,'9ea34919-7c3e-4e98-a7cf-9b9d23ca2b6a');
  if(isset ($entity)) {
    $entity->delete();
  }
  //OSM
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($layer,'fc5426f3-3182-439b-859e-a414df7911ee');
  if(isset ($entity)) {
    $entity->delete();
  }

  //WMS
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($layer,'da67b3bd-6293-4782-b790-74ea39638742');
  if(isset($entity)) {
    $entity->delete();
  }

  //uninstall Sources
  //Drupal
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($source,'e87e0c81-a35e-4bd7-abba-2a21a3a11cff');
  if(isset($entity)) {
    $entity->delete();
  }
  //OSM
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($source,'f6effee4-e92a-4c40-8062-a525032d9309');
  if(isset($entity)) {
    $entity->delete();
  }

  //Example WMS
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($source,'9c33548b-7ac2-485b-8ec3-8cb003c41bc9');
  if(isset($entity)) {
    $entity->delete();
  }
  
  $entity = \Drupal::service('entity.repository')->loadEntityByUuid($source,'9c33548b-7ac2-486b-8ec3-8cb003c41bc9');
  if(isset($entity)) {
    $entity->delete();
  }
}

