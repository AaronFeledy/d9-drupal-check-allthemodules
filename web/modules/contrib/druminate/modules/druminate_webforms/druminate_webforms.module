<?php

/**
 * @file
 * Contains druminate_webforms.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_help().
 */
function druminate_webforms_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the druminate_webforms module.
    case 'help.page.druminate_webforms':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Allows webform submissions to be sent to Druminate Surveys.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_form_alter().
 *
 * Checks to see if form being render has a druminate donation handler attached
 * and adds the necessary js.
 */
function druminate_webforms_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  if (!empty($form['#webform_id'])) {
    $webform = \Drupal::entityTypeManager()->getStorage('webform')->load($form['#webform_id']);

    if ($handlers = $webform->getHandlers()) {
      if (isset($handlers->getIterator()['druminate_donation'])) {
        $donation_handler = $handlers->getIterator()['druminate_donation'];
        $donation_form_config = $donation_handler->getConfiguration();
        $donation_form_config['settings']['id'] = $form['#id'];

        if ($webform_settings = $webform->getSettings()) {
          $form['#attached']['drupalSettings']['druminateWebforms']['donationFormConfirmation'] = $webform_settings;
        }

        // Add Api settings to call Luminate Extend from the Client Side.
        $js_settings = [];
        if (\Drupal::config('druminate.settings')->get('secure_url')) {
          $js_settings['secure'] = \Drupal::config('druminate.settings')->get('secure_url');
        }
        if (\Drupal::config('druminate.settings')->get('non_secure_url')) {
          $js_settings['nonsecure'] = \Drupal::config('druminate.settings')->get('non_secure_url');
        }
        if (\Drupal::config('druminate.settings')->get('api_key')) {
          $js_settings['api_key'] = \Drupal::config('druminate.settings')->get('api_key');
        }
        if (\Drupal::config('druminate.settings')->get('test_mode')) {
          $js_settings['test_mode'] = \Drupal::config('druminate.settings')->get('test_mode');
        }

        // Attach the Luminate and Druminate Libs to handle form submission.
        $form['#attached']['library'][] = 'druminate_webforms/donation.forms';
        $form['#attached']['drupalSettings']['druminate']['settings'] = $js_settings;
        $form['#attached']['drupalSettings']['druminateWebforms']['donationFormSettings'] = $donation_form_config['settings'];

      }
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Adds messaging specific to the Druminate Donation Handler.
 */
function druminate_webforms_form_webform_settings_confirmation_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  drupal_set_message(t('Warning: Page and Url are the only supported Confirmation Types when using the Druminate Donation Handler.'), 'warning');
}
