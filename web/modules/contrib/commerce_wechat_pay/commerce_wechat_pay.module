<?php

/**
 * Implements hook_entity_load().
 * @param array $entities
 * @param $entity_type_id
 */
function commerce_wechat_pay_entity_load(array $entities, $entity_type_id) {
  if ($entity_type_id === 'commerce_payment') {
    /** @var \Drupal\commerce_payment\Entity\Payment $entity */
    foreach ($entities as $entity) {
      // We check if the order exists because this module can also be used as API for other module,
      // which doesn't necessarily create orders
      if ($entity->getRemoteState() === 'USERPAYING' && $entity->getOrder()) {
        /** @var \Drupal\commerce_wechat_pay\Plugin\Commerce\PaymentGateway\QRCodePaymentMode2 $wechat_pay */
        $wechat_pay = $entity->getPaymentGateway()->getPlugin();
        try {
          $wechat_pay->checkRemoteState($entity->getOrderId(), $entity);
        } catch (\Exception $e) {
          \Drupal::logger('commerce_wechat_pay')->error('Checking WeChat payment: '. $entity->id() . ' from Order '.$entity->getOrderId().' has failed: ' . $e->getMessage());
        }

      }
    }
  }

}