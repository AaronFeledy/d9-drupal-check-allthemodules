<?php

/**
 * @file
 * Contains no_admin_destination_redirect.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function no_admin_destination_redirect_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the no_admin_destination_redirect module.
    case 'help.page.no_admin_destination_redirect':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Disables the annoying ?destination=/admin/foo/bar redirects for admins when administering a Drupal 8 site.') . '</p>';
      $output .= '<p>' . t('E.g. there will be after editing & then saving a view, you will not be redirected back to the main views listing page.') . '</p>';
      $output .= '<p>' . t('This module only works if the current user is an administrator, and is only applied to admin pages.') . '</p>';
      $output .= '<p>' . t('You can exclude certain paths: /admin/config/no_admin_destination_redirect/config') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_link_alter().
 */
function no_admin_destination_redirect_link_alter(&$variables) {
  $current_uri = \Drupal::request()->getRequestUri();
  $current_user = \Drupal::currentUser();

  if (empty($current_uri) || empty($current_user)) {
    return FALSE;
  }

  $roles = $current_user->getRoles();

  if (empty($roles)) {
    return FALSE;
  }

  if (!substr( $current_uri, 0, 6 ) === "/admin/") {
    return FALSE;
  }

  if (!in_array('administrator', $roles)) {
    return FALSE;
  }

  $excluded_paths = \Drupal::config('no_admin_destination_redirect.settings');
  $excluded_paths = $excluded_paths->get('excluded_paths_config');

  if (!empty($excluded_paths)) {
    $excluded_paths = explode(PHP_EOL, $excluded_paths);

    if (in_array($current_uri, $excluded_paths)) {
      return FALSE;
    }
  }

  if (array_key_exists('destination', $variables['options']['query'])) {
    unset($variables['options']['query']['destination']);
  }
}
