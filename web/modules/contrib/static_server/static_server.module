<?php
/**
 * @file
 * Defines url for all the static files "static_server" module.
 */

/**
 * Implements hook_file_url_alter().
 * This function alter files url.
 */
function static_server_file_url_alter(&$uri) {
  global $base_url;
  $css_path = $base_url;
  $js_path = $base_url;
  $files_path = $base_url;
  $files_extensions = 'gif jpg jpeg png';
  $css_file_extensions = array('css');
  $js_file_extensions = array('js');

  if (!empty(\Drupal::config('static_server.settings')->get('static_server_css_path'))) {
    $css_path = \Drupal::config('static_server.settings')->get('static_server_css_path');
  }
  if (!empty(\Drupal::config('static_server.settings')->get('static_server_js_path'))) {
    $js_path = \Drupal::config('static_server.settings')->get('static_server_js_path');
  }
  if (!empty(\Drupal::config('static_server.settings')->get('static_server_files_path'))) {
    $files_path = \Drupal::config('static_server.settings')->get('static_server_files_path');
  }
  if (!empty(\Drupal::config('static_server.settings')->get('static_server_files_extension'))) {
    $files_extensions = \Drupal::config('static_server.settings')->get('static_server_files_extension');
    $files_extensions = explode(' ', $files_extensions);
  }

  // Serve only public files.
  $schemes = array('public');
  $scheme = file_uri_scheme($uri);

  // Only serve shipped files and public created files from the Static Server.
  if (!$scheme || in_array($scheme, $schemes)) {
    if (!$scheme) {
      $path = $uri;
    }
    else {
      // Public created files.
      $wrapper = \Drupal::service('stream_wrapper_manager')->getViaScheme($scheme);
      $path = $wrapper->getDirectoryPath() . '/' . file_uri_target($uri);
    }

    // Clean up Windows paths.
    $path = str_replace('\\', '/', $path);

    // Serve files with one of the files extensions from static servers.
    $pathinfo = pathinfo($path);
    if (isset($pathinfo['extension'])) {
      if (in_array($pathinfo['extension'], $css_file_extensions)) {
        $uri = $css_path . '/' . $path;
      }
      elseif (in_array($pathinfo['extension'], $js_file_extensions)) {
        $uri = $js_path . '/' . $path;
      }
      elseif (in_array($pathinfo['extension'], $files_extensions)) {
        $uri = $files_path . '/' . $path;
      }
      else {
        $uri = $base_url . '/' . $path;
      }
    }
  }
}
