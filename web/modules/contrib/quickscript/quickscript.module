<?php

/**
 * @file
 * Contains quickscript.module..
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\quickscript\Entity\QuickScript;

/**
 * Implements hook_help().
 */
function quickscript_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the quickscript module.
    case 'help.page.quickscript':
      return file_get_contents(__DIR__ . '/quickscript.help.html');
  }
}

/**
 * Implements hook_cron().
 */
function quickscript_cron() {
  $scripts = QuickScript::loadCronEnabled();
  foreach ($scripts as $script) {
    $cron_diff = 0;
    switch ($script->cron_run->value) {
      case QuickScript::CRON_EVERY_TIME:
        $cron_diff = 0;
        break;
      case QuickScript::CRON_EVERY_1HOUR:
        $cron_diff = 3600;
        break;
      case QuickScript::CRON_EVERY_3HOURS:
        $cron_diff = 3600 * 3;
        break;
      case QuickScript::CRON_EVERY_6HOURS:
        $cron_diff = 3600 * 6;
        break;
      case QuickScript::CRON_EVERY_12HOURS:
        $cron_diff = 3600 * 12;
        break;
      case QuickScript::CRON_EVERY_1DAY:
        $cron_diff = 3600 * 24;
        break;
    }
    if (\Drupal::time()
        ->getRequestTime() - $script->last_run->value >= $cron_diff) {
      $script->evalCode();
    }
  }
}

/**
 * This function can be called from within Quick Script code.
 *
 * This will inject the loaded quick script code into the current quick script
 * code base. This function does not actually do anything, it is replaced
 * dynamically before eval().
 *
 * @param string $machine_name
 *   Quick Script to load.
 *
 * @return bool
 */
function quickscript_include($machine_name) {
  return FALSE;
}

/**
 * Loads a Quick Script by it's machine name.
 *
 * @param string $machine_name
 *
 * @return QuickScript
 */
function quickscript_load($machine_name) {
  return QuickScript::loadByMachineName($machine_name);
}

/**
 * Loads a Quick Script by it's ID.
 *
 * @param int $entity_id
 *
 * @return QuickScript
 */
function quickscript_load_by_id($entity_id) {
  return QuickScript::load($entity_id);
}

/**
 *
 * @param string $machine_name
 *
 * @return mixed
 */
function quickscript_eval($machine_name) {
  $entity = quickscript_load($machine_name);
  if ($entity instanceof QuickScript) {
    return $entity->evalCode();
  }
  return FALSE;
}
