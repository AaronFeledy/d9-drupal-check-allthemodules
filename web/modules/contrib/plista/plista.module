<?php

use Drupal\Component\Utility\String;

/**
 * Implements hook_help().
 */
function plista_help($path, $arg) {
  switch ($path) {
    case 'admin/help#plista':
      return String::checkPlain(file_get_contents(dirname(__FILE__) . "/README.txt"));
  }
}

/**
 * Implements hook_menu().
 */
function plista_menu() {

  $items['admin/config/services/plista'] = array(
    'title' => 'Plista',
    'description' => 'Configure the plista module',
    'route_name' => 'plista.settings',
    'type' => MENU_NORMAL_ITEM,
  );

  return $items;
}


/**
 * Implements hook_permission().
 */
function plista_permission() {
  $permissions = array(
    'configure plista' => array(
      'title' => t('Configure Plista widget'),
    ),
  );
  return $permissions;
}

/**
 * Implements hook_field_extra_fields().
 */
function plista_field_extra_fields() {

  $config = \Drupal::config('plista.settings');
  $plista_basic = $config->get('plista_basic');

  $selected_node_types = isset($plista_basic['plista_node_types']) ? array_values($plista_basic['plista_node_types']) : array();

  $extra_fields = array();

  // Enable plista widget as field for selected node types.
  foreach ($selected_node_types as $bundle) {
    $extra_fields['node'][$bundle] = array(
      'display' => array(
        'plista_widget' => array(
          'label' => t('Plista widget'),
          'weight' => 0,
        ),
      ),
    );
  }


  return $extra_fields;
}

/**
 * Implements hook_node_view().
 */
function plista_node_view($node, $view_mode, $langcode) {

  $plista = \Drupal\plista\Plista::create($node);

  $node->content['plista_widget'] = $plista->view();
}

/**
 * Implements hook_node_update().
 */
function plista_node_update($node) {
  $plista = \Drupal\plista\Plista::create($node);
  $plista->update();
}

/**
 * Implements hook_node_delete().
 */
function plista_node_delete($node) {
  $plista = \Drupal\plista\Plista::create($node);
  $plista->delete();
}

/**
 * Implements hook_library_info().
 */
function plista_library_info() {

  $config = \Drupal::config('plista.settings');
  $plista_basic = $config->get('plista_basic');

  $js_url = $plista_basic['plista_javascript_url'];


  $module_path = drupal_get_path('module', 'plista');

  $libraries['plista.behavior'] = array(
    'title' => 'Drupal behavior to enable plista.',
    'version' => \Drupal::VERSION,
    'js' => array(
      $js_url => array(
        'type' => 'external',
      ),
      $module_path . '/js/plista.js' => array(),
    ),
  );

  return $libraries;
}
