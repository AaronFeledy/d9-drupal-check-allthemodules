<?php

/**
 * @file
 * Provides Drupal integration to Acobot.
 */

use Drupal\Component\Utility\Html;
use Drupal\Component\Utility\Unicode;
use Drupal\Core\Path;
use Drupal\Component\Serialization\Json;
use Drupal\Component\Utility;

/**
 * Implements hook_page_attachments().
 *
 */
function acobot_page_bottom(array &$attachments) {

  $account = \Drupal::currentUser();
  $config = \Drupal::config('acobot.settings');  
  $token =  (string) $config->get('acobot_token');
  $uid   = $account->id();
  if (!$uid){
    if ($token ) {
            $attachments['#attached']['library'][] = 'acobot/acobot-initialise';
            $attachments['#attached']['drupalSettings']['acobot']['src'] = 'https://acobot.ai/js/w?key='.$token;
    }
    else {
      global $base_url;
      $domain = acobot_url_domain($base_url);
      $script = $config->get('acobot_script');
      $config = \Drupal::service('config.factory');
      $config = $config->getEditable('acobot.settings');
      if (empty($script) || $domain != $config->get('acobot_domain')) {
        if (acobot_is_active_domain($domain)) {
           if ($script = acobot_js($domain)) {
            $config->set('acobot_domain', $domain)->save();
            $config->set('acobot_script', $script)->save();
           }
        }
      }
      if (!empty($script)){
        $src = '';   
        $doc = new DOMDocument();
        $doc->loadHTML($script);
        $tags = $doc->getElementsByTagName('script');
        foreach ($tags as $tag) {
          $src = $tag->getAttribute('src');
        }
          $attachments['#attached']['library'][] = 'acobot/acobot-initialise';
          $attachments['#attached']['drupalSettings']['acobot']['src'] = $src;
      }
    }
 }
}

function acobot_url_domain($url){
  $parse = parse_url($url);
  return $parse['host'];
}

function acobot_is_active_domain($domain){
  if (filter_var(gethostbyname($domain), FILTER_VALIDATE_IP)){
    return TRUE;
  }
  return false;
}


function acobot_js($domain){
  $url = 'https://acobot.ai/api/simple/bot/'.$domain;
  $curl = curl_init();
  $opt = array(
    CURLOPT_RETURNTRANSFER => 1,
    CURLOPT_USERAGENT => $domain,
    CURLOPT_FOLLOWLOCATION=>true,
    CURLOPT_URL => $url,
  );
  curl_setopt_array($curl, $opt);
  $json = curl_exec($curl);
  $arr = json_decode($json, true);
  curl_close($curl);
  if (!empty($arr['js'])){
    return $arr['js'];
  }
  return null;
}
