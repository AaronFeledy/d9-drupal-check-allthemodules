<?php

/**
 * @file clockpicker.module
 * Provides a clockpicker on date fields.
 */

use Drupal\clockpicker\Element\Datetime;
use Drupal\Core\Field\FieldDefinitionInterface;
use Drupal\Core\Field\WidgetInterface;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_element_info_alter().
 */
function clockpicker_element_info_alter(array &$info) {
  // Alter the datetime form element to allow a setting for use of the
  // clockpicker. Note that this is entirely separate from the clockpicker
  // form element we also provide.
  if (isset($info['datetime']['#process'])) {
    $info['datetime']['#process'][] = [Datetime::class, 'processClockpicker'];
  }
}

/**
 * Implements hook_field_widget_third_party_settings_form().
 */
function clockpicker_field_widget_third_party_settings_form(WidgetInterface $plugin, FieldDefinitionInterface $field_definition, $form_mode, $form, FormStateInterface $form_state) {
  $element = [];
  // Add a 'clockpicker' checkbox to the settings form for date field widgets.
  if ($plugin->getPluginId() == 'datetime_default' || $plugin->getPluginId() ==  'daterange_default') {
    $element['clockpicker'] = [
      '#type' => 'checkbox',
      '#title' => t('Use clockpicker for times'),
      '#default_value' => $plugin->getThirdPartySetting('clockpicker', 'clockpicker'),
    ];
  }
  return $element;
}

/**
 * Implements hook_field_widget_settings_summary_alter().
 */
function clockpicker_field_widget_settings_summary_alter(&$summary, $context) {
  // Append a message to the summary when an instance of foo_widget has
  // mysetting set to TRUE for the current view mode.
  if ($context['widget']->getPluginId() == 'datetime_default' || $context['widget']->getPluginId() ==  'daterange_default') {
    $use_clockpicker = !empty($context['widget']->getThirdPartySetting('clockpicker', 'clockpicker'));
    $summary[] = t('Use clockpicker for times: @use-clockpicker', [
      '@use-clockpicker' => ($use_clockpicker ? t('Yes') : 'No'),
    ]);
  }
}

/**
 * Implements hook_field_widget_form_alter().
 */
function clockpicker_field_widget_form_alter(&$element, &$form_state, $context) {
  if ($context['widget']->getPluginId() == 'datetime_default') {
    if (!empty($context['widget']->getThirdPartySetting('clockpicker', 'clockpicker'))) {
      $element['value']['#date_time_element'] = 'clockpicker';
    }
  }

  if ($context['widget']->getPluginId() == 'daterange_default') {
    if (!empty($context['widget']->getThirdPartySetting('clockpicker', 'clockpicker'))) {
      $element['value']['#date_time_element'] = 'clockpicker';
      $element['end_value']['#date_time_element'] = 'clockpicker';
    }
  }
}
