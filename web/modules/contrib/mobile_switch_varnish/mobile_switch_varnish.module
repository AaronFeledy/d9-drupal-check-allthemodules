<?php
/**
 * @file
 * Adds options for mobile theme switching == should only be used
 * together with the appropriate Varnish configuration which should
 * populate $_SERVER['HTTP_X_DEVICE'].
 */

/**
 * Implements hook_form_FORM_ID_alter().
 *
 * Add some mobile theme switching settings to the main theme admin page.
 */
function mobile_switch_varnish_form_system_themes_admin_form_alter(&$form, &$form_state, $form_id) {
  $theme_options = array();
  foreach (list_themes() as $theme_name => $theme_info) {
    if (!empty($theme_info->status)) {
      $theme_options[$theme_name] = $theme_info->info['name'];
    }
  }
  $mobile_switch_varnish_config = \Drupal::config('mobile_switch_varnish.settings');
  $form['mobile_switch_varnish'] = array(
    '#type' => 'details',
    '#title' => t('Mobile theme settings'),
    '#description' => t('Options for when a mobile device detected.
      Please ensure the Varnish configuration is correct and is adding the user agent to the hash.'
    ),
    '#open' => TRUE,
    '#weight' => -2,
  );
  // Set a default (fallback) mobile theme.
  $form['mobile_switch_varnish']['mobile_switch_varnish_theme_default'] = array(
    '#type' => 'select',
    '#title' => t('Default mobile theme'),
    '#description' => t('Select the default theme to use when a mobile device is detected.'),
    '#options' => $theme_options,
    '#default_value' => $mobile_switch_varnish_config->get('theme.default'),
  );
  // Provides an option to mobile switch on admin pages.
  $form['mobile_switch_varnish']['mobile_switch_varnish_use_on_admin_pages'] = array(
    '#type' => 'checkbox',
    '#title' => t('Use on admin pages'),
    '#description' => t('Use a mobile theme when using administration pages.'),
    '#default_value' => $mobile_switch_varnish_config->get('use_on_admin_pages'),
  );
  // Optionally allow to switch theme per device.
  foreach (array('smart', 'tablet', 'other') as $device_type) {
    $form['mobile_switch_varnish']['devices']['mobile_switch_varnish_theme_' . $device_type] = array(
      '#type' => 'select',
      '#title' => t('Mobile theme for: "@type"', array('@type' => $device_type)),
      '#options' => array('default' => t('Default')) + $theme_options,
      '#default_value' => $mobile_switch_varnish_config->get('theme.' . $device_type),
    );
  }
  // Wrap it in a neat fieldset if devices isn't empty.
  if (!empty($form['mobile_switch_varnish']['devices'])) {
    $form['mobile_switch_varnish']['devices'] += array(
      '#type' => 'details',
      '#title' => t('Per device settings'),
      '#description' => t('Choose a different theme per device if required:'),
      '#open' => TRUE,
    );
  }
  $form['#submit'][] = 'mobile_switch_varnish_form_system_themes_admin_form_submit';
}

/**
 * Form submission handler for system_themes_admin_form().
 *
 * @see mobile_switch_varnish_form_system_themes_admin_form_alter()
 */
function mobile_switch_varnish_form_system_themes_admin_form_submit($form, &$form_state) {
  $mobile_switch_varnish_config = \Drupal::config('mobile_switch_varnish.settings');
  $mobile_switch_varnish_config->set('use_on_admin_pages', $form_state['values']['mobile_switch_varnish_use_on_admin_pages']);
  foreach (array('default', 'smart', 'tablet', 'other') as $device_type) {
    $mobile_switch_varnish_config->set('theme.' . $device_type, $form_state['values']['mobile_switch_varnish_theme_' . $device_type]);
  }
  $mobile_switch_varnish_config->save();
}
