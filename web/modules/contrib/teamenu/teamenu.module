<?php

/**
 * @file
 * Module for providing expandable, responsive, accessible, keyable menus.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\block\Entity\Block;

/**
 * Implements hook_help().
 */
function teamenu_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the teamenu module.
    case 'help.page.teamenu':
      $output = '';
      $output .= '<h3>' . t('About TeaMenu') . '</h3>';
      $output .= '<p>' . t('TeaMenu is a Drupal 8 module for providing expandable, responsive, accessible, keyable menus.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_preprocess_HOOK().
 */
function teamenu_preprocess_block(&$variables) {
  if (isset($variables['base_plugin_id'])) {
    if ($variables['base_plugin_id'] == 'system_menu_block') {
      // Blocks coming from page manager widget does not have id.
      if (!empty($variables['elements']['#id'])) {
        $block = Block::load($variables['elements']['#id']);
        if ($teamenu = $block->getThirdPartySetting('teamenu', 'switch')) {
          if ($teamenu == 1) {
            $variables['attributes']['class'][] = 'menu-teamenu';
          }
          else {
            $variables['attributes']['class'][] = 'menu-not-teamenu';
          }
        }
        else {
          $variables['attributes']['class'][] = 'menu-not-teamenu';
        }
      }
      $variables['#attached']['library'][] = 'teamenu/teamenu-styling';
    }
  }
}

/**
 * Implements hook_form_FORM_ID_alter().
 */
function teamenu_form_block_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  if (isset($form['settings']['menu_levels'])) {
    if (\Drupal::currentUser()->hasPermission('administer teamenu')) {

      /** @var \Drupal\block\BlockInterface $block */
      $block = $form_state->getFormObject()->getEntity();

      // This will automatically be saved in the third party settings.
      $form['third_party_settings']['#tree'] = TRUE;

      // Add a checkbox to toggle TeaMenu functionality.
      $form['third_party_settings']['teamenu']['switch'] = array(
        '#type' => 'checkbox',
        '#title' => t('TeaMenu'),
        '#description' => t('Make this an expandable, responsive, accessible, keyable menu.'),
        '#default_value' => $block->getThirdPartySetting('teamenu', 'switch'),
      );
    }
  }
}

/**
 * Implements hook_theme_suggestions_HOOK() for blocks.
 */
function teamenu_theme_suggestions_block(array $variables) {
  $suggestions = array();
  if ($variables['elements']['#base_plugin_id'] == 'system_menu_block') {
    $suggestions[] = 'block__system_menu_block__teamenu';
  }
  return $suggestions;
}

/**
 * Implements hook_theme_suggestions_HOOK() for menus.
 */
function teamenu_theme_suggestions_menu(array $variables) {
  $suggestions = array();
  $suggestions[] = 'menu__teamenu';
  return $suggestions;
}
