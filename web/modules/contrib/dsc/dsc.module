<?php

/**
 * @file
 * DBLog selective cron module let you specify an different
 * numbers of entries for each type of watchdog entries.
 */
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;

/**
 * Implements hook_form_FORM_ID_alter() for system_logging_settings().
 */
function dsc_form_system_logging_settings_alter(&$form, $form_state) {
  $form['dblog_row_limit']['#disabled'] = TRUE;
  $form['dblog_row_limit']['#description'] = t('This setting is overriden by DB log selective cron module. <a href="@settings">Go to configuration page.</a>.', array('@settings' => Url::fromRoute('dsc.settings')->toString()));
}

/**
 * Implements hook_cron().
 */
function dsc_cron() {
  module_load_include('admin.inc', 'dblog');
  $filters = dblog_filters();
  foreach ($filters['type']['options'] as $type_name => $type_label) {
    foreach ($filters['severity']['options'] as $severity_id => $severity_name) {
      $config = \Drupal::config('dsc.settings');
      $name = strtolower(str_replace(' ', '_', 'dsc_num_' . $type_name . '_' . $severity_name));
      $row_limit = !is_null($config->get($name)) ? $config->get($name) : $config->get('default_row_limit');

      // Query adapted from dblog_cron.
      if ($row_limit > 0) {
        $min_row = db_select('watchdog', 'w')
                ->fields('w', array('wid'))
                ->orderBy('wid', 'DESC')
                ->range($row_limit - 1, 1)
                ->condition('type', $type_name)
                ->condition('severity', $severity_id)
                ->execute()->fetchField();

        if ($min_row) {
          db_delete('watchdog')
              ->condition('wid', $min_row, '<')
              ->condition('type', $type_name)
              ->condition('severity', $severity_id)
              ->execute();
        }
      }
    }
  }
}
