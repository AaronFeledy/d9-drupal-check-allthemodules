<?php

/**
 * @file
 * Contains social_migration.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function social_migration_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the social_migration module.
    case 'help.page.social_migration':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Use Drupal\'s <a href="https://www.drupal.org/docs/8/api/migrate-api/migrate-api-overview">Migrate API</a> to import social media feeds from Facebook, Twitter, and Instagram into Drupal nodes.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_cron().
 */
function social_migration_cron() {
  // Get all the migrations that belong to the social_migration groups.
  $migrationIds = \Drupal::service('entity.query')->get('migration')
    ->condition('migration_group', [
      'social_migration_facebook_feeds_group',
      'social_migration_instagram_feeds_group',
      'social_migration_twitter_feeds_group',
    ], 'IN')
    ->execute();

  // Load the base Migration entities.
  $migrations = \Drupal::service('entity_type.manager')->getStorage('migration')
    ->loadMultiple($migrationIds);

  // Filter the migrations to only those that should be run on the cron.
  $cronEnabledMigrations = array_filter($migrations, function ($migration) {
    if (
      (isset($migration->migration_tags['cron_enabled']) && $migration->migration_tags['cron_enabled'] === '1')
      || !isset($migration->migration_tags['cron_enabled'])) {
      return TRUE;
    }
    else {
      return FALSE;
    }
  });

  // Create a queue factory and load the cron-enabled migrations into it.
  $queueFactory = \Drupal::service('queue');
  $queue = $queueFactory->get('social_migration_cron_queue');
  foreach ($cronEnabledMigrations as $migration) {
    $queue->createItem(['id' => $migration->id()]);
  }
}
