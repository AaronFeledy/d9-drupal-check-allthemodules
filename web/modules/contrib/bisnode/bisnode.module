<?php

/**
 * @file
 * Contains bisnode.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\webform\WebformSubmissionForm;

/**
 * Implements hook_help().
 */
function bisnode_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the bisnode module.
    case 'help.page.bisnode':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Integrate with bisnode service') . '</p>';
      return $output;

    default:
  }
}


/**
 * Implements hook_webform_element_alter().
 *
 * Adds bisnode related classes to webform elements when the form is loaded.
 */
function bisnode_webform_element_alter(array &$element, FormStateInterface $form_state, array $context) {

  if (!isset($element['#webform_key'])) {
    return;
  }

  $formObject = $form_state->getFormObject();
  if (!$formObject instanceof WebformSubmissionForm) {
    return;
  }
  $webform_submission = $formObject->getEntity();
  $webform = $webform_submission->getWebform();

  // Is bisnode active for this form?
  if (!$webform->getThirdPartySetting('bisnode', 'active', FALSE)) {
    return;
  }

  // Are there any stored mappings for this form?
  $bisnode_stored_mappings = $webform->getThirdPartySetting('bisnode', 'mapping_fields', []);
  if (empty($bisnode_stored_mappings)) {
    return;
  }

  $field_name = $element['#webform_key'];

  foreach ($bisnode_stored_mappings as $i => $value) {
    $search_field = $value['search_field'];
    $mapping_fields = $value['mapping_fields'];

    if ($search_field === 'none') {
      // No search field has been set for this bisnode mapping group, so even if
      // bisnode is set to 'active', there's nothing we can do here.
      continue;
    }

    // Is this field set to be a source for this group?
    if ($search_field === $field_name) {
      // Yes, this is a source for this group, add an attribute.
      // @TODO webform composite elements might need better handling.
      if (!isset($element['#attributes']['class']) || !in_array("bisnode-source---$search_field", $element['#attributes']['class'])) {
        $element['#attributes']['class'][] = "bisnode-source---$search_field";
      }
    }
    else {
      // No, this is not a source for this group, it might be a target.
      if ( isset($mapping_fields[$field_name]) && $mapping_fields[$field_name] !== 'none' ) {
        // This is actually a target, add an attribute.
        $element['#attributes']['class'][] = "bisnode-target---{$mapping_fields[$field_name]}";
      }
    }
  }
}


/**
 * Implements hook_webform_submission_form_alter().
 */
function bisnode_webform_submission_form_alter(array &$form, FormStateInterface $form_state, $form_id) {
  $webform_submission = $form_state->getFormObject()->getEntity();
  $webform = $webform_submission->getWebform();

  // Is bisnode active for this form?
  if (!$webform->getThirdPartySetting('bisnode', 'active', FALSE)) {
    return;
  }

  // Are there any stored mappings for this form?
  $bisnode_stored_mappings = $webform->getThirdPartySetting('bisnode', 'mapping_fields', []);
  if (empty($bisnode_stored_mappings)) {
    return;
  }

  $attach_library = FALSE;

  $webform_id = $form['#webform_id'];

  foreach ($bisnode_stored_mappings as $i => $value) {
    $search_field = $value['search_field'];
    $mapping_fields = $value['mapping_fields'];

    if ($search_field === 'none') {
      // No search field has been set for this bisnode mapping group, so even if
      // bisnode is set to 'active', there's nothing we can do here.
      continue;
    }

    $attach_library = TRUE;

    $form['#attached']['drupalSettings']['bisnode']['webforms'][$webform_id][$i] = [
      'search_field' => $search_field,
      'mapping_fields' => $mapping_fields,
    ];
  }

  if ($attach_library) {
    $form['#attached']['library'][] = 'bisnode/bisnode.webapijs';
    $form['#attached']['drupalSettings']['bisnode']['general_settings']['loading_text'] = $webform->getThirdPartySetting('bisnode', 'loading_text', '');

    /** @var \Drupal\Core\Config\Config $config */
    $config = \Drupal::service('config.factory')->getEditable('bisnode.bisnodeconfig');
    $debug_js = $config->get('bisnode_debug_javascript');
    $form['#attached']['drupalSettings']['bisnode']['general_settings']['debug_js'] = $debug_js;
  }
}
