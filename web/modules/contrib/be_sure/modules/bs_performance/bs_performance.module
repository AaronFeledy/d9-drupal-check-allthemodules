<?php

/**
 * @file
 * Contains bs_performance.module.
 */

module_load_include('inc', 'bs_performance', 'bs_performance.module');
module_load_include('inc', 'bs_performance', 'bs_performance.cache');
module_load_include('inc', 'bs_performance', 'bs_performance.other');

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function bs_performance_help($route_name, RouteMatchInterface $route_match) {
  $output = '';
  switch ($route_name) {
    // Main module help for the bs_performance module.
    case 'help.page.bs_performance':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Be sure about performance part of your Drupal site.') . '</p>';

    default:
  }

  return $output;
}

/**
 * Implements hook_sure_info().
 */
function bs_performance_sure_info() {
  $items['performance'] = [
    'title' => 'Performance',
    'description' => 'Be sure about performance part of your Drupal site.',
    'elements' => [
      bs_performance_cache(),
      bs_performance_module(),
      bs_performance_other(),
    ],
  ];

  return $items;
}

/**
 * Describe sure points of cache.
 *
 * @return array
 *   Items of Cache category
 */
function bs_performance_cache() {
  return [
    'title' => 'Cache',
    'items' => [
      [
        'ok' => 'Page caching enabled',
        'nok' => 'Page caching is not enabled',
        'callback' => 'bs_performance_cache_caching',
      ],
      [
        'ok' => 'Block caching enabled',
        'nok' => 'Block caching is not enabled',
        'callback' => 'bs_performance_cache_block',
      ],
      [
        'ok' => '%module module enabled and configured',
        'nok' => '%module module disabled or not well configured',
        'callback' => 'bs_performance_cache_varnish',
        'args' => [
          '%module' => be_sure_link_from_uri('Varnish', 'https://www.drupal.org/project/varnish'),
        ],
      ],
      [
        'ok' => 'Minimum cache lifetime greater than 0',
        'nok' => 'The minimum cache lifetime is 0',
        'callback' => 'bs_performance_cache_min_lifetime',
      ],
      [
        'ok' => 'Page cache max age 5 minutes or greater',
        'nok' => 'Page cache max age less than 5 minutes',
        'callback' => 'bs_performance_cache_max_age',
      ],
      [
        'ok' => '%memcache or %redis module is enabled',
        'nok' => '%memcache or %redis module disabled',
        'callback' => 'bs_performance_cache_memcache_redis',
        'args' => [
          '%memcache' => be_sure_link_from_uri('Memcache', 'https://www.drupal.org/project/memcache'),
          '%redis' => be_sure_link_from_uri('Redis', 'https://www.drupal.org/project/redis'),
        ],
      ],
    ],
  ];
}

/**
 * Describe sure points of modules.
 *
 * @return array
 *   Items of Modules category
 */
function bs_performance_module() {
  return [
    'title' => 'Modules',
    'items' => [
      [
        'ok' => '%module module enabled',
        'nok' => '%module module is not enabled',
        'callback' => 'bs_performance_module_fast_404',
        'args' => [
          '%module' => be_sure_link_from_uri('Fast 404', 'https://www.drupal.org/project/fast_404'),
        ],
      ],
      [
        'ok' => 'Database logging module disabled',
        'nok' => 'Database logging module enabled',
        'callback' => 'bs_performance_module_dblog',
      ],
      [
        'ok' => '%module module disabled',
        'nok' => '%module module enabled',
        'callback' => 'bs_performance_module_backup',
        'args' => [
          '%module' => be_sure_link_from_uri('Backup and Migrate', 'https://www.drupal.org/project/backup_migrate'),
        ],
      ],
      [
        'ok' => '%module module is not enabled',
        'nok' => '%module module enabled',
        'callback' => 'bs_performance_module_coder',
        'args' => [
          '%module' => be_sure_link_from_uri('Coder', 'https://www.drupal.org/project/coder'),
        ],
      ],
      [
        'ok' => 'Update manager module disabled',
        'nok' => 'Update manager module enabled',
        'callback' => 'bs_performance_module_update',
      ],
      [
        'ok' => '%module module is not enabled',
        'nok' => '%module module enabled',
        'callback' => 'bs_performance_module_simpletest',
        'args' => [
          '%module' => be_sure_link_from_uri('SimpleTest', 'https://www.drupal.org/project/simpletest'),
        ],
      ],
      [
        'ok' => '%module module enabled',
        'nok' => '%module module disabled',
        'callback' => 'bs_performance_module_image_resize_filter',
        'args' => [
          '%module' => be_sure_link_from_uri('Image Resize Filter', 'https://www.drupal.org/project/image_resize_filter'),
        ],
      ],
      [
        'ok' => '%module module enabled',
        'nok' => '%module module disabled',
        'callback' => 'bs_performance_module_imageapi_optimize',
        'args' => [
          '%module' => be_sure_link_from_uri('ImageAPI Optimize (or Image Optimize)', 'https://www.drupal.org/project/imageapi_optimize'),
        ],
      ],
    ],
  ];
}

/**
 * Describe sure points of other.
 *
 * @return array
 *   Items of Other category
 */
function bs_performance_other() {
  return [
    'title' => 'Other',
    'items' => [
      [
        'ok' => 'Cron ran in the past day',
        'nok' => 'Cron did not run in the past day',
        'callback' => 'bs_performance_other_last_cron',
      ],
      [
        'ok' => 'CSS optimization enabled',
        'nok' => 'CSS optimization not enabled',
        'callback' => 'bs_performance_other_css',
      ],
      [
        'ok' => 'Page compression enabled',
        'nok' => 'Page compression disabled',
        'callback' => 'bs_performance_other_page_compression',
      ],
      [
        'ok' => 'JavaScript optimization enabled',
        'nok' => 'JavaScript optimization not enabled',
        'callback' => 'bs_performance_other_js',
      ],
      [
        'ok' => 'PHP cache extension enabled',
        'nok' => 'PHP cache extension is not enabled',
        'callback' => 'bs_performance_other_php_apc',
      ],
      [
        'ok' => 'PHP maximum execution time less than 300 seconds',
        'nok' => 'PHP maximum execution time greater or equal than 300 seconds',
        'callback' => 'bs_performance_other_max_execution',
      ],
      [
        'ok' => 'Compressing CSS and JS via "%module" configured',
        'nok' => 'Compressing CSS and JS via "%module" not well configured',
        'callback' => 'bs_performance_other_advagg',
        'args' => [
          '%module' => be_sure_link_from_uri('Advanced CSS/JS Aggregation', 'https://www.drupal.org/project/advagg'),
        ],
      ],
    ],
  ];
}
