<?php

/**
 * @file
 * Allow users to define a scheduled maintenance.
 */

/**
 * Implements hook_form_FORM_ID_alter().
 */
function scheduled_maintenance_form_system_site_maintenance_mode_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  $form['scheduled_maintenance'] = array(
    '#type' => 'fieldset',
    '#title' => t('Scheduled maintenance'),
    '#description' => t('Schedule a maintenance and show site visitors warning message in advance.'),
  );

  $form['scheduled_maintenance']['scheduled_maintenance_time'] = array(
    '#type' => 'textfield',
    '#title' => t('Maintenance time'),
    '#default_value' => \Drupal::config('scheduled_maintenance.settings')
      ->get('time'),
    '#description' => t('Schedule a maintenance by entering the maintenance start. Format: %time (YYYY-MM-DD hh:mm:ss). Leave blank to disable scheduled maintenance.', array('%time' => format_date(time(), 'custom', 'Y-m-d H:i:s'))),
    '#size' => 20,
    '#element_validate' => array('_scheduled_maintenance_element_validate_date'),
  );

  $form['scheduled_maintenance']['scheduled_maintenance_message'] = array(
    '#type' => 'textfield',
    '#title' => t('Message'),
    '#default_value' => \Drupal::config('scheduled_maintenance.settings')
      ->get('message'),
    '#description' => t('Warning message for site visitors about the upcoming maintenance. No HTML tags allowed.'),
  );

  $form['scheduled_maintenance']['scheduled_maintenance_message_offset'] = array(
    '#type' => 'item',
    '#title' => t('Show message'),
    '#description' => t('How long before the scheduled maintenance the warning message should appear. Leave blank to disable message.'),
  );

  $form['scheduled_maintenance']['scheduled_maintenance_message_offset']['container'] = array(
    '#type' => 'container',
    '#attributes' => array(
      'class' => array('container-inline'),
    ),
  );

  $form['scheduled_maintenance']['scheduled_maintenance_message_offset']['container']['scheduled_maintenance_message_offset_value'] = array(
    '#title' => t('Message time'),
    '#title_display' => 'invisible',
    '#type' => 'textfield',
    '#default_value' => \Drupal::config('scheduled_maintenance.settings')
      ->get('offset.value'),
    '#size' => 3,
    '#element_validate' => array('element_validate_integer_positive'),
  );

  $form['scheduled_maintenance']['scheduled_maintenance_message_offset']['container']['scheduled_maintenance_message_offset_unit'] = array(
    '#type' => 'select',
    '#options' => _scheduled_maintenance_get_allowed_units(),
    '#default_value' => \Drupal::config('scheduled_maintenance.settings')
      ->get('offset.unit'),
    '#field_suffix' => t('before'),
  );

  $form['#submit'][] = 'scheduled_maintenance_form_submit';
}

function scheduled_maintenance_form_submit(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  $config = \Drupal::service('config.factory')->getEditable('scheduled_maintenance.settings');
  $config
    ->set('time', $form_state->getValue('scheduled_maintenance_time'))
    ->set('message', $form_state->getValue('scheduled_maintenance_message'))
    ->set('offset.value', $form_state->getValue('scheduled_maintenance_message_offset_value'))
    ->set('offset.unit', $form_state->getValue('scheduled_maintenance_message_offset_unit'))
    ->save();
}

/**
 * Helper function to validate the format of a date in a form field.
 *
 * To be used in forms with the "#element_validate" attribute. An empty value is
 * considered valid.
 *
 * @param array $element
 *   The form element.
 */
function _scheduled_maintenance_element_validate_date($element, \Drupal\Core\Form\FormStateInterface &$form_state, $form) {
  $date = trim($element['#value']);

  if ($date && !_scheduled_maintenance_validate_date($date)) {
    $form_state->setError($element, t('%name must be in format YYYY-DD-MM hh:mm:ss.', array('%name' => $element['#title'])));
  }
}

/**
 * Helper function to validate that a date string is in the correct format.
 *
 * @param string $date
 *   The date string to validate.
 * @param string $format
 *   (optional) The PHP date format in which $date should follow. Defaults to
 *   "Y-m-d H:i:s", which is equivalent to "YYYY-MM-DD hh:mm:ss".
 *
 * @return bool
 *   TRUE if $date is in correct format, otherwise FALSE.
 *
 * @see http://www.php.net/manual/en/function.date.php
 */
function _scheduled_maintenance_validate_date($date, $format = 'Y-m-d H:i:s') {
  $d = DateTime::createFromFormat($format, $date);
  return $d && $d->format($format) == $date;
}

/**
 * Helper function to get allowed units for message time offset field.
 *
 * @return array
 *   Returns an associative array of allowed units.
 */
function _scheduled_maintenance_get_allowed_units() {
  return array(
    'days' => t('day(s)'),
    'hours' => t('hour(s)'),
    'minutes' => t('minute(s)'),
    'seconds' => t('second(s)'),
  );
}

/**
 * Implements hook_variable_info().
 */
function scheduled_maintenance_variable_info($options) {
  $variable['scheduled_maintenance_message'] = array(
    'type' => 'string',
    'title' => t('Scheduled maintenance message', array(), $options),
    'description' => t('Warning message for site visitors about the upcoming maintenance.', array(), $options),
    'group' => 'site_information',
  );
  return $variable;
}
