<?php

/**
 * @file
 * Drupal Module: Inspectlet.
 *
 * Adds the required Javascript to all your Drupal pages to allow
 * tracking by Inspectlet (https://www.inspectlet.com/
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Component\Utility\Unicode;

/**
 * Implements hook_help().
 */
function inspectlet_help($route_name, RouteMatchInterface $route_match) {

  switch ($route_name) {
    case 'help.page.inspectlet':
      return '<p>' . t('<a href="@inspectlet_url">Inspeclet</a> is a free (registration required) website user-interaction suite for your site.', ['@inspectlet_url' => 'https://www.inspectlet.com/']);
  }
}

/**
 * Implements hook_page_attachments().
 *
 * Insert JavaScript to the <head> tag of the page.
 */
function inspectlet_page_attachments(array &$attachments) {

  $settings = \Drupal::config('inspectlet.settings');

  // Check install code.
  if (empty($settings->get('install_code'))) {
    return;
  }

  // Check pages.
  if ($pages = $settings->get('pages')) {

    $path = \Drupal::service('path.current')->getPath();

    $path_alias = Unicode::strtolower(\Drupal::service('path.alias_manager')
      ->getAliasByPath($path));

    $path_match = \Drupal::service('path.matcher')
      ->matchPath($path_alias, $pages);

    $alias_match = (($path != $path_alias) && \Drupal::service('path.matcher')
      ->matchPath($path, $pages));

    $page_match = $path_match || $alias_match;

    if (($settings->get('visibility_pages') == 'exclude_listed' && $page_match) || ($settings->get('visibility_pages') == 'include_listed' && !$page_match)) {
      return;
    }
  }

  // Check roles.
  // If not all values in the array are the same ('0').
  if ((count(array_unique($settings->get('roles'))) === 1 && end($settings->get('roles')) === '0') == FALSE) {

    $current_user = \Drupal::currentUser();
    $roles        = $current_user->getRoles();

    $intersect = array_intersect($roles, $settings->get('roles'));
    if (empty($intersect)) {
      return;
    }
  }

  $attachments['#attached']['drupalSettings']['inspectlet']['installCode'] = $settings->get('install_code');

  $attachments['#attached']['library'][] = 'inspectlet/inspectlet';
}
