<?php
/**
 * Use case: Open Graph image with default fallback.
 * How to use:
 * [node:field_og_image:entity:url|node:field_header_image:entity:url]
 */

/**
 * Implements hook_tokens().
 */
function token_or_tokens_pre_alter (&$text, $data, $options) {
  $matches = [];

  preg_match("/\[[^\]]*\]/", $text, $matches);

  foreach ($matches as $match) {
    if (strpos($match, '|') !== FALSE) {
      $match_clean = substr(substr($match, 1), 0, -1);
      $sub_tokens = explode('|', $match_clean);

      $multi_token_matches = [];

      foreach ($sub_tokens as $sub_token) {
        $result = \Drupal::token()->replace('[' . $sub_token . ']', $data, $options);
        if ($result) {
          $multi_token_matches[] = $result;
        }
      }

      if (count($multi_token_matches)) {
        $text = str_replace($match, $multi_token_matches[0], $text);
      }
    }
  }
}