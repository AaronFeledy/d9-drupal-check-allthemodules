<?php

use Drupal\Core\Entity\ContentEntityFormInterface;
use Drupal\Core\Entity\ContentEntityInterface;
use Drupal\Core\Entity\EntityChangedInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_alter().
 */
function entity_form_monitor_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  $form_class = $form_state->getFormObject();
  if ($form_class instanceof ContentEntityFormInterface) {
    _entity_form_monitor_process_entity_form($form, $form_class->getEntity());
  }
}

/**
 * Implements hook_inline_entity_form_entity_form_alter().
 */
function entity_form_monitor_inline_entity_form_entity_form_alter(&$entity_form, FormStateInterface $form_state) {
  _entity_form_monitor_process_entity_form($entity_form, $entity_form['#entity']);
}

/**
 * Add entity monitoring to a form.
 *
 * @param array $form
 *   Nested array of form elements that comprise the entity form.
 * @param \Drupal\Core\Entity\EntityInterface $entity
 *   The entity that corresponds to the form.
 */
function _entity_form_monitor_process_entity_form(array &$form, EntityInterface $entity) {
  if (!$entity->isNew() && $entity instanceof ContentEntityInterface && $entity instanceof EntityChangedInterface) {
    $config = \Drupal::config('entity_form_monitor.settings');

    // If the configured entities is empty, then all entity types are allowed.
    // Otherwise check if the specific entity type and bundle has been enabled.
    $allowed_entities = $config->get('entities');
    if (!empty($allowed_entities) && empty($allowed_entities[$entity->getEntityTypeId() . ':' . $entity->bundle()])) {
      return;
    }

    $interval = $config->get('interval');
    if (empty($interval)) {
      return;
    }

    // Combine the entity type and ID into one string so it is less data to
    // pass around.
    $form['#attributes']['data-entity-form-monitor'] = $entity->getEntityTypeId() . ':' . $entity->id();
    // Add the timestamp for when the entity was last changed so we can
    // compare it vs the timestamp from the monitoring AJAX request.
    $form['#attributes']['data-entity-last-changed'] = $entity->getChangedTime();
    $form['#attached']['drupalSettings']['entityFormMonitor']['interval'] = $interval;
    $form['#attached']['library'][] = 'entity_form_monitor/monitor';

    // Merge the config cache info into the form.
    \Drupal::service('renderer')->addCacheableDependency($form, $config);
  }
}
