<?php
/**
 * @file
 * Module Ajax screen lock.
 */

// Shows this ajax on every page except the listed pages.
define('AJAX_SCREEN_LOCK_VISIBILITY_NOTLISTED', 0);
// Shows this ajax on only the listed pages.
define('AJAX_SCREEN_LOCK_VISIBILITY_LISTED', 1);

/**
 * Implements hook_page_attachments().
 */
function ajax_screen_lock_page_attachments(array &$attachments) {
  $config = \Drupal::configFactory()->getEditable('ajax_screen_lock.settings');
  $path_matcher = \Drupal::service('path.matcher');

  $pages = $config->get('pages_path');
  $ignore = $config->get('path_ignore');
  $path = ltrim(\Drupal::service('path.current')->getPath(), '/');

  // Checks to see if the page matches the current settings.
  if ($ignore) {
    if ($result = $path_matcher->matchPath($path, $ignore)) {
      return;
    }
  }

  // If we have specified pages, we should activate ajax screen lock only on these pages.
  if ($pages) {
    if (!$result = $path_matcher->matchPath($path, $pages)) {
      return;
    }
  }

  // Handle ajax request paths.
  $ajax_pages = $config->get('request_path');
  $pages = explode("\n", str_replace(array("\r\n", "\n\r"), "\n", $ajax_pages));
  $pages = array_filter($pages);

  $message = [
    'message' => [
      '#theme' => 'ajax_screen_lock_popup',
      '#title' => $config->get('popup_title')
    ]
  ];

  // Disable for admin pages if appropriate flag was enabled.
  $route_options = \Drupal::routeMatch()->getRouteObject()->getOptions();
  $disabled = $config->get('disable_in_admin') && !empty($route_options['_admin_route']);

  if (!$disabled) {
    // Add required libraries.
    $attachments['#attached']['library'][] = 'ajax_screen_lock/jquery-blockui';
    $attachments['#attached']['library'][] = 'ajax_screen_lock/ajax-screen-lock';
    $attachments['#attached']['drupalSettings'] = [
      'ajaxScreenLock' => [
        'message' => \Drupal::service('renderer')->renderRoot($message),
        'timeout' => $config->get('popup_timeout'),
        'visibility' => $config->get('request_visibility'),
        'throbber_hide' => $config->get('throbber_hide'),
        'pages' => $pages,
      ]
    ];
  }
}

/**
 * Implements hook_theme();
 */
function ajax_screen_lock_theme() {
  return array(
    'ajax_screen_lock_popup' => array(
      'variables' => array(
        'title' => NULL,
      ),
      'path' => drupal_get_path('module', 'ajax_screen_lock') . '/theme',
      'template' => 'ajax-screen-lock-popup',
    ),
  );
}
