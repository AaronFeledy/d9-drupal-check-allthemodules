<?php

/**
 * @file
 * Defines url for all the static files "special_taxonomy_tagging_in_body".
 */
use Drupal\Core\Url;
use Drupal\Core\Entity\EntityInterface;
use Drupal\node\Entity\Node;
/**
 * Implements hook_entity_insert().
 *
 * This function add node insert and replace taging with name.
 */

function special_taxonomy_tagging_in_body_node_insert(Drupal\Core\Entity\EntityInterface $node) {

    $config = \Drupal::config('special_taxonomy_tagging_in_body.settings');

$symbol = $config->get('special_taxonomy_tagging_in_body_special_taging');

 $taxonomy = array_filter($config->get('taxonomy_list'));


$special_taxonomy_tagging_in_body_target = $config->get('special_taxonomy_tagging_in_body_target');

  // Define preg replace patteren.
  $patterns = [];
  $replacements = [];

  // Make tagging with search and replace pattern in body field.
  foreach ($taxonomy as $value) {
    $term = \Drupal::entityManager()->getStorage("taxonomy_term")->loadTree($value);
    foreach ($term as $value) {
     //$patterns[] = '/' . $symbol . $value->name . '(\s{1}|$)/i';

      $patterns[] = $symbol . $value->name;
      $text = $value->name;
       $url = Url::fromUri($GLOBALS['base_url'].'/taxonomy/term/' . $value->tid);
      $external_link = \Drupal::l($text, $url);
      
      $replacements[] = $external_link;

    }
  }

if (in_array($node->getType(), array_values(array_filter($config->get('select_node_types'))))) {
  dpm($node);

    
      $body = $node->body[0]->value;
   
    //$result = preg_replace($patterns, $replacements, $body);
      
    $result = str_ireplace($patterns, $replacements, $body);

               $node = Node::load($node->id());
                $node->set("body", $result);
                $node->body->format = "full_html";
                 $node->save();

    }
}

/**
 * Implements hook_entity_update().
 *
 * This function add node insert and replace taging with name.
 */
function special_taxonomy_tagging_in_body_node_update(Drupal\Core\Entity\EntityInterface $node) {

$config = \Drupal::config('special_taxonomy_tagging_in_body.settings');
  
$symbol = $config->get('special_taxonomy_tagging_in_body_special_taging');
  
 $taxonomy = array_filter($config->get('taxonomy_list'));

  
$special_taxonomy_tagging_in_body_target = $config->get('special_taxonomy_tagging_in_body_target');

  // Define preg replace patteren.
  $patterns = [];
  $replacements = [];

  // Make tagging with search and replace pattern in body field.
  foreach ($taxonomy as $value) {
    $term = \Drupal::entityManager()->getStorage("taxonomy_term")->loadTree($value);
    foreach ($term as $value) {
      //$patterns[] = '/' . $symbol . $value->name . '(\s{1}|$)/i';
      $patterns[] = $symbol . $value->name;
      $text = $value->name;
       $url = Url::fromUri($GLOBALS['base_url'].'/taxonomy/term/' . $value->tid);
      $external_link = \Drupal::l($text, $url);
      
      $replacements[] = $external_link;

      
    }
  }

if (in_array($node->getType(), array_values(array_filter($config->get('select_node_types'))))) {
   $body = $node->body[0]->value;
    //$result = preg_replace($patterns, $replacements, $body);
    $result = str_ireplace($patterns, $replacements, $body);

       //$node = \Drupal::entityManager()->getStorage('node')->load(1);
          $node = Node::load($node->id()); 
          $node->set('body',$result);
          $node->body->format = "full_html";
          $node->save();
  }

}