<?php
/**
 * @file
 * DROWL media enhancements.
 */

function drowl_media_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  // Only allow a subset of image styles in the media embed widget for image preview.
  if (strpos($form_id, 'entity_embed_dialog') === 0) {
    if (!empty($form['attributes']['data-entity-embed-display-settings']['image_style'])) {
      $image_styles = $form['attributes']['data-entity-embed-display-settings']['image_style']['#options'];
      $allowed_image_styles = [
        'max_325x325' => 'Max. 325x325',
        'max_650x650' => 'Max. 650x650',
        'max_1300x1300' => 'Max. 1300x1300',
        'max_2600x2600' => 'Max. 2600x2600',
      ];
      $form['attributes']['data-entity-embed-display-settings']['image_style']['#options'] = array_intersect_key($image_styles, $allowed_image_styles);
    }
    // TODO - ensure this is really required. #webksde#TF added this but isn't sure anymore where or why. Until that we decided to disable this:
    // $form['#attached']['library'][] = 'drowl_media/drowl-media-library';
  }
}


/**
 * Implements hook_views_pre_render().
 */
function drowl_media_views_pre_render(\Drupal\views\ViewExecutable $view) {
  if (isset($view) && ($view->storage->id() == 'media_library')) {
    // Attach on view:
    $view->element['#attached']['library'][] = 'drowl_media/drowl-media-library';
  }
}

/**
 * Implements hook_field_widget_form_alter().
 */
function drowl_media_field_widget_form_alter(&$element, \Drupal\Core\Form\FormStateInterface $form_state, $context) {
  if (!empty($context['widget']) && $context['widget']->getPluginId() == 'entity_browser_entity_reference') {
    // Attach in media library widget:
    $element['#attached']['library'][] = 'drowl_media/drowl-media-library';
  }
}