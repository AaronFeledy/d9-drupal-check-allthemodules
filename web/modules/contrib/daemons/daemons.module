<?php

/**
 * @file
 * Contains daemons.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function daemons_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the daemons module.
    case 'help.page.daemons':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Daemons') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_cron().
 */
function daemons_cron() {
  // Current time.
  $current_time = \Drupal::time()->getCurrentTime();
  // Sending letter if daemon is broken.
  $cron_timestamp = \Drupal::state()->get('daemons.last_run_timestamp') ?: 0;
  if (($current_time - $cron_timestamp) >= 60 * 60) {
    $plugin_service = \Drupal::service('plugin.manager.daemon');
    foreach ($plugin_service->getDefinitions() as $plugin_id => $plugin) {
      // Check if daemon is broken and start it if is true.
      $daemon_manager = \Drupal::service('daemon.manager');
      if ($daemon_manager->isBroken($plugin_id)) {
        $daemon_manager->daemonExecute('start', $plugin_id);
      }
    }

    \Drupal::state()->set('daemons.last_run_timestamp', $current_time);
  }
}
