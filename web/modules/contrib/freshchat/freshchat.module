<?php
/**
 * @file
 * Integrates Freshchat widget.
 */

/**
 * Implements hook_page_attachments().
 */
function freshchat_page_attachments(array &$attachments) {
  // Get our freshchat configuration.
  $config = \Drupal::config('freshchat.settings');
  // Add our freshchat required js.
  $attachments['#attached']['library'][] = 'freshchat/widget';

  // Only show widget to logged in users.
  if (\Drupal::currentUser()->isAnonymous() && !empty($config)) {
    $freshchat_js = 'window.fcSettings = {
      token: "'. $config->get('token') .'",
      host: "https://wchat.freshchat.com"
    };';
    // As the freshchat JS has to be inline, add it to just after <head>.
    $attachments['#attached']['html_head'][] = [
      [
        '#type' => 'html_tag',
        '#tag' => 'script',
        '#value' => $freshchat_js,
      ],
      'freshchat',
    ];
  }
  else if (\Drupal::currentUser()->isAuthenticated() && $config->get('logged_in') == TRUE) {
    $freshchat_js = 'window.fcSettings = {
      token: "'. $config->get('token') .'",
      host: "https://wchat.freshchat.com"
    };';
    // As the freshchat JS has to be inline, add it to just after <head>.
    $attachments['#attached']['html_head'][] = [
      [
        '#type' => 'html_tag',
        '#tag' => 'script',
        '#value' => $freshchat_js,
      ],
      'freshchat',
    ];
  }

}
