<?php

/**
 * @file
 * Generate reports on the amount of available disk space.
 *
 * @author David Kent Norman http://deekayen.net/
 */

/**
 * Implements hook_cron().
 */
function diskfree_cron() {
  $config = \Drupal::config('diskfree.settings');
  $last_cron = $config->get('last_cron');
  $email_freq = $config->get('alert_email_freq');
  $reported_space = diskfree_check_space();
  foreach ($reported_space as $mount) {
    // Send alert e-mail if disk space used is over the set threshold. The
    // alert e-mail frequency configuration is taken into consideration to
    // prevent too many e-mails from being sent per partition.
    if (_diskfree_over_threshold($mount[1])) {
      if (time() > ($last_cron[$mount[2]] + $email_freq)) {
        $last_cron[$mount[2]] = time();
        $mail = $config->get('alert_email');
        drupal_mail('diskfree', 'alert', $mail, \Drupal::languageManager()->getDefaultLanguage()->id, array('mount' => $mount));
        $config->set('last_cron', $last_cron)->save();
      }
    }
  }
}

/**
 * Implements hook_mail().
 */
function diskfree_mail($key, &$message, $params) {
  $hostname = rtrim(`hostname`);
  $langcode = $message['langcode'];
  $message['subject'] = t('Alert: @hostname is @percent full', array('@hostname' => $hostname, '@percent' => $params['mount'][1]), $langcode);
  $message['body'][] = t('Running out of space @partition (@percent used, @free avail) on @hostname for @site_name', array(
    '@hostname' => $hostname,
    '@percent' => $params['mount'][1],
    '@free' => $params['mount'][0],
    '@partition' => $params['mount'][2],
    '@site_name' => \Drupal::config('system.site')->get('name'),
    ), $langcode);
}

/**
 * Checks disk space available on each disk partition.
 *
 * @return array
 *   An array of statistics about the amount of free disk space containing:
 *     - 0 = Free space in human-readable bytes.
 *     - 1 = Used percentage.
 *     - 2 = Partition name.
 */
function diskfree_check_space() {
  // Run df on Mac OS X (Darwin) systems.
  if (PHP_OS == 'Darwin') {
    $space_list = rtrim(`df -lH  | grep -vE '^Filesystem|none|cdrom|shm|varrun|varlock|udev|ExpanDrive|MobileBackups' | awk '{ printf("%s,", $4) } { printf("%s,", $5) } { for(i=9;i<=NF;++i) printf("%s", \$i) } { printf("\\n") }'`);
  }
  // Run df on Linux systems.
  else {
    $space_list = rtrim(`df -lH  | grep -vE '^Filesystem|none|cdrom|shm|varrun|varlock|udev' | awk '{ print $4 "," $5 "," $6 }'`);
  }
  $space_array = explode("\n", $space_list);
  $reported_space = array();
  foreach ($space_array as $space_line) {
    $reported_space[] = explode(',', $space_line);
  }
  return $reported_space;
}

/**
 * Checks if partition space used exceeds the alert threshold.
 *
 * @param float $percent
 *   The mount used percentage.
 *
 * @return bool
 *   TRUE if the alert threshold is exceeded, FALSE otherwise.
 */
function _diskfree_over_threshold($percent) {
  if (preg_replace('/\D/', '', $percent) >= \Drupal::config('diskfree.settings')->get('alert_threshold')) {
    return TRUE;
  }
  else {
    return FALSE;
  }
}
