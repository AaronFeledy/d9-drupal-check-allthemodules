<?php

/**
 * @file
 * Autoban entity type configuration.
 */

use Drupal\autoban\AutobanBatch;

define('AUTOBAN_FROM_ANALYZE', '*from_analyze*');

/**
 * Implements hook_cron().
 */
function autoban_cron() {
  $rules = array_keys(entity_load_multiple('autoban'));
  if (empty($rules)) {
    return;
  }

  $total_banned = 0;
  foreach ($rules as $rule_id) {
    $context = [];
    AutobanBatch::ipBan($rule_id, $context);
    $total_banned += (int) $context['results'];
  }

  if ($total_banned > 0) {
    \Drupal::logger('Autoban')->notice(t('Total IP banned: %count', ['%count' => $total_banned]));
  }
}
