<?php

/**
 * Implements hook_views_data_alter().
 *
 * We need to look through and change the field handler for our stored item to
 * our custom handler so HTML is unescaped.
 *
 * @param array $data
 */
function search_api_view_modes_views_data_alter(array &$data) {
  $indices = \Drupal::entityTypeManager()->getStorage('search_api_index')->loadMultiple();
  $views_data_keys = array_keys($data);

  if ($indices) {
    foreach (array_keys($indices) as $index) {
      $views_index_name = 'search_api_index_' . $index;

      if (!in_array($views_index_name, $views_data_keys)) {
        continue;
      }

      foreach (array_keys($data[$views_index_name]) as $item) {
        if (preg_match('/^view_mode_(.*)/', $item)) {
          $data[$views_index_name][$item]['field']['id'] = 'search_api_view_mode';
          $data[$views_index_name][$item]['field']['fallback_handler'] = 'search_api_view_modes';
        }
      }
    }
  }
}