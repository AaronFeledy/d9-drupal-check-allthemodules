<?php

/**
 * @file
 * Contains hook implementations for contact_form_permissions module.
 */

use Drupal\Component\Utility\Html;
use Drupal\Core\Access\AccessResult;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_help().
 */
function contact_form_permissions_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.contact_form_permissions':
      // @TODO: Provides other useful information instead?
      // Or use Markdown Filter module if it is installed?
      $readme = file_get_contents(
        drupal_get_path('module', 'contact_form_permissions') . '/README.md'
      );
      return '<h3>README</h3><pre>' . Html::escape($readme) . '</pre>';
  }
}

/**
 * Implements hook_ENTITY_TYPE_access().
 */
function contact_form_permissions_contact_form_access(EntityInterface $entity, $operation, AccountInterface $account) {
  switch ($operation) {
    case 'delete':
    case 'update':
      /** @var \Drupal\contact_form_permissions\ContactPermissions $contact_permissions_manager */
      $contact_permissions_manager = \Drupal::service(
        'contact_form_permissions.permissions'
      );
      $permission = $contact_permissions_manager->getPermissionKey(
        'edit',
        $entity
      );
      // Negate to hide operation link.
      return AccessResult::forbiddenIf(!$account->hasPermission($permission));
  }

  // No opinion.
  return AccessResult::neutral();
}
