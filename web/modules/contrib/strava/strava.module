<?php

use Drupal\strava\Api\Strava;
use Drupal\strava_athletes\Entity\Athlete;

/**
 * Implements hook_page_attachments().
 *
 * @inheritdoc
 */
function strava_page_attachments(array &$attachments) {
  if (\Drupal::moduleHandler()->moduleExists('toolbar')) {
    $attachments['#attached']['library'][] = 'strava/strava';
  }
}

/**
 * Implements hook_user_login().
 *
 * @param \Drupal\user\Entity\User $account
 */
function strava_user_login($account) {
  // Check if there's an active Strava session and if it matches the Drupal user
  // that wants to log in.
  $strava = new Strava();

  // Is there an active Strava session for this user?
  if ($strava->checkAccessToken()) {
    $athlete = $strava->getApiClient()->getAthlete();
    $athlete = Athlete::load($athlete['id']);
    /** @var \Drupal\user\Entity\User $account */
    if ($account->id() !== $athlete->getUid()) {
      // If the user id does not match the athlete uid, destroy the stored
      // Strava access token for the current Drupal user.
      $strava->deleteAccessToken();
    }
  }
}
