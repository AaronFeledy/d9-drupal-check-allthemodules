<?php

/**
 * Implements hook_entity_storage_load().
 */
function advertising_products_amazon_entity_storage_load(array $entities, $entity_type) {
  if ($entity_type == 'advertising_product') {
    foreach ($entities as $idx => $entity) {
      if ($entity->bundle() == 'advertising_product_amazon') {
        $entities[$idx]->extra_images = advertising_products_amazon_extra_images($entity->id());
      }
    }
  }
}

/**
 * Helper function to load alternative image urls
 */
function advertising_products_amazon_extra_images($entity_id) {
  $query = \Drupal::database()->select('advertising_products_amazon_image_data', 'i');
  $query->fields('i', ['iid', 'url']);
  $query->condition('pid', $entity_id);
  $images = $query->execute()->fetchAllAssoc('iid');

  // We only have alternatives, if there is more than one image.
  return count($images) > 1 ? $images : [];
}
