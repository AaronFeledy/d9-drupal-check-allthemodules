<?php

/**
 * @file
 * Contains domain_route_meta_tags.module.
 */

use Drupal\domain_route_meta_tags\Helper\DomainRouteMetaHelper;

/**
 * Implements hook_page_attachments().
 *
 * Load all meta tags for this page.
 */
function domain_route_meta_tags_page_attachments_alter(array &$attachments) {
  $cache = NULL;
  $negotiator = \Drupal::service('domain.negotiator');
  if ($negotiator->getActiveDomain() !== NULL) {
    $current_domain = $negotiator->getActiveDomain()->id();
    // Loading cache service.
    $cacheObj = \Drupal::cache();
    // If data is present in the cache return from cache.
    $cacheKey = str_replace('/', '_', $current_domain . \Drupal::service('path.current')->getPath());
    $cache = $cacheObj->get($cacheKey);
  }
  if ($cache) {
    $meta_entities = $metaObj = $cache->data;
  }
  else {
    // Using getInstanace method to create Object.
    $object = DomainRouteMetaHelper::getInstance();
    $meta_entities = $object->getMetaEntity();
    if ($meta_entities !== NULL) {
      $metaObj = $meta_entities->getEntityData();
    }
  }
  // If any Metatag items were found, append them.
  if ($meta_entities !== NULL) {

    foreach ($metaObj['meta'] as $key => $value) {
      if ($value !== NULL) {
        $attachments['#attached']['html_head'][] = [
          [
            '#tag' => 'meta',
            '#attributes' => [
              'name' => $key,
              'content' => $value,
            ],
          ],
          $key,
        ];
      }
    }
    foreach ($metaObj['link'] as $link_key => $link_value) {
      if ($link_value !== NULL) {
        $attachments['#attached']['html_head_link'][] = [
          [
            'rel' => $link_key,
            'href' => $link_value,
          ],
          TRUE,
        ];
      }
    }
  }
}

/**
 * Implements hook_module_implements_alter().
 */
function domain_route_meta_tags_module_implements_alter(&$implementations, $hook) {
  if ($hook === 'page_attachments_alter') {
    $group = $implementations['domain_route_meta_tags'];
    unset($implementations['domain_route_meta_tags']);
    $implementations['domain_route_meta_tags'] = $group;
  }
}
