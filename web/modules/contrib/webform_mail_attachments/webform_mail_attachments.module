<?php

/**
 * @file
 * Enable file attachment in webform.
 */

use Drupal\file\Entity\File;

/**
 * Implements hook_mail_alter().
 */
function webform_mail_attachments_mail_alter(&$message) {
  $elementsManagedFiles = $message['params']['webform_submission']->getWebform()->getElementsManagedFiles();
  foreach ($elementsManagedFiles as $file_id) {
    if (!empty($message['params']['webform_submission']->getData()[$file_id])) {
      $message['params']['files'][] = convert_file_to_attchement($message['params']['webform_submission']->getData()[$file_id]);
    }
  }
}

/**
 * Convert file to attchement.
 *
 * @param int $file_id
 *   The file id of webform managed_file field.
 *
 * @return \stdClass
 *   A file object.
 */
function convert_file_to_attchement($file_id) {
  $file_entity = File::load($file_id);
  $uri = $file_entity->getFileUri();
  $file = new \stdClass();
  $file->uri = $uri;
  $file->filename = $file_entity->getFilename();
  $file->filemime = $file_entity->getMimeType();
  return $file;
}
