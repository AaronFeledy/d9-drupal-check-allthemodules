<?php

/**
 * @file
 * Module tag_block_site_branding_switcher.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function tag_block_site_branding_switcher_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.tag_block_site_branding_switcher':
      $text = file_get_contents(dirname(__FILE__) . '/README.md');
      if (!\Drupal::moduleHandler()->moduleExists('markdown')) {
        return '<pre>' . $text . '</pre>';
      }
      else {
        // Use the Markdown filter to render the README.
        $filter_manager = \Drupal::service('plugin.manager.filter');
        $settings = \Drupal::configFactory()->get('markdown.settings')->getRawData();
        $config = ['settings' => $settings];
        $filter = $filter_manager->createInstance('markdown', $config);
        return $filter->process($text, 'en');
      }
  }
  return NULL;
}

/**
 * Implements hook_preprocess_HOOK().
 */
function tag_block_site_branding_switcher_preprocess_block(&$variables) {
  if ($variables['plugin_id'] == 'system_branding_block') {
    $is_front_page = \Drupal::service('path.matcher')->isFrontPage();
    // Add variable and cache context.
    $variables['is_front_page'] = $is_front_page;
    $variables['#cache']['contexts'][] = 'url.path.is_front';
  }
}

/**
 * Implements hook_theme_registry_alter().
 */
function tag_block_site_branding_switcher_theme_registry_alter(&$theme_registry) {

  $active_theme = \Drupal::theme()->getActiveTheme();

  // Check if file not exist in active theme.
  if (!file_exists($active_theme->getPath() . '/templates/block--system-branding-block.html.twig')) {

    // Check if theme has base theme to select the right overrided template.
    // Base theme stable is default core template.
    $base_theme = 'stable';
    if (!empty($active_theme->getExtension()->base_theme)) {
      $base_theme = $active_theme->getExtension()->base_theme;
    }

    // Set the branding block template.
    $module_path = drupal_get_path('module', 'tag_block_site_branding_switcher');
    $theme_registry['block__system_branding_block']['path'] = implode(
      '/',
      [$module_path, 'templates', $base_theme]
    );
  }
}
