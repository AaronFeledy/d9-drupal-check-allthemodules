<?php

/**
 * @file
 *
 * WeChat For Drupal 7.x
 */

require_once __DIR__ . '/lib/Pyramid/Pyramid.php';

use Drupal\Core\Url;
use Pyramid\Component\WeChat\WeChat;
use Pyramid\Component\WeChat\Request;
use Pyramid\Component\WeChat\Response;
use Pyramid\Component\WeChat\WeChatCorp;

/**
 * Return all or one xwechat config.
 */
function xwechat_get_configs($wid = NULL, $reset = FALSE) {
  static $configs;

  if (!isset($configs) || $reset) {
    $configs = array();
    $sql = "SELECT * FROM {xwechat_config} ORDER BY wid DESC";

    $results = db_query($sql);

    while ($config = $results->fetchObject()) {
      $configs[$config->wid] = $config;
    }
  }

  return is_numeric($wid) ? $configs[$wid] : $configs;
}

/**
 * Settings form.
 */
function xwechat_api_settings_form($form, &$form_state) {
  global $base_url;
  $form['required'] = array(
    '#type' => 'fieldset',
    '#title' => t('Wechat app info'),
    '#description' => t("当前服务器微信接入地址：<b>%base_url</b>", array('%base_url' => $base_url . '/wechat')),
  );


  $form['required']['wechat_api_token'] = array(
    '#type' => 'textfield',
    '#title' => t('Token'),
    '#default_value' => \Drupal::config('xwechat.settings')->get('wechat_api_token'),
    '#required' => TRUE,
  );

  $form['required']['wechat_api_appid'] = array(
    '#type' => 'textfield',
    '#title' => t('Appid'),
    '#default_value' => \Drupal::config('xwechat.settings')->get('wechat_api_appid'),
    '#required' => TRUE,
  );
  $form['required']['wechat_api_appsecret'] = array(
    '#type' => 'textfield',
    '#title' => t('Appsecret'),
    '#default_value' => \Drupal::config('xwechat.settings')->get('wechat_api_appsecret'),
    '#required' => TRUE,
  );
  $form['required']['wechat_api_debug'] = array(
    '#type' => 'checkbox',
    '#title' => t('Debug（测试环境使用）'),
    '#default_value' => \Drupal::config('xwechat.settings')->get('wechat_api_debug'),
  );
  $form['#submit'][] = 'xwechat_api_settings_form_submit';

  return system_settings_form($form);
}


/**
 * Implements hook_theme().
 */
function xwechat_theme() {
  return array(
    'xwechat-media-lists' => array(
      'variables' => array('lists' => NULL),
      'template' => 'xwechat-media-lists',
      'path' => drupal_get_path('module', 'xwechat').'/templates',
    ),
    'xwechat_config_add_form' => array(
      'render element' => 'form',
      'template' => 'xwechat',
      'path' => drupal_get_path('module', 'xwechat').'/templates',
    ),
    'xwechat_config_edit_form' => array(
      'render element' => 'form',
      'template' => 'xwechat',
      'path' => drupal_get_path('module', 'xwechat').'/templates',
    ),
    'xwechat_menu_form' => array(
      'render element' => 'form',
      'template' => 'xwechat-menu',
      'path' => drupal_get_path('module', 'xwechat').'/templates',
    ),
    'xwechat_media_add_form' => array(
      'render element' => 'form',
      'template' => 'xwechat-media',
      'path' => drupal_get_path('module', 'xwechat').'/templates',
    ),    
  );
}

/**
 * Token refresh.
 */
function xwechat_api_settings_form_submit($form, &$form_state) {
  $token = $form_state['input']['wechat_api_token'];
  $appid = $form_state['input']['wechat_api_appid'];
  $appsecret = $form_state['input']['wechat_api_appsecret'];
  $options = array(
    'token' => $token,
    'appid' => $appid,
    'appsecret' => $appsecret,
  );
  drupal_write_record('xwechat_config', $options);
}

/**
 * Get xwechat config.
 */
function xwechat_config_load($wid) {
  return db_select('xwechat_config', 'c')
    ->fields('c')
    ->condition('wid', $wid)
    ->execute()
    ->fetchObject();
}

/**
 * Delete a xwechat config from the database.
 */
function xwechat_config_confirm_delete($wid) {
  $result = db_delete('xwechat_config')
  ->condition('wid', (int) $wid)
  ->execute();

  return TRUE;
}

/**
 * 显示星号.
 */
function xwechat_config_mask($string) {
  $len = strlen($string);
  if ($len < 4) { return $string; }
  $num = floor($len*2/5);
  $rep = str_repeat('*', $num);
  $srt = floor($len/3) - 1;
  return substr_replace($string, $rep, $srt, $num);
}

/**
 * Implements hook_xwechat_operation().
 */
function xwechat_xwechat_operation($links = array(), $config) {
  $links['edit'] = array(
    'title' => t('Edit'),
    'url' => Url::fromRoute('xwechat.edit', ['xwechat_config' => $config['wid']]),
  );

  $links['delete'] = array(
    'title' => t('Delete'),
    'url' => Url::fromRoute('xwechat.delete', ['xwechat_config' => $config['wid']]),
  );
    
  return $links;
}
