<?php

/**
 * @file
 *
 * wechat_menu
 */

use Drupal\Core\Url;
use Pyramid\Component\WeChat\WeChat;
use Pyramid\Component\WeChat\Request;
use Pyramid\Component\WeChat\Response;

/**
 * Implements hook_xwechat_operation().
 */
function xwechat_media_xwechat_operation($links = array(), $config) {
  $links['media'] = array(
    'title' => t('Media'),
    'url' => Url::fromRoute('xwechat.media.list', ['xwechat_config' => $config['wid']]),
    'attributes' => array('target'=>'_blank'),
  );
    
  return $links;
}

/**
 * List all media.
 */
function xwechat_media_list($config) {
  drupal_add_js(drupal_get_path('module', 'xwechat') . '/assets/js/jquery.superslide.js');
  $lists = array();
  foreach(xwechat_media_get_list($config) as $key => $item){
    $lists[$key] = $item;   
    
    if(!empty($item->media_file)){
      $mediaFile = file_load($item->media_file);
      $lists[$key]->media_file = $mediaFile->uri;
    } 
  }

  return theme('xwechat-media-lists', array('lists' => $lists));
}

/**
 * Get media list.
 */
function xwechat_media_get_list($config) {
  $query = db_select('xwechat_media', 'xm');
  $query->fields('xm');
 
  $query->condition('xm.wid', $config->wid, '=');

  $result = $query->execute()->fetchAll();

  return $result;
}

/**
 * Callback for menu.
 */
function xwechat_media_add_form($form, &$form_state, $config) {
  drupal_add_js(drupal_get_path('module', 'xwechat') . '/assets/js/jquery.superslide.js');
  drupal_add_js(drupal_get_path('module', 'xwechat') . '/assets/js/xwechat.js', array('weight' => 5));
  $form = array();
  $form['media_title'] = array(
    '#type' => 'textfield',
    '#title' => t('标题'),
    '#default_value' => '',
    '#size' => 30,
  );
  $form['media_group'] = array(
    '#type' => 'select',
    '#title' => t('分类'),
    '#default_value' => '',   
    '#options' => array('gaoxiao' => t('搞笑'), 'youxi' => '游戏'),
  );
  $form['media_file'] = array(
    '#type' => 'managed_file',
    '#title' => 'Upload File',
    '#upload_location' => 'public://media_file',
  );
  $form['media_eidtor'] = array(
    '#input_format' => '1',
    '#rows' => '5',
    '#type' => 'text_format',
    '#base_type' => 'textarea',
  );
  $form['wid'] = array(
    '#type' => 'hidden',
    '#value' => $config->wid,
  );
  $form['actions'] = array('#type' => 'actions');
  $form['actions']['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Save'),
  );

  return $form;
}

/**
 * Submit for add media form.
 */
function xwechat_media_add_form_submit($form, &$form_state) {
  if(!empty($form_state['values'])){
  $mid = db_insert('xwechat_media')
    ->fields(array(
      'wid' => $form_state['values']['wid'],
      'title' => $form_state['values']['media_title'],
      'media_group' => $form_state['values']['media_group'],
      'media_file' => $form_state['values']['media_file'],
      'media_content' => $form_state['values']['media_eidtor']['value'],
      'created' => time(),
    ))
    ->execute();
  }

  if ($mid) {
    drupal_set_message(t('XWechat media %s added.', array('%s' => $form_state['values']['media_title'])));    
  } else {
    drupal_set_message(t('XWechat media add failed.'), 'error');
  }  
}

/**
 * Implements hook_xwechat_operation().
 */
function xwechat_media_loadtemp() {
  if(!in_array($_POST['type'],array('title','text','img','tpl','scene','follow')))	{
    drupal_set_message('错误的模板类型', 'error');
  }

  $file_path = strtr(DRUPAL_ROOT,'\\','/') . '/' . drupal_get_path('module', 'xwechat');
  $content = file_get_contents($file_path . '/assets/wxeditor/temp_'.$_POST['type'].'.html');

  print $content;
}
