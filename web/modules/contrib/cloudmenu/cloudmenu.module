<?php
/**
 * @file
 * The brain of CloudMenu.
 *
 * Displays a given menu as a Flash-based 3D link cloud.
 * Based on comulus.module, which is based on WP-Cumulus for WordPress, by Roy Tanck.
 */

/**
 * Implements hook_enable().
 */
function cloudmenu_enable() {
  drupal_set_message(t('Cloud Menu has now been enabled. You need to !configure the Cloud Menu block settings before you use it.', array('!configure' => l(t('configure and save'), 'admin/build/block'))));
}

/**
 * Implements hook_init().
 *
 * Push an empty entry to the front of the array. This ensures the behaviours
 * property always contain an array of objects, even if there is only a single
 * block on the page. Fixes [#1715296].
 */
function cloudmenu_init() {
  drupal_add_js(array('cloudmenu' => array(array('delta' => 'empty'))), 'setting');
}

/**
 * Implements hook_block_info().
 */
function cloudmenu_block_info() {
  $number = config('cloudmenu.settings')->get('blocks') ?: 1;
  for ($delta = 0; $delta < $number; $delta++) {
    $blocks[$delta]['info'] = config('cloudmenu.block.' . $delta)->get('description');
    $blocks[$delta]['cache'] = DRUPAL_CACHE_PER_USER;
  }
  return $blocks;
}

/**
 * Implements hook_block_configure().
 */
function cloudmenu_block_configure($delta) {
  $form['description'] = array(
    '#type' => 'textfield',
    '#title' => t('Block description'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('description'),
    '#description' => t('A brief description of your block. Used on the <a href="@block-overview-page">block overview page</a>.', array('@block-overview-page' => url('admin/build/block')))
  );
  $form['menu'] = array(
    '#type' => 'select',
    '#title' => t('Menu'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('menu'),
    '#options' => menu_get_menus(TRUE),
    '#description' => t('The menu whose contents will be displayed as a cloud.'),
  );
  $form['step'] = array(
    '#type' => 'textfield',
    '#title' => t('Tag size interval'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('step'),
    '#maxlength' => 2,
    '#description' => t('The number of tag sizes you want to use.'),
  );
  $form['limit'] = array(
    '#type' => 'textfield',
    '#title' => t('Number of tags to display'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('limit'),
    '#maxlength' => 2,
    '#description' => t('The maximum number of tags that will be displayed.'),
  );
  $form['flash_width'] = array(
    '#type' => 'textfield',
    '#title' => t('Width of cloud menu'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('flash.width'),
    '#maxlength' => 3,
    '#description' => t('The width of the cloud menu in pixels.'),
  );
  $form['flash_height'] = array(
    '#type' => 'textfield',
    '#title' => t('Height of cloud menu'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('flash.height'),
    '#maxlength' => 3,
    '#description' => t('The height of the cloud menu in pixels.'),
  );
  $form['flash_background'] = array(
    '#type' => 'textfield',
    '#title' => t('Background color of cloud menu'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('flash.background'),
    '#maxlength' => 6,
    '#description' => t('The hex color value for the background of the cloud menu. E.g. ffffff. If "Background transparency" is enabled, this option will have no effect.'),
  );
  $form['flash_transparency'] = array(
    '#type' => 'select',
    '#title' => t('Background transparency'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('flash.transparency'),
    '#options' => array(
      'false' => t('no'),
      'true' => t('yes'),
    ),
    '#description' => t('Enabling background transparency might cause issues with some (mostly older) browsers.<br />Under Linux, transparency doesn\'t work at all due to a known limitation in the current Flash player.'),
  );
  $form['flash_color'] = array(
    '#type' => 'textfield',
    '#title' => t('Font color of cloud menu'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('flash.color'),
    '#maxlength' => 6,
    '#description' => t('The hex color value you would like to use for the tags. E.g. 000000.'),
  );
  $form['flash_color2'] = array(
    '#type' => 'textfield',
    '#title' => t('Second font color of cloud menu'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('flash.color2'),
    '#maxlength' => 6,
    '#description' => t('Second tag color. If supplied, tags will get a color from a gradient between both colors based on their popularity.'),
  );
  $form['flash_hicolor'] = array(
    '#type' => 'textfield',
    '#title' => t('Highlight color of cloud menu'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('flash.hicolor'),
    '#maxlength' => 6,
    '#description' => t('The hex color value you would like to use for the tag mouseover/hover color'),
  );
  $form['flash_speed'] = array(
    '#type' => 'textfield',
    '#title' => t('Rotation speed'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('flash.speed'),
    '#maxlength' => 3,
    '#description' => t('Set the speed of the cloud menu. Options between 25 and 500 work best.'),
  );
  $form['flash_distribute'] = array(
    '#type' => 'select',
    '#title' => t('Distribute tags evenly on cloud menu'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('flash.distribute'),
    '#options' => array(
      'false' => t('no'),
      'true' => t('yes'),
    ),
    '#description' => t('When enabled, the movie will attempt to distribute the tags evenly over the surface of the cloud menu.'),
  );
  $form['flash_font_size'] = array(
    '#type' => 'textfield',
    '#title' => t('Font size'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('flash.font.size'),
    '#maxlength' => 2,
    '#description' => t('Set the font size of the tag with the lowest tag-size in pixels (level 1).'),
  );
  $form['flash_font_size_interval'] = array(
    '#type' => 'textfield',
    '#title' => t('Font size interval'),
    '#default_value' => config('cloudmenu.block.' . $delta)->get('flash.font.size.interval'),
    '#maxlength' => 1,
    '#description' => t('Set the font size interval used for the different tag-sizes (level 2 and higher).'),
  );
  return $form;
}

/**
 * Implements hook_block_save().
 */
function cloudmenu_block_save($delta = '', $edit = array()) {
  config('cloudmenu.block.' . $delta)
    ->set('description', $edit['description'])
    ->set('menu', $edit['menu'])
    ->set('step', $edit['step'])
    ->set('limit', $edit['limit'])
    ->set('flash.width', $edit['flash_width'])
    ->set('flash.height', $edit['flash_height'])
    ->set('flash.background', $edit['flash_background'])
    ->set('flash.transparency', $edit['flash_transparency'])
    ->set('flash.color', $edit['flash_color'])
    ->set('flash.color2', $edit['flash_color2'])
    ->set('flash.hicolor', $edit['flash_hicolor'])
    ->set('flash.speed', $edit['flash_speed'])
    ->set('flash.distribute', $edit['flash_distribute'])
    ->set('flash.font.size', $edit['flash_font_size'])
    ->set('flash.font.size.interval', $edit['flash_font_size_interval'])
    ->save();
}

/**
 * Implements hook_block_view().
 */
function cloudmenu_block_view($delta = 0) {

  $links = cloudmenu_get_weighted_menu(config('cloudmenu.block.' . $delta)->get('menu'));
  $links = array_slice($links, 0, config('cloudmenu.block.' . $delta)->get('limit'));
  $tags_formatted_alt = theme('cloudmenu_weighted_alt', array('links' => $links));

  // Add the JavaScript that defines the tags
  _cloudmenu_js_add($delta);

  // Output block HTML
  return array(
    'subject' => t('Cloud Menu'),
    'content' => "<div id='cloudmenu-{$delta}'>{$tags_formatted_alt}</div>",
  );
}

/**
 * Helper that adds the JS behaviours and libraries to the page.
 */
function _cloudmenu_js_add($delta) {
  // Put the block configurations in a behaviour.
  //
  // We merge in an additional settings object on each call to block_view()
  // so that if a block is shown only for admins (and might contain links to
  // privileged pages) its settings are not disclosed via behaviours to users
  // that ought not be able to access them.
  $params = _cloudmenu_js_settings($delta);
  drupal_add_js(array('cloudmenu' => array($delta => $params)), 'setting');

  // Use a static here to determine whether more than one cloudmenu block is
  // to be shown. Only add the javascript files once.
  static $processed;

  if (empty($processed)) {
    // Add Cumulus javascript.
    $js = drupal_get_path('module', 'cloudmenu') .'/cumulus.js';
    if (file_exists($js)) {
      drupal_add_js($js, array('scope' => 'header'));
    }
    else {
      drupal_set_message(t('The file @folder is missing. Please download it from !link, and add it to the Cloud Menu module folder!', array('@folder' => $js, '!link' => l('http://pratul.in/files/cumulus.js', 'http://pratul.in/files/cumulus.js'))), 'error');
    }
    if (empty($params['menu'])) {
      drupal_set_message(t('You have not yet configured and saved your first Cloud Menu on !link. Cloud Menu might not work properly!', array('!link' => l('your blocks configuration page', 'admin/structure/block/manage/cloudmenu/0/configure'))), 'warning');
    }

    // Cloudmenu processor javascript.
    drupal_add_js(drupal_get_path('module', 'cloudmenu') .'/cloudmenu.js', array('scope' => 'footer'));

    $processed = TRUE;
  }
}

/**
 * Helper that returns cloudmenu block settings for use in Drupal.behaviours.
 */
function _cloudmenu_js_settings($delta) {
  static $cloudmenu_blocks;

  if (!empty($cloudmenu_blocks[$delta])) {
    return $cloudmenu_blocks[$delta];
  }

  // Cache miss, make a cache of all cloudmenu block settings.
  $cloudmenu_blocks = array();

  for ($i = 0; $i < config('cloudmenu')->get('blocks'); $i++) {
    // Need to get the links for this block. Again. Fail.
    $links = cloudmenu_get_weighted_menu(config('cloudmenu.block.' . $i)->get('menu'));
    $links = array_slice($links, 0, config('cloudmenu.block.' . $i)->get('limit'));

    // Flash params, will go into drupal.behaviours.
    $params = array(
      'delta' => $i,
      'menu' => config('cloudmenu.block.' . $i)->get('menu'),
      'path_to_flash' => base_path() . drupal_get_path('module', 'cloudmenu') .'/cumulus.swf',
      'width' => config('cloudmenu.block.' . $i)->get('flash.width'),
      'height' => config('cloudmenu.block.' . $i)->get('flash.height'),
      'background' => config('cloudmenu.block.' . $i)->get('flash.background'),
      'color' => '0x'. config('cloudmenu.block.' . $i)->get('flash.color'),
      'color2' => '0x'. config('cloudmenu.block.' . $i)->get('flash.color2'),
      'hicolor' => '0x'. config('cloudmenu.block.' . $i)->get('flash.hicolor'),
      'speed' => config('cloudmenu.block.' . $i)->get('flash.speed'),
      'distribute' => config('cloudmenu.block.' . $i)->get('flash.distribute'),
      'tags_formatted_flash' => theme('cloudmenu_weighted', array('links' => $links, 'font_size' => config('cloudmenu.block.' . $i)->get('flash.font.size'), 'font_size_interval' => config('cloudmenu.block.' . $i)->get('flash.font.size.interval'))),
    );
    $cloudmenu_blocks[$i] = $params;
  }

  // Return the block we wanted.
  return $cloudmenu_blocks[$delta];
}

/**
 * Helper that returns menu items to be displayed in a sorted array.
 *
 * menu_tree_page_data() already performs an access check, so we
 * never have items here that the current user may not access.
 */
function cloudmenu_get_weighted_menu($menu) {
  $items = array();

  $tree = menu_tree_page_data($menu);
  $items = cloudmenu_tree_output($tree);

  uasort($items, 'cloudmenu_sort_by_depth');

  return $items;
}

/**
 * Helper that is a hacked up version of menu_tree_output()
 * which can traverse menu trees, but doesn't do classes or
 * theme stuff.
 */
function cloudmenu_tree_output($tree) {
  $links = array();
  $items = array();

  // Pull out just the menu items we are going to render so that we
  // get an accurate count for the first/last classes.
  foreach ($tree as $data) {
    if (!$data['link']['hidden']) {
      $items[] = $data;
    }
  }

  foreach ($items as $i => $data) {
    $links[$data['link']['mlid']] = $data['link'];
    if ($data['below']) {
      $links += cloudmenu_tree_output($data['below']);
    }
  }

  return $links;
}

/**
 * Helper that sorts menu tree items by depth.
 */
function cloudmenu_sort_by_depth($a, $b) {
  if ($a['depth'] == $b['depth']) {
    return 0;
  }
  return ($a['depth'] < $b['depth']) ? -1 : 1;
}

/**
 * Implementation for hook_theme().
 */
function cloudmenu_theme($existing, $type, $theme, $path) {
  return array(
    'cloudmenu_weighted' => array(
      'variables' => array('links' => NULL, 'font_size' => NULL, 'font_size_interval' => NULL),
      'file' => 'cloudmenu.theme.inc',
    ),
    'cloudmenu_weighted_alt' => array(
      'variables' => array('links' => NULL),
      'file' => 'cloudmenu.theme.inc',
    ),
  );
}

/**
 * Implementation of hook_help().
 */
function cloudmenu_help($path, $arg) {
  switch ($path) {
    case 'admin/help#cloudmenu':
      $output = '<p>'. t('Cloud Menu allows you to display a menu tree\'s links using a Flash movie that rotates them in 3D. This way, you can set it up as if it were a 3D tag cloud, which is more visually exciting!') .'</p>';
      $output .= '<p>'.'<strong>'. t('Configuring Cloud Menu: ') .'</strong>'.'<br />';
      $output .= t('By default, Cloud Menu is rendered as a block. You need to enable and configure that block to see it. If you don\'t configure and save the Cloud Menu block settings once, it will not work! Do that before wondering what\'s wrong :-)') .'</p>';
      return $output;
  }
}


/**
 * Helper that returns an array of default settings.
 */
function cloudmenu_defaults($delta = 0) {
  return array(
    'description' => t('CloudMenu: unconfigured @delta', array('@delta' => $delta)),
    'delta' => 0,
    'menu' => '',
    'step' => 6,
    'limit' => 24,
    'flash_width' => 240,
    'flash_height' => 180,
    'flash_background' => 'ffffff',
    'flash_transparency' => false,
    'flash_color' => '000000',
    'flash_color2' => 'ff0000',
    'flash_hicolor' => '666666',
    'flash_speed' => 220,
    'flash_distribute' => true,
    'flash_font_size' => 10,
    'flash_font_size_interval' => 2,
  );
}

