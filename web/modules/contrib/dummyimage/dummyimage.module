<?php
/**
 * @file
 * Dummy Image module.
 */

/**
 * Alter the url to images so they use image provider settings.
 *
 * @param array $variables
 */
function dummyimage_preprocess_image_style(&$variables) {
  $generate = \Drupal::config('dummyimage.settings')->get('dummyimages_generate');
  if ('none' == $generate) {
    return;
  }
  $image = \Drupal::service('image.factory')->get($variables['uri']);
  if ($image->isValid() && 'missing' == $generate) {
    return;
  }

  // Get the plugin to use.
  $provider = \Drupal::config('dummyimage.settings')->get('dummyimages_service');
  $manager = \Drupal::service('plugin.manager.dummyimage');
  $plugins = $manager->getDefinitions();
  if (!isset($plugins[$provider])) {
    return;
  }
  // Alter the url.
  $instance = $manager->createInstance($plugins[$provider]['id']);
  $variables['image']['#uri'] = $instance->getUrl($variables['width'], $variables['height']);
}
