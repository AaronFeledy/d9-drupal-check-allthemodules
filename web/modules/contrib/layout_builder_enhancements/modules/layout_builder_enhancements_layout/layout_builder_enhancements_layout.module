<?php

/**
 * @file
 * Provides all preprocess hooks.
 */

use Drupal\file\Entity\File;
use Drupal\Core\Url;
use Drupal\Core\Template\Attribute;

/**
 * Implements hook_layout_preprocess_layout().
 */
function layout_builder_enhancements_layout_preprocess_layout(&$variables) {
  $variables['layout'] = isset($variables['content']['#layout']) ? $variables['content']['#layout'] : [];

  if (strpos($variables['layout']->id(), 'lbe_') !== 0) {
    return;
  }
  $settings = isset($variables['content']['#settings']) ? $variables['content']['#settings'] : [];
  if ($settings) {
    if (!$variables['attributes']) {
      $variables['attributes'] = new Attribute();
    }
    if (!is_array($variables['attributes']['class'])) {
      $variables['attributes']['class'] = [];
    }

    if (isset($settings['color'])) {
      $variables['attributes']['style'] = 'background-color: ' . $settings['color'];
    }

    if ($settings['link']) {
      $variables['link'] = [
        '#type' => 'link',
        '#title' => isset($settings['link_title']) ? $settings['link_title'] : $settings['link'],
        '#url' => Url::fromUri($settings['link']),
        '#attributes' => ['class' => ['region-link']],
      ];
    }

    if (isset($settings['extra_classes'])) {
      foreach ($settings['extra_classes'] as $class) {
        $variables['attributes']['class'][] = $class;
      }
    }

    if (isset($settings['image']) &&  count($settings['image']) > 0 && ($file = File::load($settings['image'][0]))) {
      if (isset($variables['attributes']['style'])) {
        $variables['attributes']['style'] .= '; background-image: url(' . $file->url() . ')';
      }
      else {
        $variables['attributes']['style'] = 'background-image: url(' . $file->url() . ')';
      }
    }

    if (is_array($settings['regions'])) {
      foreach ($settings['regions'] as $region => $setting) {
        if (!isset($variables['region_attributes'][$region])) {
          continue;
        }
        if (isset($setting['color']) && !empty($setting['color'])) {
          $variables['region_attributes'][$region]->setAttribute('style', 'background-color: ' . $setting['color']);
        }
        if (isset($setting['image']) &&  count($setting['image']) > 0 && ($file = File::load($setting['image'][0]))) {
          if (isset($variables['region_attributes'][$region]['style'])) {
            $variables['region_attributes'][$region]['style'] .= '; background-image: url(' . $file->url() . ')';
          }
          else {
            $variables['region_attributes'][$region]['style'] = 'background-image: url(' . $file->url() . ')';
          }
        }
      }
    }
    if (isset($settings['title']) && !empty($settings['title'])) {
      $level = isset($settings['level']) ? $settings['level'] : 2;
      $variables['title'] = [
        '#type' => 'html_tag',
        '#tag' => 'h' . $level,
        '#value' => $settings['title'],
      ];
    }
  }
}
