<?php

/**
 * @file
 * The module file
 */

/**
 * Implements hook_permission().
 */
function searchcloud_block_permission() {
  return array(
    'administer searchcloud' => array(
      'title' => t('Administer searchcloud'),
      'description' => t('Administer this module.'),
    ),
    'searchcloud truncate' => array(
      'title' => t('Searchcloud truncate'),
      'description' => t('Truncate the complete searchcloud table.'),
    ),
    'searchcloud reset' => array(
      'title' => t('Searchcloud reset'),
      'description' => t('Reset the searchcloud table, this resets all counts to 0 (zero).'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function searchcloud_block_menu() {
  $items['admin/config/search/searchcloud_block'] = array(
    'title' => 'Searchcloud block',
    'description' => 'Searchcloud block settings.',
    'route_name' => 'searchcloud_block.base',
  );

  return $items;
}

/**
 * Implements hook_menu_link_defaults().
 */
function searchcloud_block_menu_link_defaults() {
  $links['searchcloud_block.base'] = array(
    'link_title' => 'Searchcloud block',
    'parent' => 'system.admin.config.search',
    'description' => 'Configure the searchcloud block module.',
    'route_name' => 'searchcloud_block.base',
  );

  return $links;
}

/**
 * Implements hook_form_alter().
 */
function searchcloud_block_form_alter(&$form, &$form_state, $form_id) {
  switch ($form_id) {
    case 'search_block_form':
    case 'search_form':
      $form['#submit'][] = 'searchcloud_block_submit_handler';
      break;
  }
}

/**
 * Added a custom submit handler.
 */
function searchcloud_block_submit_handler($form, $form_values) {
  switch ($form['#form_id']) {
    case 'search_block_form':
      $keys = $form_values['values']['search_block_form'];
      break;

    default:
      $keys = $form_values['values']['keys'];
  }
  if (!empty($keys)) {
    searchcloud_block_check_keys($keys);
  }
}

/**
 * Check for the searched keys and add or update them in our table.
 */
function searchcloud_block_check_keys($key) {
  $entity_ids = \Drupal::entityQuery('searchcloud_block')
    ->condition('keyword', $key)
    ->execute();

  if (!empty($entity_ids)) {
    // Edit entity.
    foreach ($entity_ids as $entity_id) {
      $entity = entity_load('searchcloud_block', $entity_id);
      $entity->count = $entity->count->value + 1;
      $entity->save();
    }
  }
  else {
    // Add entity.
    $term = entity_create('searchcloud_block', array(
      'keyword' => $key,
      'count' => 1,
    ));
    $term->save();
  }

  // Save parameters.
  $_key = $key;
  if (isset($record)) {
    $_count = $record->count + 1;
  }
  else {
    $_count = 1;
  }

  // Execute hook.
  \Drupal::moduleHandler()->invokeAll('searchcloud_block_check_keys_execute', array($_key, $_count));
}
