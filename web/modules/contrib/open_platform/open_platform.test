<?php
/**
 * @file
 * Test for the Open Platform Module.
 */

/**
 * Provides automated test for the Open Platform module.
 */
class OpenPlatformTestCase extends DrupalUnitTestCase {

  public static function getInfo() {
    // Note: getInfo() strings should not be translated.
    return array(
      'name' => 'Guardian Open Platform Test',
      'description' => 'Test Guardian Open Platform module',
      'group' => 'Guardian Open Platform',
    );
  }
  
  /**
   * Test for correct array structure of formatted data.
   */
  function testFormatData() {
    $data = open_platform_get_dummy_data();
    $result = open_platform_format_data('preview', $data);
    $expected_data = open_platform_formatted_data();
    $this->assertIdentical($result, $expected_data, 'Test for correct array structure needed for OP preview page');
  }
  
  /**
   * Test for correct array structure of user chosen options.
   */
  function testOptions() {
    $adv_fields = array();
    $fields_array = array();
    $result = open_platform_options('', '', $adv_fields, $fields_array, '');
    $expected_data = open_platform_options_data();
    $this->assertIdentical($result, $expected_data, 'Test to make sure user selected options are correctly structured as other functions depend on correct format');
  }

  /**
   * Test for correct array structure of user chosen fields.
   */
  function testFields() {
    $data = open_platform_fields_data();

    $result = open_platform_user_selected_fields('headline', $data);
    $this->assertTrue($result, "Test that users selected fields can be detected");
  }
  
  /**
   * Test content status functionality.
   */
  function testStatusMessages() {
    $dummy_body_text_1 = '<!-- Redistribution rights for this field are unavailable -->';
    $dummy_body_text_2 = 'content content';

    $result_1 = open_platform_check_status_of_content(1, $dummy_body_text_2);
    $result_2 = open_platform_check_status_of_content(0, $dummy_body_text_1);
    $result_3 = open_platform_check_status_of_content(0, $dummy_body_text_2);

    $this->assertIdentical($result_1, 'Already published', 'Test node publication status');
    $this->assertIdentical($result_2, 'Not available for redistribution', 'Test redistribution status');
    $this->assertIdentical($result_3, 'Available for publication', 'Test publication status');
  }

  /**
   * Test for correct API URLs.
   */
  function testURL() {
    $this->assertIdentical(OPEN_PLATFORM_URL, 'http://content.guardianapis.com', 'Test for correct API url');
    $this->assertIdentical(OPEN_PLATFORM_TEST_API_KEY, 'http://content.guardianapis.com/search?format=json&show-fields=body&api-key=', 'Test for correct API url for checking user API key');
    $this->assertIdentical(OPEN_PLATFORM_SEARCH, 'http://content.guardianapis.com/search?q=', 'Test for correct API url for search queries');
  }

}
