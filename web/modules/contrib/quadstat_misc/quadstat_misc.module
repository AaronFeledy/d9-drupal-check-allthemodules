<?php

use \Drupal\Core\Url;
use \Drupal\Core\Path\PathMatcher;

function quadstat_misc_menu_local_tasks_alter(&$data, $route_name) {

  // Add a tab linking to the frontpage to all pages
  $is_front = \Drupal::service('path.matcher')->isFrontPage();
  $current_path = \Drupal::service('path.current')->getPath();
  $data['tabs'][0]['node.front'] = array(
    '#theme' => 'menu_local_task',
    '#link' => array(
      'title' => t('Home'),
      'url' => Url::fromRoute('<front>'),
      'localized_options' => array(
        'attributes' => array(
          'title' => t('Link to Quadstat.com frontpage'),
        ),
      ),
    ),
    '#weight' => -50,
    '#active' => $is_front,
  );
  // Make tab inactive on its page; only show to authenticated users
  $user = \Drupal::currentUser();
  if($user->id()) {
    $data['tabs'][0]['quadstat_misc.add_dataset'] = array(
      '#theme' => 'menu_local_task',
      '#link' => array(
        'title' => t('New'),
        'url' => Url::fromUserInput('/node/add/dataset'),
        'localized_options' => array(
          'attributes' => array(
            'title' => t('Import or create a new dataset on Quadstat.com.'),
          ),
        ),
      ),
      '#weight' => -40,
      '#active' => $current_path == '/node/add/dataset' ? TRUE : FALSE,
    );
    $data['tabs'][0]['quadstat_misc.logout'] = array(
      '#theme' => 'menu_local_task',
      '#link' => array(
        'title' => t('Logout'),
        'url' => Url::fromUserInput('/user/logout'),
        'localized_options' => array(
          'attributes' => array(
            'title' => t('Logout of Quadstat.com.'),
          ),
        ),
      ),
      '#weight' => 50,
      '#active' => FALSE,
    );
  } 
  // Hide the 'View' tab on front page
  if($is_front) {
    unset($data['tabs'][0]['entity.node.canonical']);
  }
}

/**
 * Implements hook_page_attachments() to attach CSS and JS to specific pages
 */
function quadstat_misc_page_attachments(&$attachments) {
    $attachments['#attached']['library'][] = 'quadstat_misc/quadstat_misc';
}

/**
 * Implements hook_user_login() to redirect upon login
 */
function quadstat_misc_user_login($account) {
  $url = "/";
  $response = new Symfony\Component\HttpFoundation\RedirectResponse($url);
  $response->send();
  return;
}

/**
 * Implements hook_theme_registry_alter
 */
function quadstat_misc_theme_registry_alter(&$theme_registry) {
  $path = drupal_get_path('module', 'quadstat_misc') . '/templates';
  $theme_registry['webform_submission_html']['path'] = $path;
  $theme_registry['webform_submission_html']['template'] = 'quadstat_misc-submission-html';
  $theme_registry['webform_submission_information']['path'] = $path;
  $theme_registry['webform_submission_information']['template'] = 'quadstat_misc-submission-information';
}

