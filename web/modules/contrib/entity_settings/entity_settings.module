<?php

/**
 * @file
 * Hook implementations for the Entity Settings module.
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\entity_settings\EntitySettings;

/**
 * Implements hook_form_FORM_ID_alter() for field_ui_field_storage_add_form.
 */
function entity_settings_form_field_ui_field_storage_add_form_alter(&$form, FormStateInterface $form_state) {
  $form['#attached']['library'][] = 'entity_settings/setting-machine-name';
  $form['#validate'][] = 'Drupal\entity_settings\EntitySettings::validateNewSettingField';
}

/**
 * Implements hook_form_FORM_ID_alter() for field_storage_config_edit_form.
 */
function entity_settings_form_field_storage_config_edit_form_alter(&$form, FormStateInterface $form_state) {
  $storage = $form_state->getStorage();
  if (isset($storage['field_config'])) {
    $types = EntitySettings::settingFieldTypes();
    if (in_array($storage['field_config']->getType(), $types)) {
      // Only allow 1 value for setting fields.
      $form['cardinality_container']['cardinality']['#default_value'] = 1;
      $form['cardinality_container']['#access'] = FALSE;
    }
  }
}

/**
 * Implements hook_field_widget_info_alter().
 *
 * Allows certain widgets to be used with setting field types.
 */
function entity_settings_field_widget_info_alter(&$info) {
  if (isset($info['options_select'])) {
    $info['options_select']['field_types'][] = 'setting_list_integer';
    $info['options_select']['field_types'][] = 'setting_list_string';
  }
  if (isset($info['boolean_checkbox'])) {
    $info['options_select']['field_types'][] = 'setting_boolean';
  }
}

/**
 * Implements hook_field_formatter_info_alter().
 *
 * Allows certain formatters to be used with setting field types.
 */
function entity_settings_field_formatter_info_alter(array &$info) {
  if (isset($info['list_default'])) {
    $info['list_default']['field_types'][] = 'setting_list_integer';
    $info['list_default']['field_types'][] = 'setting_list_string';
  }
  if (isset($info['list_key'])) {
    $info['list_key']['field_types'][] = 'setting_list_integer';
    $info['list_key']['field_types'][] = 'setting_list_string';
  }
  if (isset($info['boolean'])) {
    $info['boolean']['field_types'][] = 'setting_boolean';
  }
}
