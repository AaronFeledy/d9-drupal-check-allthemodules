<?php

/**
 * @file
 * Create dynamic library and pass module settings to the JS file.
 */

/**
 * Implements hook_library_info_build().
 *
 * Create data_attribute_gmap/gmap as a dynamic library so we can get the Goolge Maps API
 * key from the settings form (impossible via libraries.yml file).
 */
function data_attribute_gmap_library_info_build() {
  $config = \Drupal::config('data_attribute_gmap.settings');

  $apilink = 'https://maps.googleapis.com/maps/api/js?key=' . $config->get('api_key');
  if ($config->get('placesAPI')) {
    $apilink .= '&libraries=places';
  }

  $libraries = [];
  $libraries['gmap'] = [
    'version' => '1.x',
    'css' => [
      'component' => ['css/data_attribute_gmap.css' => []],
    ],
    'js' => [
      'js/data_attribute_gmap.js' => [],
      $apilink => [
        'type' => 'external',
        'minified' => TRUE,
      ],
    ],
    'dependencies' => [
      'core/jquery',
      'core/drupal',
      'core/drupalSettings',
    ],
  ];
  return $libraries;
}

/**
 * Implements hook_page_attachments_alter().
 */
function data_attribute_gmap_page_attachments_alter(&$build) {
  $config = \Drupal::config('data_attribute_gmap.settings');
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['api_key'] = $config->get('api_key');
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['width'] = $config->get('width');
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['height'] = $config->get('height');
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['marker_path'] = $config->get('marker_path');
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['backgroundColor'] = $config->get('backgroundColor');
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['center_lat'] = $config->get('center_lat');
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['center_long'] = $config->get('center_long');
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['clickableIcons'] = $config->get('clickableIcons') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['disableDefaultUI'] = $config->get('disableDefaultUI') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['disableDoubleClickZoom'] = $config->get('disableDoubleClickZoom') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['draggable'] = $config->get('draggable') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['fullscreenControl'] = $config->get('fullscreenControl') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['keyboardShortcuts'] = $config->get('keyboardShortcuts') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['mapTypeControl'] = $config->get('mapTypeControl') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['mapTypeId'] = $config->get('mapTypeId');
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['panControl'] = $config->get('panControl') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['rotateControl'] = $config->get('rotateControl') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['scaleControl'] = $config->get('scaleControl') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['scrollwheel'] = $config->get('scrollwheel') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['streetViewControl'] = $config->get('streetViewControl') ? TRUE : FALSE;
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['styles'] = $config->get('styles');
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['zoom'] = (int) $config->get('zoom');
  $build['#attached']['drupalSettings']['data_attribute_gmap']['gmap']['zoomControl'] = $config->get('zoomControl') ? TRUE : FALSE;
}
