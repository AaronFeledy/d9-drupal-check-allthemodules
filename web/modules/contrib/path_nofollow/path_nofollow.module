<?php

// variable key(s)
define('PATH_NOFOLLOW_PATH_MATCH', 'paths_nofollow');

/*
 * 
 * 
 * Add <meta name="robots" content="noindex"> if the current page matches the given pattern
 */
function path_nofollow_page_attachments_alter(array &$page) {

  // get all paths for not to index
  $config = \Drupal::config('path_nofollow.settings');
  $pathlist = $config->get(PATH_NOFOLLOW_PATH_MATCH);

  //Path of the current page, and alias if it contains
  $current_path = \Drupal::service('path.current')->getPath();
  $alias_path = \Drupal::service('path.alias_manager')->getAliasByPath($current_path);

  //Current path and alias contains '/' character at the beginning. 'pathlist' could start with '/' character or not.
  //If a path of pathlist doesn't start with '/', it will not match with current path or alias.
  //To solve the problem, we remove the first character of current path and alias, so if a path of 'pathlist'
  //doesn't start with '/', and is the same path, it will match with the substring.
  $current_pathSub = substr($current_path , 1);
  $alias_pathSub = substr($alias_path, 1);
  
   
  if ( \Drupal::service('path.matcher')->matchPath($current_path, $pathlist)
    || \Drupal::service('path.matcher')->matchPath($alias_path, $pathlist)
    || \Drupal::service('path.matcher')->matchPath($current_pathSub, $pathlist)
    || \Drupal::service('path.matcher')->matchPath($alias_pathSub, $pathlist)) {
    
      // add <meta name="robots" content="noindex">
      $nofollow = [
      '#tag' => 'meta',
      '#attributes' => [
        'name' => 'robots',
        'content' => 'noindex',
      ],
      ];
      $page['#attached']['html_head'][] = [$nofollow, 'robots'];
  }

}
