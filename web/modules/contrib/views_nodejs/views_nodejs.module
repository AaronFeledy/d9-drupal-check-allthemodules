<?php

/**
 * @file
 * Views nodejs integration module.
 */

use Drupal\Core\Url;
use Drupal\Component\Utility\Html;

/**
 * Implements hook_views_pre_render().
 */
function views_nodejs_views_pre_render($view) {

  // Send identifying data about this view.
  if (empty($view->is_attachment) && empty($view->live_preview)) {
    $current_url = Url::fromRoute('<current>');
    $query = \Drupal::request()->query->all();
    unset($query['q']);
    $current_url->setOption('query', $query);
    $view->element['#attached']['drupalSettings']['viewsNodejs'] = array(
      'ajax_path' => \Drupal::url('views.ajax'),
      'views' => array(
        'views_dom_id:' . $view->dom_id => array(
          'href' => $current_url->toString(),
          'settings' => array(
            'view_name' => $view->storage->id(),
            'view_display_id' => $view->current_display,
            'view_args' => Html::escape(implode('/', $view->args)),
            'view_path' => Html::escape(Url::fromRoute('<current>')->toString()),
            'view_base_path' => $view->getPath(),
            'view_dom_id' => $view->dom_id,
            'pager_element' => isset($view->pager) ? $view->pager->getPagerId() : 0,
          ),
        ),
      ),
    );

    // Add js for proper work Views with nodejs.
    $view->element['#attached']['library'][] = 'views_nodejs/views_nodejs';
  
    // Enable channel for current view.
    nodejs_send_content_channel_token('views_nodejs_' . $view->storage->id() . $view->current_display);
  }

  return $view;
}


