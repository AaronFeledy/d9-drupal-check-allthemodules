<?php

/**
 * @file
 * Provides integration of the Baidu Map JS API with the Geofield.
 *
 * Implements a Baidu geocoder and a geofield display formatter.
 */

/**
 * Implements hook_theme().
 */
function baidu_map_geofield_theme($existing, $type, $theme, $path) {
  return [
    'baidu_map_geofield_widget' => [
      'variables' => [
        'mapid' => NULL,
        'width' => '100%',
        'height' => '450px',
      ],
    ],
    'baidu_map_geofield' => [
      'variables' => [
        'mapid' => NULL,
        'width' => '100%',
        'height' => '450px',
      ],
    ],
    'baidu_map_geofield_infowindow' => [
      'variables' => [
        'entity' => NULL,
        'instance' => NULL,
        'entity_type' => NULL,
        'langcode' => NULL,
        'items' => NULL,
        'delta' => 0,
      ],
    ],
  ];
}

/**
 * Load all Geofield Google Map client files and return markup for a map.
 *
 * @param array $js_settings
 *   The map rendering data.
 *
 * @return array
 *   The returned render array.
 */
function baidu_map_geofield_render(array $js_settings) {

  $render_array = [
    '#theme' => 'baidu_map_geofield',
    '#mapid' => $js_settings['mapid'],
    '#height' => $js_settings['map_settings']['map_dimensions']['height'],
    '#width' => $js_settings['map_settings']['map_dimensions']['width'],
    '#attached' => [
      'library' => [
        'baidu_map/baidu_map_js',
        'baidu_map_geofield/geojson',
        'baidu_map_geofield/baidu_map_geofield',
      ],
      'drupalSettings' => [
        'baidu_map_geofield' => [$js_settings['mapid'] => $js_settings],
      ],
    ],
    '#cache' => [
      'contexts' => ['url.path', 'url.query_args'],
    ],
  ];

  return $render_array;
}
