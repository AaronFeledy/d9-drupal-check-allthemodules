<?php

/**
 * Change the login forms and user edit forms.
 *
 * Implements hook_form_alter().
 */
function pass_reset_checkbox_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  if ($form_id == 'user_login_form') {
    $form['pass_reset_toggle'] = [
      '#type' => 'checkbox',
      '#title' => t('I have forgotten my password.'),
    ];
    $form['pass']['#states'] = [
      'visible' => [
        ':input[name="pass_reset_toggle"]' => [ 'checked' => FALSE ],
      ],
      'optional' => [
        ':input[name="pass_reset_toggle"]' => [ 'checked' => TRUE ],
      ],
    ];
    $form['#validate'][] = 'pass_reset_checkbox_login_form_validate';
  }
}

function pass_reset_checkbox_login_form_validate(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  if ($form_state->getValue('pass_reset_toggle') == 1) {
    $form_state->clearErrors();
    $account = user_load_by_name($form_state->getValue('name'));
    if ($account) {
      $mail = $account->get('mail')->value;
      if (\Drupal::service('email.validator')->isValid($mail)) {
        // @see: UserAuthenticationController::resetPassword()
        $mail = _user_mail_notify('password_reset', $account, $account->getPreferredLangcode());
        if (empty($mail)) {
          throw new \Symfony\Component\HttpKernel\Exception\BadRequestHttpException('Unable to send email. Contact the site administrator if the problem persists.');
        }
        else {
          drupal_set_message(t('Further instructions have been sent to your email address.'), 'notice');
          // Prevent the default login submit handler from trying to do anything beyond this point.
          $form['#submit'] = [];
        }
      }
    }
    else {
      $form_state->setErrorByName('name', t('Unrecognized username.'));
    }
  }
  else {
    // Prevent the default error message from showing a link to the pass reset page.
    if (!empty($form_state->getError($form['name']))) {
      $form_state->clearErrors();
      $form_state->setErrorByName('name', t('Unrecognized username or password.'));
    }
  }
}

/**
 * When using the login flow with the forgot pass checkbox, there is no need for
 * a local task to reset the pass anymore, so get rid off it.
 *
 * Implements hook_menu_local_tasks_alter().
 */
function pass_reset_checkbox_menu_local_tasks_alter(&$data, $route_name) {
  if (isset($data['tabs'][0]['user.pass'])) {
    unset($data['tabs'][0]['user.pass']);
  }
}

/**
 * When using the login flow with the forgot pass checkbox, there is no need for
 * a link to reset the pass on a login block anymore, so get rid off it.
 *
 * Implements hook_block_view_alter().
 */
function pass_reset_checkbox_block_view_alter(array &$build, \Drupal\Core\Block\BlockPluginInterface $block) {
  if ($block->getBaseId() === 'user_login_block') {
    $build['#pre_render'][] = '_pass_reset_checkbox_block_prerender';
  }
}

function _pass_reset_checkbox_block_prerender(array $build) {
  unset($build['content']['user_links']['#items']['request_password']);
  return $build;
}
