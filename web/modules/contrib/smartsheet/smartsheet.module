<?php

/**
 * @file
 * Contains smartsheet.module.
 */

use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_alter().
 */
function smartsheet_form_alter(array &$form, FormStateInterface $form_state) {
  if (isset($form['#smartsheet_sheet_id'])) {
    $form['#submit'][] = 'smartsheet_form_alter_submit';
  }
}

/**
 * Submit callback for smartsheet_form_alter().
 */
function smartsheet_form_alter_submit(array &$form, FormStateInterface $form_state) {
  if (isset($form['#smartsheet_sheet_id']) && isset($form['#smartsheet_column_mapping'])) {
    $smartsheet_client = \Drupal::service('smartsheet.client');

    if ($columns = $smartsheet_client->get('/sheets/' . $form['#smartsheet_sheet_id'] . '/columns')) {
      foreach ($columns['data'] as $column) {
        array_walk($form['#smartsheet_column_mapping'], function (&$value, $key) use ($column) {
          if ($column['title'] == $value) {
            $value = $column['id'];
          }
        });
      }
    }

    $row = [];
    foreach (array_filter($form['#smartsheet_column_mapping'], 'is_int') as $field => $column_id) {
      $value = $form_state->getValue($field);

      if (isset($form[$field]['#options'])) {
        $value = $form[$field]['#options'][$value];

        while (is_array($value)) {
          $value = reset($value);
        }
      }

      $row['cells'][] = [
        'columnId' => $column_id,
        'value' => $value,
      ];
    }

    $row['toBottom'] = TRUE;

    $smartsheet_client->post('/sheets/' . $form['#smartsheet_sheet_id'] . '/rows', [$row]);
  }
}
