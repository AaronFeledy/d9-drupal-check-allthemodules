<?php

/**
 * @file
 * Drupal module for RefTagger (http://reftagger.com/).
 */

/**
 * Implements hook_page_attachments().
 */
function reftagger_page_attachments(array &$attachments) {
  if (\Drupal::service('router.admin_context')->isAdminRoute()) {
    return;
  }

  $attachments['#attached']['library'][] = 'reftagger/reftagger-init';

  $config = Drupal::config('reftagger.settings');
  $settings = array(
    'bibleVersion' => $config->get('version'),
    'linksOpenNewWindow' => (bool) $config->get('link_target'),
    'useTooltip' => (bool) $config->get('tooltip_enable'),
    'caseInsensitive' => (bool) $config->get('case_insensitive'),
    'dropShadow' => (bool) $config->get('drop_shadow'),
    'roundCorners' => (bool) $config->get('rounded_corners'),
    'socialSharing' => array_values($config->get('social_sharing')),
    'addLogosLink' => (bool) $config->get('logos_icon_link'),
    'logosLinkIcon' => $config->get('logos_icon_type'),
    'convertHyperlinks' => (bool) $config->get('logos_icon_add'),
    'tagChapters' => (bool) $config->get('chapter_tagging'),
    'tooltipStyle' => $config->get('background_color'),
  );

  $exclude_tags = reftagger_exclude_tags();
  if (count($exclude_tags)) {
    $settings['noSearchTagNames'] = $exclude_tags;
  }

  $class_list = str_replace(' ', '', $config->get('exclude_classes'));
  if (!empty($class_list)) {
    $settings['noSearchClassNames'] = explode(',', $class_list);
  }

  $bible_reader = $config->get('reader');
  if ($bible_reader !== 'biblia') {
    $settings['bibleReader'] = $bible_reader;
  }

  $styles = $config->get('styles_custom');
  if ($styles) {
    $settings['customStyle'] = $styles;
  }
  $attachments['#attached']['drupalSettings']['refTagger'] = $settings;

  // Vary the attached JS based on whether the Reftagger config changes.
  $renderer = \Drupal::service('renderer');
  $renderer->addCacheableDependency($attachments, $config);
}

/**
 * Implements hook_help().
 */
function reftagger_help($route_name, \Drupal\Core\Routing\RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'reftagger.reftagger_config_form':
      return '<p>' . t('<a href="http://www.logos.com/reftagger">RefTagger</a> is an amazing, free web tool that instantly makes all the Bible references on your site come alive! Bare links turn into hyperlinks to the full text of the passage at Bible.Logos.com, making it easy for your readers to access the text of Scripture with just a click. Even better, RefTagger brings the text right to your readers by generating a tooltip window that pops up instantly when they hover over the reference. You can also have RefTagger add an  icon that is hyperlinked to the passage in Logos Bible software.') . '</p>';
  }
}

/**
 * Returns list of social networks options.
 *
 * @param bool $keys_only
 *   If true, only the keys of the list are returned.
 *
 * @return array
 *   Associative array, where keys are machine names and values are labels of
 *   social networks.
 */
function _reftagger_get_social_sharing_options($keys_only = FALSE) {
  $options = array(
    'twitter' => t('Twitter'),
    'facebook' => t('Facebook'),
    'google' => t('Google+'),
    'faithlife' => t('Faithlife'),
  );

  return $keys_only ? array_keys($options) : $options;
}

/**
 * Return an array of options for HTML tags to exclude
 */
function reftagger_tags() {
  return array(
    'b' => 'Bold/Strong',
    'i' => 'Italic/Emphasis',
    'u' => 'Underline',
    'ol' => 'Ordered List',
    'ul' => 'Unordered List',
    'span' => 'Span',
    'h1' => 'Header 1',
    'h2' => 'Header 2',
    'h3' => 'Header 3',
    'h4' => 'Header 4',
    'h5' => 'Header 5',
    'h6' => 'Header 6'
  );
}

/**
 * Grab the exclude tags and add synonym tags
 */
function reftagger_exclude_tags() {
  $exclude_tags = Drupal::config('reftagger.settings')->get('exclude_tags');

  foreach ($exclude_tags as $tag) {
    if ($tag) {
      $tags[] = $tag;
      if ($tag == 'b') {
        $tags[] = 'strong';
      }
      if ($tag == 'i') {
        $tags[] = 'em';
      }
    }
  }
  return $tags;
}

/**
 * Return an array list of Bible version options for tooltips
 */
function reftagger_bible_versions($abbr = FALSE) {
  return array(
    'English' => array(
      'AB' => $abbr ? 'AMP' : 'Amplified',
      'ASV' => $abbr ? 'ASV' : 'American Standard Version',
      'DAR' => $abbr ? 'DARBY' : '1890 Darby Bible',
      'ESV' => $abbr ? 'ESV' : 'English Standard Version',
      'GW' => $abbr ? 'GW' : 'God\'s Word Translation',
      'HCSB' => $abbr ? 'HCSB' : 'Holman Christian Standard Bible',
      'KJV' => $abbr ? 'KJV' : 'King James Version',
      'LEB' => $abbr ? 'LEB' : 'Lexham English Bible',
      'MESSAGE' => $abbr ? 'MESSAGE' : 'The Message',
      'NASB' => $abbr ? 'NASB' : 'New American Standard',
      'NCV' => $abbr ? 'NCV' : 'New Century Version',
      'GS-NETBIBLE' => $abbr ? 'NET' : 'The NET Bible',
      'NIV' => $abbr ? 'NIV' : 'New International Version',
      'NIRV' => $abbr ? 'NIRV' : 'New International Reader\'s Version',
      'NKJV' => $abbr ? 'NKJV' : 'New King James Version',
      'NLT' => $abbr ? 'NLT' : 'New Living Translation',
      'NRSV' => $abbr ? 'NRSV' : 'New Revised Standard Version',
      'RSV' => $abbr ? 'RSV' : 'Revised Standard Version',
      'TNIV' => $abbr ? 'TNIV' : 'Today\'s New International Version',
      'YLT' => $abbr ? 'YLT' : 'Young\'s Literal Translation',
    ),
    'Arabic' => array(
      'AR-VANDYKE' => $abbr ? 'Arabic' : 'Arabic Bible (Smith & Van Dyke)',
    ),
    'Czech' => array(
      'CS-KR1579' => $abbr ? 'KR1579' : 'Podle Puvodního Vydání Kralického',
    ),
    'French' => array(
      'LSG' => $abbr ? 'LSG' : 'Louis Segond',
    ),
    'German' => array(
      'LUO1545' => $abbr ? 'LUO1545' : 'Luther Bibel (1545)',
      'LU1912' => $abbr ? 'LU1912' : 'Luther Bibel (1912)',
    ),
    'Greek' => array(
      'TISCH' => $abbr ? 'TISCH' : 'Novum Testamentum Graece',
      'TISCHNT' => $abbr ? 'TISCHNT' : 'Novum Testamentum Graece (Tischendorf)',
    ),
    'Hungarian' => array(
      'HU-BIBLE' => $abbr ? 'SZENT' : 'Szent Biblia',
    ),
    'Italian' => array(
      'IT-DIODATI1649' => $abbr ? 'DIODATI' : 'Giovanni Diodati Bibbia',
    ),
    'Russian' => array(
      'RST' => $abbr ? 'RST' : 'Русский Синодальный Перевод (1876/1956)',
    ),
    'Spanish' => array(
      'RVA' => $abbr ? 'RVA' : 'Reina-Valera Actualizada',
      'NBLH' => $abbr ? 'NBLH' : 'Nueva Biblia de los Hispanos',
      'LBLA95' => $abbr ? 'LBLA' : 'La Biblia de las Américas',
      'BB-UBS-BLS' => $abbr ? 'TLA' : 'Traducción en lenguaje actual',
    ),
  );
}
