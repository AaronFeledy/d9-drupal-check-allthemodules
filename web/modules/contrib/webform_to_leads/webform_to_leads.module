<?php

function webform_to_leads_webform_submission_insert(Drupal\webform\WebformSubmissionInterface $webform_submission) {
  $webFormId = $webform_submission->get("webform_id")->getString();
  $config = \Drupal::config('webform_to_leads.forms');

  if ($settings = $config->get($webFormId)) {
    if ($settings['active'] == 1) {
      $config_global = \Drupal::config('webform_to_leads.settings');
      $post = array();
      $post['oid'] = $config_global->get("salesforce_oid");
      $post['debug'] = $config_global->get("debug");
      $post['debugEmail'] = $config_global->get("debug_email");
      $post['lead_source'] = $settings['lead_source'];
      $settings_fields = $config_global->get("fields");
      //data from webform submission
      $data = $webform_submission->getData();
      //map fields
      foreach ($settings_fields as $field) {
        foreach ($field as $key => $value) {
          if (isset($data[$key])) {
            $post[$value] = $data[$key];
          }
        }
      }
      if (!empty($post['oid']) && $url = $config_global->get("salesforce_url")) {
        \Drupal::httpClient()->post($url, [
          'verify' => TRUE,
          'form_params' => $post,
        ])->getBody()->getContents();
      }
    }
  }
}

/**
 * Implements hook_local_tasks_alter().
 */
function webform_to_leads_local_tasks_alter(&$local_tasks) {
  $local_tasks['entity.webform.settings_web2leads'] = array(
    'route_name' => "entity.webform.settings_web2leads",
    "route_parameters" => [],
    'title' => "Web 2 Leads",
    'base_route' => '',
    'parent_id' => 'entity.webform.settings',
    'weight' => 80,
    'options' => [],
    'class' => "Drupal\Core\Menu\LocalTaskDefault",
    'id' => "",
    'provider' => "webform_to_leads"
  );
}
