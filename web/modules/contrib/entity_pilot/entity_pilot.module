<?php

/**
 * @file
 * Provides main module functionality.
 */

use Drupal\Core\Cache\Cache;
use Drupal\Core\Entity\ContentEntityInterface;
use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_entity_insert().
 */
function entity_pilot_entity_update(EntityInterface $entity) {
  if ($entity instanceof ContentEntityInterface) {
    $tag = sprintf('ep__%s__%s', $entity->getEntityTypeId(), $entity->id());
    Cache::invalidateTags([$tag]);
  }
}

/**
 * Implements hook_local_tasks_alter().
 */
function entity_pilot_local_tasks_alter(&$tasks) {
  if (!empty($tasks['field_ui.fields:overview_ep_arrival'])) {
    $tasks['entity_pilot.manage_arrival_fields'] = [
      'base_route' => 'entity.ep_account.edit_form',
      'weight' => 50,
      'route_name' => $tasks['field_ui.fields:overview_ep_arrival']['route_name'],
      'title' => t('Arrival Fields'),
      'parent_id' => NULL,
      'options' => [],
      'route_parameters' => [],
      'class' => 'Drupal\Core\Menu\LocalTaskDefault',
      'provider' => 'entity_pilot',
      'id' => 'entity_pilot.manage_arrival_fields',
    ];
    $tasks['field_ui.fields:display_overview_ep_arrival']['title'] = t('Arrival display');
    $tasks['field_ui.fields:form_display_overview_ep_arrival']['title'] = t('Arrival form display');
  }
}

/**
 * Implements hook_entity_view().
 */
function entity_pilot_entity_view_alter(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display) {
  if (!empty($entity->in_preview) && $build['#view_mode'] == 'entity_pilot_preview') {
    // We don't want these.
    unset($build['#contextual_links']);
  }
}

/**
 * Implements hook_entity_bundle_info().
 */
function entity_pilot_entity_bundle_info() {
  $bundles['ep_arrival'] = [];
  foreach (\Drupal::entityManager()->getStorage('ep_account')->loadMultiple() as $entity) {
    $bundles['ep_arrival'][$entity->id()]['label'] = $entity->label();
  }
  return $bundles;
}

/**
 * Implements hook_entity_presave().
 */
function entity_pilot_entity_presave(EntityInterface $entity) {
  if ($entity->getEntityTypeId() === 'menu_link_content') {
    /** @var \Drupal\menu_link_content\MenuLinkContentInterface $entity */
    $url = $entity->getUrlObject();
    if (!$url->isRouted()) {
      $path = $url->getUri();
      if (strpos($path, 'base:entity_pilot') === 0) {
        // This is an entity pilot path.
        $parts = explode('/', $path);
        // Remove the base:entity_pilot.
        array_shift($parts);
        if (count($parts) === 2) {
          list ($entity_type_id, $entity_uuid) = $parts;
          if ($target_entity = \Drupal::service('entity.repository')
            ->loadEntityByUuid($entity_type_id, $entity_uuid)
          ) {
            $new_link = 'entity:' . $entity_type_id . '/' . $target_entity->id();
            $entity->set('link', $new_link);
          }
        }
      }
    }
  }
}
