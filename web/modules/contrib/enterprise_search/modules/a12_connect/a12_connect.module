<?php

define('A12_CONNECT_WEBSERVICES_URL', 'https://services.axis12.com');
define('A12_CONNECT_VALIDATE_METHOD', 'a12_webservices.validate');


use Drupal\a12_connect\Inc\A12Config;
use Drupal\a12_connect\Inc\A12Connector;
use Drupal\a12_connect\Inc\A12ConnectorException;


/**
 * Get the A12 Connector.
 *
 * This is statically cached so we do not uneccesarily create multiple
 * connectors on a single page request.
 */
function a12_connect_get_connector() {
    $connector = &drupal_static(__FUNCTION__);
    if (!$connector) {
        global $base_url;
        $secret = A12Config::getSecret();
        $key = A12Config::getId();

        $connector = new A12Connector($key, $secret, $base_url);
    }

    return $connector;
}

/**
 * Validate credentials of the subscription.
 *
 * @return bool
 *   TRUE if valid credentials.
 */
function a12_connect_credentials_validate($form, &$form_state) {
    $values = $form_state['values'];
    $key = trim($values['a12_identifier']);
    $secret = trim($values['a12_key']);

    global $base_url;
    $connector = new A12Connector($key, $secret);

    try {
        $result = $connector->authenticate();
    }
    catch (A12ConnectorException $e) {
        drupal_set_message($e->getMessage(), 'error');
        return FALSE;
    }

    return $result;
}

/**
 * Deletes A12 subscription settings.
 */
function a12_connect_delete_submit() {
    A12Config::deleteConfig();
    return drupal_set_message(t('Settings deleted'));
}
