<?php

/**
 * Implements hook_ENTITY_TYPE_insert() for comment entities.
 */
function comment_admin_notify_comment_insert($comment) {
  if (comment_notify_variable_get('comment_admin_notify', TRUE)) {
    $mailto = comment_notify_variable_get('comment_admin_notify_mailto', comment_notify_variable_get_site_email());
    $langcode = \Drupal::languageManager()->getDefaultLanguage()->getId();
    
    $raw_values = array(
      'subject' => comment_notify_variable_get('comment_admin_notify_subject', 'Comment notification'),
      'body' => comment_notify_variable_get('comment_admin_notify_mailtext', comment_admin_default_mailtext()),
    );

    $entity_type = $comment->getCommentedEntityTypeId();
    
    $node = NULL;
    if ($entity_type == 'node') {
      $node = node_load($comment->getCommentedEntityId());
    }
    
    $params = array();
    $token_service = \Drupal::token();
    foreach ($raw_values as $key => $value) {
      $params[$key] = $token_service->replace($value, array('comment' => $comment, 'node' => $node));
    }
    
    $mail = \Drupal::service('plugin.manager.mail')->mail('comment_admin_notify', 'comment_notify_mail', $mailto, $langcode, $params);

    // Add an entry to the watchdog log.
    $log_content = t('Type: @type, eid: @eid, cid: @cid. Subject: @subject', array('@type' => $entity_type, '@eid' => $comment->getCommentedEntityId(), '@cid' => $comment->id(), '@subject' => $comment->getSubject()));
    \Drupal::logger('comment_admin_notify')->notice($log_content);
  }
}

/**
 * Implements hook_mail().
 */
function comment_admin_notify_mail($key, &$message, $params) {
  $message['subject'] = $params['subject'];
  $message['body'][] = $params['body'];
}

function comment_notify_variable_get($key, $default = NULL) {
  $config = \Drupal::config('comment_admin_notify.settings');
  $value = $config->get($key);
  if (empty($value)) {
    $value = $default;
  }
  return $value;
}

function comment_notify_variable_get_site_email() {
  $site_config = \Drupal::config('system.site');
  $site_mail = $site_config->get('mail');
  if (empty($site_mail)) {
    $site_mail = ini_get('sendmail_from');
  }
  return $site_mail;
}

function comment_admin_default_mailtext() {
  $output = '
Dear Admin,

You have received a comment on: "[node:title]"

----
[comment:title]
[comment:body]
----

You can view the comment at the following url
[comment:url]';
  
  return $output;
}