<?php
/**
 * @file
 * Unity Api Integration module.
 */

/**
 * Implements hook_library_info().
 */
function unity_webapp_library_info() {
  $path = drupal_get_path('module', 'unity_webapp');
    $libraries['unity_webapp'] = array(
    'title' => 'Unity Webapp',
    'version' => "1.0",
    'js' => array(
      // Add the JavaScript, with a group and weight such that it will run
      // before modules/contextual/contextual.toolbar.js.
      $path . '/unity_webapp.js' => array('group' => JS_LIBRARY, 'weight' => -2),
    ),
    'dependencies' => array(
      array('system', 'jquery'),
      array('system', 'drupal'),
      array('system', 'jquery.once'),
    ),
  );
  return $libraries;
}

/**
 * Call hooks to build the links.
 *
 * @return array
 *  Array with links from called hooks.
 */
function unity_webapp_generate_links_array() {
  $links = module_invoke_all('unity_webapp_addlinks');
  return ($links);
}

/**
 * Implements hook_page_alter().
 *
 * Insert Javascript into the page.
 */
/**
* Implements hook_page_build().
*/
function unity_webapp_page_build(&$page) {

  if (! user_access('access unity webapp')) {
    return;
  }
  
  // Declaring a proper library including its dependencies, and
  // attaching it is the recommended way:
  $page['#attached']['library'][] = array('unity_webapp', 'unity_webapp');
  
  global $base_root;
  $urlparse = parse_url($_SERVER['HTTP_HOST']);
  if (isset($urlparse['host'])) { 
    $uri = $urlparse['host'];
  }
  else {
    $uri = $_SERVER['HTTP_HOST'];
  }
  $faviconurl = theme_get_setting('favicon', config('system.theme')->get('default'));
  // Replace standard drupal favicon with higher quality one.
  if ($faviconurl == $base_root . "/core/misc/favicon.ico") {
    $faviconurl = $base_root . "/" .drupal_get_path("module","unity_webapp") . "/img/druplicon.ico";
  }
  if ((config('unity_webapp.settings')->get('title')) && (config('unity_webapp.settings')->get('title') != "")) {
    $unity_title = config('unity_webapp.settings')->get('title');
  }
  else {
    $unity_title = config('system.site')->get('name');
  }
  $my_settings = array(
    'pagetitle' => drupal_get_title(),
    'sitename' => $unity_title,
    'links'    => unity_webapp_generate_links_array(),
    'favicon'  => $faviconurl,
    'baseurl'  => $uri,
  );
  // TODO: drupal_alter to allow other modules to alter the output.
  drupal_add_js(array('unity_api' => $my_settings), 'setting');
}

/**
 * Implements hook_permission().
 *
 */
function unity_webapp_permission() {
  return array(
    'access unity webapp' => array(
      'title' => t('Access unity webapp'), 
      'description' => t('Access unity webapp.'),
    ),
  );
}

/**
 * Implements hook_menu().
 */
function unity_webapp_menu() {
  $items = array();

  $items['admin/config/user-interface/unity-webapp'] = array(
    'title' => 'Unity Webapp',
    'type' => MENU_NORMAL_ITEM,
    'page callback' => 'drupal_get_form',
    'page arguments' => array('unity_webapp_form'),
    'access callback' => 'user_access',
    'access arguments' => array('administer site configuration'),
  );

  return $items;
}

/**
 * Page callback for unity_webapp.
 */
function unity_webapp_form($form, $form_state) {
  $form = array();
  $form['unity_webapp_title'] = array(
    '#required' => '0',
    '#description' => "<p>" . t('Title to use for unity launcher. Defaults to global sitename if empty.') . "</p>" . "<p><strong>" . t("Unity Api supports only Alphanumeric Characters and whitespace") . "</strong></p>",
    '#default_value' => config('unity_webapp.settings')->get('title'),
    '#weight' => '0',
    '#type' => 'textfield',
    '#title' => t('Title'),
  );
  return system_config_form($form,$form_state);
}

function unity_webapp_form_submit($form, &$form_state) {
  $config = config('unity_webapp.settings');
  $config
    ->set('title', $form_state['values']['unity_webapp_title']);
  $config->save();
}

/**
 * Implements hook_block_info().
 */
function unity_webapp_block_info() {
  $blocks = array();

  $blocks['unity_webapp'] = array(
    'info' => 'Unity Webapp',
  );

  return $blocks;
}

/**
 * Implements hook_block_view().
 */
function unity_webapp_block_view($delta) {
  if ('unity_webapp' == $delta && user_access('administer site configuration')) {
    return array(
      'subject' => 'Unity Webapp',
      'content' => drupal_get_form('unity_webapp_form'),
    );
  }
}

/**
 * Implements hook_variable_info().
 */
function config_builder_variable_info($options) {
  $variables = array();
  $variables['title'] = array(
    'name' => 'title',
    'title' => 'Title',
    'type' => 'string',
    'default' => NULL,
    'group' => 'unity_webapp',
    'module' => 'unity_webapp',
  );
  return $variables;
}

/**
 * Implements hook_variable_group_info().
 */
function unity_webapp_variable_group_info() {
  $groups = array();

  $groups['unity_webapp'] = array(
    'title' => 'Unity Webapp',
    'description' => 'Settings for Unity Web Api integration',
    'path' => 'admin/config/user-interface/unity-webapp',
    'access' => 'administer site configuration',
  );

  return $groups;
}

