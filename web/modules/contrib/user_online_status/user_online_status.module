<?php

/**
 * @file
 * Contains user_online_status.module.
 */

use Drupal\Core\Entity\Display\EntityViewDisplayInterface;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_entity_extra_field_info().
 */
function user_online_status_entity_extra_field_info() {

  $extra = [];

  $extra['user']['user']['display']['online_status'] = [
    'label'       => t('Online Status'),
    'description' => t("Show the user's online status"),
    'weight'      => 100,
    'visible'     => TRUE,
  ];

  return $extra;
}

/**
 * Implements hook_ENTITY_TYPE_view().
 */
function user_online_status_user_view(array &$build, EntityInterface $entity, EntityViewDisplayInterface $display, $view_mode) {

  if ($display->getComponent('online_status')) {

    $build['online_status'] = [
      '#theme'         => 'user_online_status',
      '#label'         => t('Online Status'),
      '#label_display' => 'inline',
      '#uid'           => $entity->id(),
      '#view_mode'     => $view_mode,
      '#attached'      => [
        'library' => 'user_online_status/online_status',
      ],
    ];
  }
}

/**
 * Implements hook_theme().
 */
function user_online_status_theme($existing, $type, $theme, $path) {

  return [
    'user_online_status' => [
      'variables' => [
        'label'         => NULL,
        'label_display' => NULL,
        'uid'           => NULL,
        'view_mode'     => NULL,
      ],
    ],
  ];
}

/**
 * Implements hook_theme_suggestions_HOOK().
 */
function user_online_status_theme_suggestions_user_online_status(array $variables) {

  $suggestions = [];

  $suggestions[] = $variables['theme_hook_original'] . '__' . $variables['uid'] . '__' . $variables['view_mode'];
  $suggestions[] = $variables['theme_hook_original'] . '__' . $variables['uid'];
  $suggestions[] = $variables['theme_hook_original'] . '__' . $variables['view_mode'];

  return $suggestions;
}
