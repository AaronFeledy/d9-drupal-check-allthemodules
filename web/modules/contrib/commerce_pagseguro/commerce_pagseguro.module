<?php

/**
 * @file
 * Provides PagSeguro integration for Drupal Commerce.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\commerce_pagseguro\Plugin\Commerce\PaymentGateway\PagseguroPaymentHandler;

/**
 * Implements hook_entity_view_alter().
 */
function commerce_pagseguro_entity_view_alter(array &$build, Drupal\Core\Entity\EntityInterface $entity, \Drupal\Core\Entity\Display\EntityViewDisplayInterface $display) {
  if ($entity->getEntityType()->id() == 'commerce_order') {
    // Todo: Add Boleto and Debit payment links to order page.
  }
}

/**
 * Implements hook_help().
 */
function commerce_pagseguro_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.commerce_pagseguro':
      return check_markup(file_get_contents(dirname(__FILE__) . '/README.txt'));
  }
}

function commerce_pagseguro_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
  //commerce_checkout_flow_multistep_default
  if ($form_id == 'commerce_checkout_flow_multistep_default' && $form_state->getBuildInfo()['args'][0] == 'review') {
    $order = \Drupal::routeMatch()->getParameter('commerce_order');
 
    $payment_method = $order->payment_method->referencedEntities()[0];

    if ($payment_method->getType()->getPluginId() == 'pagseguro_lightbox') {
      $payment_handler = new PagseguroPaymentHandler($order, $payment_method);
      $result = $payment_handler->payPagseguroLightbox();
      $payment_handler->addPagseguroLightBoxToForm($form, $result->getCode());

      $form['transaction_code'] = array(
        '#type' => 'hidden',
        '#id' => 'transaction-code',
        '#value' => "",
      );

      $form['#validate'][] = 'commerce_pagseguro_lightbox_checkout_validate';
    }
  }
}

function commerce_pagseguro_lightbox_checkout_validate(&$form, \Drupal\Core\Form\FormStateInterface $form_state) {
  //$form_state->getValues();
  // Todo: Validate transaction code.
}