<?php
/**
 * @file
 * Add automatic fancyzoom support to the site
 */

use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Config\ConfigFactoryInterface;
use Drupal\Core\Url;

/**
 * Parse the .info.yml file to get the version, or assume dev
 */
use Symfony\Component\Yaml\Yaml;
use Symfony\Component\Yaml\Parser;

function _fancyzoom_version() {
  $parser = new Parser();
  $path = drupal_get_path('module', 'fancyzoom') . '/fancyzoom.info.yml';
  $yaml = file_get_contents($path);
  $ini = $parser->parse($yaml);
  return isset($ini['version']) ? $ini['version'] : '8.x-1.x-dev';
}

/**
 * Implements hook_help().
 */
function fancyzoom_help($route_name, RouteMatchInterface $route_match) {
  if ($route_name == 'fancyzoom.config') {
    $target = array('target' => '_blank');
    $base = base_path();
    $args = array(
      '!url1' => _l('Cabel Sasser / Panic Inc.', 'http://www.cabel.name/', $target),
      '!url2' => _l('Thinkyhead', 'http://www.thinkyhead.com/design/fancyzoom', $target),
      '!url3' => _l('www.fancyzoom.com', 'http://www.fancyzoom.com/', $target + array('style' => 'color:red;text-decoration:underline'))
    );
    return t('<p style="font-size:small"><b>FancyZoom ' . _fancyzoom_version() . '</b><br />Drupal Module &copy; 2014 !url2<br />FancyZoom 1.1 &copy; 2009 !url1<br /><span style="color:red">&gt;&gt;For commercial sites please visit !url3 to purchase a license.&lt;&lt;</span></p>', $args);
  }
}

/**
 * Implements hook_permission().
 */
function fancyzoom_permission() {
  return array(
    'administer fancyzoom' => t('Administer FancyZoom')
  );
}

/**
 * Implements hook_page_build().
 */
function fancyzoom_page_build(&$page) {
  $page['#attached']['library'][] = 'fancyzoom';
}

/**
 * Implements hook_libraries_info().
 */
function fancyzoom_libraries_info() {
  $libs = array(
    'jquery' => 'jquery/FancyZoom.js',
    'jquery-min' => 'jquery/FancyZoomMin.js',
    'standard' => 'standard/FancyZoom.js',
    'standard-min' => 'standard/FancyZoomMin.js',
  );

  $libraries['fancyzoom'] = array(
    'name' => 'FancyZoom',
    'vendor url' => 'http://www.fancyzoom.com/',
    'download url' => 'http://www.thinkyhead.com/pub/fancyzoom-script-universal.tar.gz',
    'version' => '2.0',
    'files' => array( 'js' => array( $libs['jquery-min'] ) ),
    'variants' => array(
    )
  );

  foreach ($libs as $k => $v) {
    $libraries['variants'][$k] = array(
      'variant callback' => '_fancyzoom_var',
      'variant arguments' => array('scriptType')
    );
    $libraries['variants'][$k]['files']['js'] = array("js/$v");
  }
  return $libraries;
}

function _fancyzoom_script_variant() {
}

/**
 * Implements hook_library_info().
 */
function fancyzoom_library_info() {
  $corelibrary['fancyzoom.jquery'] = array(
    'dependencies' => array(
      array('system', 'jquery')
    )
  );
  return $corelibrary;
}

/**
 * Implements hook_init().
 */
function fancyzoom_page_alter(&$page) {
  // print_r($page); die;
  _fancyzoom_add_js($page);
}

/**
 * Handy function to add our javascript
 *   - Include settings as part of the Drupal.settings object
 *   - Include FancyZoom javascripts in the page header
 */
function _fancyzoom_add_js(&$page) {
  if ($js = _fancyzoom_script_path()) {

    // get settings as an array
    $keys = array('zoomTime', 'zoomSteps', 'minBorder', 'includeFade', 'includeCaption', 'showClosebox', 'shadowColor', 'zoomImagesURI');
    $settings = array();
    foreach ($keys as $k) {
      $v = _fancyzoom_var($k);
      $settings[$k] = is_numeric($v) ? $v*1 : $v;
    }

    // precalculate a CSS string for RGBA
    $h = $settings['shadowColor'];
    if (strlen($h) == 4) $h = preg_replace('/#(.)(.)(.)/', '#\1\1\2\2\3\3', $h);
    for ($x=1; $x<6; $x+=2) $rgb[] = hexdec(substr($h, $x, 2));
    $settings['shadowSettings'] = '0px 5px 25px rgba(' . join(',', $rgb) . ',';

    // smart replace tokens in the images path
    global $base_path;
    $img = $settings['zoomImagesURI'];
    if (trim($img) == '') {
      $img = _fancyzoom_script_path() . '/images/zoom';
    }
    else {
      $img = str_replace('$t', path_to_theme(), str_replace('$m', drupal_get_path('module', 'fancyzoom'), $img));
    }
    $settings['zoomImagesURI'] = base_path() . $img;

    // expose settings as Drupal.settings.fancyzoom
    _drupal_add_js(array('fancyzoom' => $settings), 'setting');

    // include the selected javascript
    list($dir, $min) = explode('-', _fancyzoom_var('scriptType') . '-');
    if ($min) $min = '.min';
    _drupal_add_js("$js/js/$dir/FancyZoom$min.js");
  }
  elseif (\Drupal::currentUser()->hasPermission('administer fancyzoom')) {
    $args = array('!url' => _l('FancyZoom Javascript', 'http://www.thinkyhead.com/design/fancyzoom', array('target' => '_blank')));
    drupal_set_message(t('<em>FancyZoom is not fully installed yet!<br/>Download and install the !url to complete the installation!</em>', $args), 'warning');
  }
}

/**
 * Implements hook_menu().
 *
 * - Add menu items for the fancyzoom admin page
 *
 */
function fancyzoom_menu() {
  $items['admin/config/media/fancyzoom'] = array(
    'title' => 'FancyZoom',
    'description' => 'Configure zooming images throughout the site.',
    'file' => 'fancyzoom_admin.inc',
    'page callback' => 'fancyzoom_settings',
    'access arguments' => array('administer fancyzoom')
  );
  return $items;
}

function _fancyzoom_script_path() {
  $paths = array(drupal_get_path('module', 'fancyzoom') . '/fancyzoom');
  if (function_exists('libraries_get_path')) {
    $paths[] = libraries_get_path('fancyzoom');
  }
  foreach ($paths as $path) {
    if (file_exists("$path/js/standard/FancyZoom.js")) {
      return $path;
    }
  }
  return FALSE;
}

function _fancyzoom_var($var=FALSE) {
  $defaults = array(
    'zoomTime' => 5,
    'zoomSteps' => 15,
    'minBorder' => 90,
    'includeFade' => 1,
    'includeCaption' => 1,
    'showClosebox' => 1,
    'shadowColor' => '#000000',
    'scriptType' => 'jquery-min',
    'zoomImagesURI' => ''
  );
  return \Drupal::config('fancyzoom.settings')->get($var, $defaults[$var]);
}
