<?php

/**
 * @file
 * Entity Block Visibility hook implementations
 */;
use Drupal\block\Entity\Block;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Entity\ContentEntityInterface;

/**
 * Implements hook_block_access().
 *
 * Determines if block should be restricted by current Content Entity if any.
 *
function entity_block_visibility_block_access(Block $block, $operation, AccountInterface $account, $langcode) {
  if ($operation == 'view') {
    $visibility = $block->get('visibility');
    if (!empty($visibility['bundles'])) {
      $entity = _entity_block_visibility_get_menu_entity();
      if ($entity) {
        $entity_type = $entity->entityType();
        return !empty($visibility['bundles'][$entity_type][$entity->bundle()]);
      }
      // No entity was found but
      return FALSE;
    }
  }
  return;
}

**
 * Utility Function to get menu content entity if any.
 *
 * @return ContentEntityInterface;
 *
function _entity_block_visibility_get_menu_entity() {
  $attributes = \Drupal::request()->attributes->all();
  foreach ($attributes as $attribute) {
    if (is_object($attribute) && $attribute instanceof ContentEntityInterface) {
      return $attribute;
    }
  }
  // ContentEntity was found
  return NULL;
}
/**
 * Implements hook_form_FORM_ID_alter() for block_form().
 *
 * Adds bundle specific visibility options to block configuration form.
 *
function entity_block_visibility_form_block_form_alter(&$form, &$form_state) {
  $block = $form_state['controller']->getEntity();
  $visibility = $block->get('visibility');
  // Is set by node module before remove
  if (isset($visibility['node_type']['types'])) {
    $visibility['bundles']['node'] = $visibility['node_type']['types'];
  }
  unset($form['visibility']['node_type']);
  $entity_defs = \Drupal::entityManager()->getDefinitions();
  $entity_types = \Drupal::entityManager()->getAllBundleInfo();
  // Blocks can't have their own page
  unset($entity_types['custom_block']);
  $form['visibility']['bundles'] = array(
    '#type' => 'details',
    '#title' => t('Entity types'),
    '#collapsed' => TRUE,
    '#group' => 'visibility',
    '#weight' => 5,
    '#tree' => TRUE,
    '#description' => t('Show this block only on pages that display bundles of the given entity types. If you select no bundles, there will be no bundle-specific limitation.'),
    '#attached' => array(
      'js' => array(drupal_get_path('module', 'entity_block_visibility') . '/block_edit.js'),
    ),
  );
  foreach ($entity_types as $entity_type => $entity_type_bundles) {
    if (!is_subclass_of($entity_defs[$entity_type]['class'], '\Drupal\Core\Entity\ContentEntityBase')) {
      continue;
    }
    $options = array();
    foreach ($entity_type_bundles as $bundle_name => $bundle_info) {
      $options[$bundle_name] = $bundle_info['label'];
    }

    $form['visibility']['bundles'][$entity_type] = array(
      '#type' => 'checkboxes',
      '#title' => $entity_defs[$entity_type]['label'],
      '#default_value' => !empty($visibility['bundles'][$entity_type]) ? $visibility['bundles'][$entity_type] : array(),
      '#options' => $options,

    );
  }
}
 *                               */
