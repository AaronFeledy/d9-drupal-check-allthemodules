<?php

/**
 * @file
 * alert_to_admin module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function alert_to_admin_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.alert_to_admin':
	  global $base_path;
      $output = '';
	  $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('The <em>Alert To Administrator</em> module allows you to show site administrators a alert message above most forms on the site. It can be used to help prevent these users from accidentally making destructive changes, either because they forgot they were logged in as an administrator or because they forgot they were logged in to the live site (as opposed to a development server).
       ') . '</p>';
	  $output .= '<p>' . t('On this page, you can change the text of the alert message that site administrators see and configure a list of forms that you do not want the message to appear on. To configure the user roles who will see this message, assign these roles the "see the site administrator alert" permission on the <a href="@permissions_url">user permissions page</a>.
	    ', ['@permissions_url' => $base_path.'admin/people/permissions']) . '</p>';
    return $output;
  }
}
/**
* Implements hook_form_alter()
*/
function alert_to_admin_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {
    if(\Drupal::currentUser()->hasPermission('see the site administrator alert') && !in_array($form_id, alert_to_admin_excluded_forms())){
      $form['alert_to_admin_message'] = [
		'#prefix' => '<div><div class="admin_alert_message">',
		'#attached' => [
			'library' =>  [
			  'alert_to_admin/drupal.alert_to_admin'
			],
		  ],
		'#markup' => alert_to_admin_settings('alert_to_admin_message_text'),
		'#suffix' => '</div></div>',
		// This should make it appear at the top of most forms (unless they
		// use drupal_render to display part of the form first?).
		'#weight' => -1000,
      ];
	  return $form;
    }

}

/**
 * Returns an array of form IDs for which the admin warning will not be
 * printed.
 */
function alert_to_admin_excluded_forms() {
  $excluded_form_text = alert_to_admin_settings('alert_to_admin_excluded_form_ids');
  // Adapted from profile.module.
  $excluded_form_lines = explode("\r\n", $excluded_form_text);
  $excluded_form_ids = [];
  foreach ($excluded_form_lines as $line) {
    $excluded_form_ids[] = $line;
  }
  return $excluded_form_ids;
}

/**
 * Helper function to store this module's variable_get() defaults all in one
 * place.
 */
function alert_to_admin_settings($variable_name) {
  switch($variable_name) {
    case 'alert_to_admin_message_text':
      $default_value = t('Warning: You are logged on to the live site as an administrator. Please think carefully about your changes before submitting this form.');
      break;
    case 'alert_to_admin_excluded_form_ids':
      $default_excluded_form_ids = [
        // It is highly unlikely that the administrator can cause any damage
        // to the site by submitting the search form, so we exclude that by
        // default.
        'search_form',
        'search_block_form',
        'search_theme_form',
      ];
      $default_value = implode("\r\n", $default_excluded_form_ids);
      break;
  }
  if (isset($default_value)) {
	  return \Drupal::config('alert_to_admin.settings')->get($variable_name);
  }
}
