<?php

use Drupal\Component\Utility\Html;
use Drupal\Core\Template\Attribute;
use Drupal\Component\Utility\Unicode;

/**
 * Implementation of hook_theme()
 */
function yml_export_theme() {
  return array(
    'yml_products' => array(
      'variables' => array('nodes' => array(), 'categories' => array()),
    ),
  );
}

/**
 * Implementation of hook_preprocess_HOOK()
 */
function yml_export_preprocess_yml_products(&$variables) {
  global $base_url;
  $variables['base_url'] = $base_url;

  $variables['date'] = date('Y-m-d h:i');

  // Load the site name out of configuration.
  $variables['site_name'] = \Drupal::config('core.site_information')->get('site_name') ?: 'Drupal';
  $variables['delivery'] = \Drupal::config('yml_export.settings')->get('delivery') ?: 'true';

  $categories = array();
  foreach ($variables['categories'] as $term) {
    $attributes = array();
    $tid = $term->tid->value;
    $attributes['tid'] = $tid;
    $parents = \Drupal::entityManager()->getStorage('taxonomy_term')->loadParents($tid);
    $parent = reset($parents)->tid->value;
    if ($parent > 0) $attributes['parent'] = $parent;
    $name = yml_safe($term->name->value);
    $categories[] = array('attributes' => new Attribute($attributes), 'name' => $name);
  }
  $variables['categories'] = $categories;

  $nodes = array();
  foreach ($variables['nodes'] as $node) {
    $new_node = array();
    $new_node['model'] = $node->model->value;
    $new_node['url'] = $base_url . '/node/' . $node->nid->value;
    $new_node['price'] = $node->price->value;
    $new_node['tid'] = end($node->get('taxonomy_catalog')->getValue())['target_id'];
    if (isset($node->uc_product_image[0])) $new_node['picture'] = $node->uc_product_image[0]->entity->url();
    else $new_node['picture'] = '';
    $new_node['title'] = yml_safe(Html::escape($node->title->value));
    $new_node['body'] = yml_safe(Unicode::truncate(strip_tags($node->body->value), 255, TRUE));
    $nodes[] = $new_node;
  }
  $variables['nodes'] = $nodes;
}

// prepare all strings so they are valid for Yandex.Market format
function yml_safe($str) {
  $rep = array(
    '"' => '&quot;',
    '&' => '&amp;',
    '>' => '&gt;',
    '<' => '&lt;',
    "'" => '&apos;'
  );

  return strtr($str, $rep);
}