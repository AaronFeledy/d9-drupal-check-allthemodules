<?php

/**
 * @file
 * Xing Module for Drupal Sites.
 */

use Drupal\Core\Url;
use Drupal\Core\Form\FormStateInterface;

/**
 * Implements hook_form_alter().
 */
function xing_connect_form_alter(&$form, FormStateInterface $form_state, $form_id) {
  switch ($form_id) {
    case 'user_login':
    case 'user_login_block':
    case 'user_login_form':
      // Checking wheather consumer and secreat key set to show login with xing
      // link.
      $settings = \Drupal::service('config.factory')->getEditable('xing_connect.admin.settings');
      if ($settings->get('xing_connect_ckey') &&
        $settings->get('xing_connect_skey')) {

        $form['xing_btn'] = [
          '#title' => t('login with XING'),
          '#type' => 'link',
          '#url' => Url::fromRoute('xing_connect.auth'),
          '#weight' => -10,
        ];
      }
      else {
        \Drupal::logger('xing_connect')->notice('Xing API keys is not configured correctly.');
        drupal_set_message(t('Xing API keys/secreat key is not configured correctly.'), 'warning');
      }
      break;
  }
}

/**
 * Generates a unique username for drupal site based on XING username.
 */
function xing_connect_unique_user_name($xing_name, $i = 0) {
  $trimmed_name = '';
  $user_to_load = '';
  if ($i == 0) {
    $trimmed_name = strtolower(trim(str_replace(' ', '_', $xing_name)));
    $user_to_load = $trimmed_name;
  }
  else {
    $trimmed_name = $xing_name;
    $user_to_load = $trimmed_name . "_" . $i;
  }

  // Check if user exists by loading userbyname.
  if (is_object(user_load_by_name($user_to_load))) {
    $i++;
    return (xing_connect_unique_user_name($trimmed_name, $i));
  }
  else {
    return $user_to_load;
  }
}
