<?php

include_once __DIR__ . '/views_node_access_filter.access_records.inc';

use Drupal\Core\Database\Query\AlterableInterface;

/**
 * Implements hook_views_data_alter().
 */
function views_node_access_filter_views_data_alter(array &$data) {
  $data['node_field_data']['editable'] = [
    'title' => t('Editable'),
    'help' => t('Only keep nodes for which the current user has edit access.'),
    'filter' => [
      'id' => 'views_node_access_filter_editable',
      'field' => 'nid',
      'label' => t('Editable'),
    ],
  ];
}

/**
 * Implements hook_query_TAG_alter().
 *
 * @see node_query_node_access_alter()
 */
function views_node_access_filter_query_views_node_access_filter_editable_alter(AlterableInterface $query) {
  $query->addMetaData('op', 'update');
  $query->addTag('node_access');
}

/**
 * Implements hook_module_implements_alter().
 */
function views_node_access_filter_module_implements_alter(&$implementations, $hook) {
  // We need views_node_access_filter_query_views_node_access_filter_editable_alter()
  // to be called before node_query_node_access_alter().
  if ($hook == 'query_alter') {
    if (isset($implementations['views_node_access_filter'])) {
      $implementation = $implementations['views_node_access_filter'];
      unset($implementations['views_node_access_filter']);
      $implementations = ['views_node_access_filter' => $implementation] + $implementations;
    }
  }
}
