<?php

use Drupal\Core\Menu\MenuLinkTreeInterface;


/**
 * @file
 * Menu item limit enables the limitation of items per menu.
 */

/**
 * Implements hook_form_alter().
 */
function menu_item_limit_form_alter(&$form, \Drupal\Core\Form\FormStateInterface &$form_state, $form_id) {
  switch ($form_id) {
    case 'menu_edit_form':
      // Extend menu_edit_menu with the limit form.
      $form['menu_item_limit'] = menu_item_limit_config_menu($form, $form_state->getBuildInfo()['callback_object']);
      $form['#validate'][] = 'menu_item_limit_config_menu_validate';
      array_unshift($form['actions']['submit']['#submit'], 'menu_item_limit_config_menu_submit');
      break;

    case 'menu_link_content_menu_link_content_form':
      // Add a validation to form menu_edit_item.
      array_unshift($form['#validate'], 'menu_item_limit_menu_validate');
      break;

    default:
      break;
  }
}

/**
 * Add a form element to configure the item limitation of a menu.
 *
 * @param array $form
 *   The current menu edit form.
 * @param MenuForm
 *   The MenuForm item.
 *
 * @return array
 *   The prefilled form element.
 */
function menu_item_limit_config_menu($form, \Drupal\menu_ui\MenuForm $menu_form) {
  $menu_name = empty($menu_form->getEntity()->id()) ? 'new' : $menu_form->getEntity()->id();
  // Try to get the current limit of the menu.
  $config = \Drupal::service('config.factory')->getEditable('menu_item_limit.settings');
  $limit = empty($config->get($menu_name)) ? 0 : $config->get($menu_name);
  $config_item = array(
    '#type' => 'textfield',
    '#description' => t('Set the amount of items allowed in this menu. Set 0 to allow unlimited items.'),
    '#title' => t('Item Limitation'),
    '#default_value' => $limit,
  );
  return $config_item;
}

/**
 * Validate the user input for the item limitation.
 *
 * @param array $form
 *   The current menu edit form.
 * @param array $form_state
 *   The current state of the menu edit form.
 */
function menu_item_limit_config_menu_validate($form, \Drupal\Core\Form\FormStateInterface &$form_state) {
  // Check if the entered limit is set to a value of 0 or higher.
  $limit = $form_state->getValue('menu_item_limit');
  if ((!is_numeric($limit)) || ($limit < 0)) {
    form_set_error('menu_item_limit', t('The Item Limitation has to be set to 0 or higher.'));
  }
}

/**
 * Set the new value for the item limitation of the menu.
 *
 * @param array $form
 *   The current menu edit form.
 * @param array $form_state
 *   The current state of the menu edit form.
 */
function menu_item_limit_config_menu_submit($form, \Drupal\Core\Form\FormStateInterface &$form_state) {
  // Set the limit for the menu.
  \Drupal::logger('menu_item_limit')->notice('mymodule submit ') ;
  $limit = $form_state->getValue('menu_item_limit');
  $menu_name = $form_state->getValue('id');
  $config = \Drupal::service('config.factory')->getEditable('menu_item_limit.settings');
  $config->set($menu_name, $limit);
  $config->save();

}

/**
 * Validate an item within limit settings.
 *
 * @param array $form
 *   The current menu item edit form.
 * @param array $form_state
 *   The current state of the menu item edit form.
 *
 * @return bool
 *   TRUE when the item can be created and the limit hasn't been reached.
 */
function menu_item_limit_menu_validate($form, \Drupal\Core\Form\FormStateInterface &$form_state) {
  // Check if menu item already exists and validate then.
  if (!($form_state->getBuildInfo()['callback_object']->getEntity()->isNew())) {
    return TRUE;
  }
  $menu_name = $form_state->getBuildInfo()['callback_object']->getEntity()->menu_name->value;
  $config = \Drupal::service('config.factory')->getEditable('menu_item_limit.settings');
  $limit = empty($config->get($menu_name)) ? 0 : $config->get($menu_name);

  // If the limit is set to unlimited, validate the form.
  if ($limit == 0) {
    return TRUE;
  }
  // Get the current amount of items and check if the count is within limits.
  else {
    $item_count = _menu_item_limitation_get_item_count($menu_name);
    if ($item_count >= $limit) {
      $form_state->setErrorByName('menu_parent', t('The chosen menu already has the maximum number of items.'));
      return FALSE;
    }
  }
}

/**
 * This function takes a menu name and returns the number of menu items in it.
 *
 * @param string $menu_name
 *   The name of the menu.
 *
 * @return int
 *   The amount of items in the menu.
 */
function _menu_item_limitation_get_item_count($menu_name) {
  // @FIXME
// menu_tree_all_data() is gone in Drupal 8. To generate or work with menu trees, you'll need to
// use the menu.link_tree service.
// 
// 
// @see https://www.drupal.org/node/2226481
// @see https://api.drupal.org/api/drupal/core%21lib%21Drupal%21Core%21Menu%21MenuLinkTree.php/class/MenuLinkTree/8
// $menu = menu_tree_all_data($menu_name);
  $menu_manager = \Drupal::service('menu.link_tree');
  $parameters = $menu_manager->getCurrentRouteMenuTreeParameters($menu_name);

// Load the tree based on this set of parameters.
  $tree = $menu_manager->load($menu_name, $parameters);
  if (!empty($tree)) {
    return count($tree);
  }
  else {
    return 0;
  }
}
