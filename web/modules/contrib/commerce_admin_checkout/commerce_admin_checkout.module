<?php

/**
 * @file
 * Contains commerce_admin_checkout.module.
 */

use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_help().
 */
function commerce_admin_checkout_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the commerce_admin_checkout module.
    case 'help.page.commerce_admin_checkout':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Enables Drupal Commerce administrators to use the checkout form to create orders for customers') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_theme().
 */
function commerce_admin_checkout_theme() {
  return [
    'commerce_admin_checkout_order_items_form' => [
      'render element' => 'form',
    ],
    'commerce_admin_checkout_order_assign_form' => [
        'render element' => 'form',
    ],
    'commerce_admin_checkout_review' => [
      'variables' => ['order_id' => NULL],
    ]
  ];
}

function template_preprocess_commerce_admin_checkout_order_items_form(&$variables) {
  $variables['items'] = [];
  $allow_override = FALSE;
  $rows = [];
  foreach (\Drupal\Core\Render\Element::children($variables['form']['items']) as $order_item_id) {
    $item = $variables['form']['items'][$order_item_id];
    $row = [
      ['data' => $item['variation'], 'class' => ['variation']],
      ['data' => $item['quantity'], 'class' => ['quantity']],
    ];
    if (!empty($item['overridden_price'])) {
      $allow_override = TRUE;
      $row[] = ['data' => $item['overridden_price'], 'class' => ['overridden-price']];
    }
    $row[] = ['data' => $item['price'], 'class' => ['unit-price']];
    $row[] = ['data' => $item['actions'], 'class' => ['actions']];
    if ($order_item_id == 'new') {
      $rows[$order_item_id] = [
        'data' => $row,
        'data-drupal-selector' => 'order-item-row-' . $order_item_id,
        'class' => ['order-item-row-new'],
      ];
    }
    else {
      $rows[$order_item_id] = [
        'data' => $row,
        'data-drupal-selector' => 'order-item-row-' . $order_item_id,
        'class' => ['order-item-row'],
      ];
    }
    
  }
  $header = [
    ['data' => t('Product Variation'), 'class' => ['variation']],
    ['data' => t('Quantity'), 'class' => ['quantity']],
  ];
  if ($allow_override) {
    $header[] = ['data' => t('Override Price'), 'class' => ['overridden-price']];
  }
  $header[] = ['data' => t('Unit Price'), 'class' => ['unit-price']];
  $header[] = ['data' => t('Actions'), 'class' => ['actions']];
  $variables['items'] = [
    '#theme' => 'table',
    '#rows' => $rows,
    '#header' => $header,
  ];
}
