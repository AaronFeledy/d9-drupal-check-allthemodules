<?php

/**
 * @file
 * This module enhance the way Drupal demonstrates block regions.
 *
 * It makes it possible to see the regions in pages others than page.tpl.php.
 * For example, page--front.tpl.php, etc. if they exist in the theme's folder.
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\Core\Url;
use Drupal\Component\Utility\Xss;
use Drupal\regions_demo\Form\RegionsDemoForm;

/**
 * Implements hook_theme_suggestions_alter().
 */
function regions_demo_theme_suggestions_alter(array &$suggestions, array $variables, $hook) {
  if ($hook == 'page') {
    $current_path = \Drupal::service('path.current')->getPath();
    if (strpos($current_path, 'admin/structure/block/demo/') !== FALSE) {
      $page_template = Xss::filter(\Drupal::request()->query->get('page_template', ''));
      if ($page_template) {
        $suggestions = [$page_template];
      }
    }
  }
}

/**
 * Implements hook_help().
 */
function regions_demo_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    case 'help.page.regions_demo':
      $help = t("This module will show a fieldset with the label AVDANCED REGION DEMONSTRATION on the <a href='@block_admin_display'>Block layout</a> administrative page that will let you view the demonstration of the block regions on custom page template files.", ['@block_admin_display' => base_path() . Url::fromRoute('block.admin_display')->getInternalPath()]);
      return $help;
  }

  if ($route_name == 'block.admin_display' || $route_name == 'block.admin_display_theme') {
    $demo_theme = $route_match->getParameter('theme') ?: \Drupal::config('system.theme')->get('default');
    $files = RegionsDemoForm::getPageTemplates($demo_theme);

    if (count($files) > 1) {
      $form = \Drupal::formBuilder()->getForm('\Drupal\regions_demo\Form\RegionsDemoForm', $demo_theme);
      return $form;
    }

    return NULL;
  }
}
